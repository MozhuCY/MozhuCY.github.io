<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-RingZer0 Authenticator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/RingZer0 Authenticator/" class="article-date">
  <time datetime="2019-07-28T17:11:01.780Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/RingZer0 Authenticator/">RingZer0 Authenticator</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p>OD跟了一波,只发现username必为RingZer0,随后IDA分析主函数,发现关键函数sub_4014A0,此时程序将username和password传入.</p>
</li>
<li><p>函数得到返回值为1即可,函数里先判定username,随后判定password是否为纯数字.</p>
</li>
<li><p>在函数尾,username和password分别传入两个函数,返回两个数组,然后对比其值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_4014A0</span><span class="params">(_BYTE *name, _BYTE *pass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> v2; <span class="comment">// zf@1</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v3; <span class="comment">// edi@1</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v4; <span class="comment">// ecx@1</span></span><br><span class="line">  _BYTE *v5; <span class="comment">// esi@1</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v6; <span class="comment">// ecx@5</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// edi@5</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// eax@8</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// esi@12</span></span><br><span class="line">  <span class="keyword">char</span> *v10; <span class="comment">// eax@12</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="string">"RingZer0"</span>;</span><br><span class="line">  v4 = <span class="number">9</span>;</span><br><span class="line">  v5 = name;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = *v5++ == *v3++;</span><br><span class="line">    --v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v2 );</span><br><span class="line">  <span class="keyword">if</span> ( !v2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">-1</span>;</span><br><span class="line">  v7 = pass;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !v6 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = *v7++ == <span class="number">0</span>;</span><br><span class="line">    --v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !v2 );</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v6 == <span class="number">-17</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( (pass[i] - <span class="number">48</span>) &lt;= <span class="number">9u</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ++i == <span class="number">15</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v9 = sub_401334(name);</span><br><span class="line">        v10 = sub_401450(pass);</span><br><span class="line">        <span class="keyword">if</span> ( *v10 == v9[<span class="number">1</span>] &amp;&amp; v10[<span class="number">1</span>] == v9[<span class="number">5</span>] &amp;&amp; v10[<span class="number">2</span>] == v9[<span class="number">8</span>] &amp;&amp; v10[<span class="number">3</span>] == v9[<span class="number">14</span>] )</span><br><span class="line">          <span class="keyword">return</span> v10[<span class="number">4</span>] == v9[<span class="number">17</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>对于name的操作过于繁琐,这里采用dump内存来获得数组,对于pass加密部分,因为是15长度的密码3字节为一组生成一个密匙位,这里选择爆破.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">152</span>,<span class="number">151</span>,<span class="number">120</span>,<span class="number">15</span>,<span class="number">21</span>]</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">for</span> i1 <span class="keyword">in</span> range(<span class="number">0x30</span>,<span class="number">0x3A</span>):</span><br><span class="line">        <span class="keyword">for</span> i2 <span class="keyword">in</span> range(<span class="number">0x30</span>, <span class="number">0x3A</span>):</span><br><span class="line">            <span class="keyword">for</span> i3 <span class="keyword">in</span> range(<span class="number">0x30</span>, <span class="number">0x3A</span>):</span><br><span class="line">                <span class="keyword">if</span> a[i] == <span class="number">96</span> - i2 + <span class="number">-70</span> * (i1<span class="number">-48</span>) + <span class="number">13</span>*(i3<span class="number">-48</span>):</span><br><span class="line">                    flag += chr(i1)+chr(i2)+chr(i3)</span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>username:RingZer0<br><br>password:008018066123249<br><br><img src="http://img.blog.csdn.net/20180301091834540?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTW96aHVDWQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="1"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/RingZer0 Authenticator/" data-id="cjyn80f7m000hxkthyk702nu0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Reversing.kr--replace" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/Reversing.kr--replace/" class="article-date">
  <time datetime="2019-07-28T17:11:01.775Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/Reversing.kr--replace/">初试程序自修改</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>第一次遇到程序自修改的题目.</li>
<li>程序主页面是一个窗口,输入后点确定,程序会崩溃,拖入OD查看逻辑,首先是一个跳转,到达程序下部,查看汇编后,发现程序有好多次类似于mov [eax],0x??????的操作.</li>
<li>调试后发现,eax对应的值就是程序的代码段,eax的值,是由输入和imagebase决定,程序的eax被放入的初值为0x601605CB,所以当输入较小时,程序在运行过程中,会将0x90,也就是nop修改自身代码,这时,程序会因为非法修改内存而报错.</li>
<li>这时考虑溢出eax来修改目的代码,在下跳语句的后一句,有一句跳转,绕过了”correct!”,而且机器码长度为2字节,观察下部代码,发现<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> 0x????</span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">eax</span></span><br><span class="line"><span class="keyword">call</span> 0x????</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>的操作,观察这个call 0x????可以看到,这就是0x90 nop程序的过程.故可以计算0x100401071-0x601605CB = 2687109798.</p>
<ul>
<li>窗口输入 2687109798 成功破解</li>
</ul>
<p><img src="/image/replace.jpg" alt></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/Reversing.kr--replace/" data-id="cjyn80f7l000fxkthpebt8uir" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Reversing.kr--position&amp;hateintel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/Reversing.kr--position&hateintel/" class="article-date">
  <time datetime="2019-07-28T17:11:01.770Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/Reversing.kr--position&hateintel/">Position&amp;hateintel&amp;Wrong byte!</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="爆破了一天题目"><a href="#爆破了一天题目" class="headerlink" title="爆破了一天题目."></a>爆破了一天题目.</h2><ul>
<li>Position</li>
</ul>
<p>分析算法,直接爆破.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">四个循环,一个校验.</span><br></pre></td></tr></table></figure>

<ul>
<li>hateintel</li>
</ul>
<p>分析算法,直接爆破.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">l=[<span class="number">0x44</span>, <span class="number">0xF6</span>, <span class="number">0xF5</span>, <span class="number">0x57</span>, <span class="number">0xF5</span>, <span class="number">0xC6</span>, <span class="number">0x96</span>, <span class="number">0xB6</span>, <span class="number">0x56</span>, <span class="number">0xF5</span>,</span><br><span class="line"><span class="number">0x14</span>, <span class="number">0x25</span>, <span class="number">0xD4</span>, <span class="number">0xF5</span>, <span class="number">0x96</span>, <span class="number">0xE6</span>, <span class="number">0x37</span>, <span class="number">0x47</span>, <span class="number">0x27</span>, <span class="number">0x57</span>,</span><br><span class="line"><span class="number">0x36</span>, <span class="number">0x47</span>, <span class="number">0x96</span>, <span class="number">0x03</span>, <span class="number">0xE6</span>, <span class="number">0xF3</span>, <span class="number">0xA3</span>, <span class="number">0x92</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(a)</span>:</span></span><br><span class="line">    a*=<span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span>(a&amp;<span class="number">0x100</span>):</span><br><span class="line">        a|=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> range(len(l)):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        m = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            m = f(m)</span><br><span class="line">        <span class="keyword">if</span> l[k] == m &amp; <span class="number">0xff</span>:</span><br><span class="line">            flag+=chr(i)</span><br><span class="line">            <span class="keyword">print</span> k</span><br><span class="line"><span class="keyword">print</span> flag</span><br><span class="line"><span class="keyword">print</span> len(flag),len(l)</span><br></pre></td></tr></table></figure>

<ul>
<li>Wrong byte!</li>
</ul>
<p>所谓wrong,就是其中运算的值错误,所以改正即可,不过首先应该将错误的运算^0x13改正,然后爆破异或.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/Reversing.kr--position&hateintel/" data-id="cjyn80f7i000bxkthzl5ko4gl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-redhat" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/redhat/" class="article-date">
  <time datetime="2019-07-28T17:11:01.766Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/redhat/">redhat-re1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="主要逻辑"><a href="#主要逻辑" class="headerlink" title="主要逻辑"></a>主要逻辑</h1><ul>
<li>输入一个长度为41的flag,并用221填充到48位.</li>
<li>分成6组每组8字节的块,传入encode函数</li>
<li>异或验证<h1 id="encode函数"><a href="#encode函数" class="headerlink" title="encode函数"></a>encode函数</h1></li>
<li>生成一个伪随机数key,取8bit,然后base16编码存起来,最终长度为64</li>
<li>将每一个块base16编码为一串长度为16的字符串</li>
<li>进入第二层encode(块)函数</li>
<li>base16decode后,再次异或加密<h1 id="第二层encode函数"><a href="#第二层encode函数" class="headerlink" title="第二层encode函数"></a>第二层encode函数</h1></li>
<li>首先传入一个base后的16字节,传入key,会输出一个enc_base16的字符串</li>
<li>首先,函数将每个16字节的块,再次分块,使其成为4组4字节的块</li>
<li>然后srand_key传入一个函数,函数会将其扩充为96长度的一个字符串</li>
<li>将四字节的块和一个12长度的key传入函数,加密后传出函数并返回给四字节的块</li>
<li>base16解密</li>
</ul>
<h1 id="IDEA算法"><a href="#IDEA算法" class="headerlink" title="IDEA算法"></a>IDEA算法</h1><ul>
<li>比赛后发现是IDEA算法,那么结合着算法来逆这个</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/redhat/" data-id="cjyn80f85001hxkthde441de5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-RE" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/RE/" class="article-date">
  <time datetime="2019-07-28T17:11:01.762Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/RE/">2018国赛逆向</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="分析主要逻辑"><a href="#分析主要逻辑" class="headerlink" title="分析主要逻辑"></a>分析主要逻辑</h1><ul>
<li>读入字符串,校验前六位是否为CISCN{</li>
<li>以”_”为分界,分割字符串.</li>
<li>经历三个验证函数,分别验证各个分割出的字符串</li>
</ul>
<h1 id="验证函数"><a href="#验证函数" class="headerlink" title="验证函数"></a>验证函数</h1><ul>
<li>首先给v11赋值,然后异或,经正向验证发现,这些为MD5的四个初始常量.</li>
<li>经分析,这几个函数都是以MD5起手的函数</li>
<li>可知每一次的md5生成时,非数字部分会被加密一下</li>
<li>可以很容易的逆回,第二个函数还多了一个异或加密的操作,还原后异或即可</li>
<li>前两个函数反求的MD5可以查出来</li>
<li>最后一个函数还原出的MD5查不出来,爆破很久无果</li>
</ul>
<h1 id="写文件函数"><a href="#写文件函数" class="headerlink" title="写文件函数"></a>写文件函数</h1><ul>
<li>发现写出文件时,只用到了md5中的两位,而且也只是简单的异或运算</li>
<li>强制绕过验证后,怀疑文件是.jpg文件,考虑用FFD8FF反带出加密时的密钥部分</li>
<li>得到第三段flag,拼接即可</li>
</ul>
<h1 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CISCN&#123;t0ff_sect_tRndo%EchoPthcA&#125;</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">imd5</span><span class="params">(a)</span>:</span></span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(a)):</span><br><span class="line">        <span class="keyword">if</span> a[i] &gt;= <span class="string">'9'</span>:</span><br><span class="line">            result += chr(ord(a[i]) - i%<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result += a[i]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xormd5</span><span class="params">(s)</span>:</span></span><br><span class="line">    b = [<span class="number">0x3B</span>, <span class="number">0x1B</span>, <span class="number">0xE0</span>, <span class="number">0x8D</span>, <span class="number">0x3C</span>, <span class="number">0x8D</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x0A</span>, <span class="number">0x90</span>, <span class="number">0x46</span>, <span class="number">0xA0</span>, <span class="number">0x8C</span>, <span class="number">0xB5</span>, <span class="number">0x1F</span>, <span class="number">0x13</span>]</span><br><span class="line">    a = []</span><br><span class="line">    s = imd5(s)</span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">32</span>,<span class="number">2</span>):</span><br><span class="line">        a.append(int(s[i],<span class="number">16</span>)&lt;&lt;<span class="number">4</span>|int(s[i+<span class="number">1</span>],<span class="number">16</span>)&amp;<span class="number">0xf</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        a[i] ^= b[i]</span><br><span class="line">        result += chr(a[i])</span><br><span class="line">    <span class="keyword">return</span> base64.b16encode(result)</span><br><span class="line"></span><br><span class="line">s = <span class="string">"62146JKKNLA645HKG4IJ40GG58I9977B"</span></span><br><span class="line"><span class="keyword">print</span> imd5(s)</span><br><span class="line"><span class="keyword">print</span> xormd5(s)</span><br><span class="line"><span class="keyword">print</span> xormd5(<span class="string">"7F13G2180J9G84I2L88L73D8HK05KN94"</span>)</span><br><span class="line"><span class="keyword">print</span> hashlib.md5(<span class="string">"tRndo%EchoPthcA"</span>).hexdigest()</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/RE/" data-id="cjyn80f7j000cxkthyue2ybqh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-radare2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/radare2/" class="article-date">
  <time datetime="2019-07-28T17:11:01.757Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/二进制/">二进制</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/radare2/">CTF二进制总结0x02</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ELF文件的动态调试，IDA远程动态调试GG，kali自带OD GG，edb-debug鸡肋的功能，来一发radare2好了。上午刚被gdb搞得头大，现在来挑战一下更难的r2。<br><br>首先，radare是一款类似于IDA的工具，他也有可视化图形界面，但是却是基于命令行之上的。先来一发Hello World调试一下。<br><br>gcc hello.c -o hello后，打开终端<br></p>
<blockquote>
<p>r2 ./hello<br><br>[0x00000530]&gt;</p>
</blockquote>
<p>变成了这个样子，这时输入ie，你会得到</p>
<blockquote>
<p>[Entrypoints]<br>vaddr=0x00000530 paddr=0x00000530 baddr=0x00000000 laddr=0x00000000 haddr=0x00000018 type=program<br><br><br>1 entrypoints</p>
</blockquote>
<p>这里的ie，即info entrypoints，在r2中，i?指令是很常用的，具体如下：<br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[0x00000000]&gt; i?</span><br><span class="line">|Usage: i Get info from opened file (see rabin2&apos;s manpage)</span><br><span class="line">| Output mode:       </span><br><span class="line">| &apos;*&apos;                Output in radare commands</span><br><span class="line">| &apos;j&apos;                Output in json</span><br><span class="line">| &apos;q&apos;                Simple quiet output</span><br><span class="line">| Actions:           </span><br><span class="line">| i|ij               Show info of current file (in JSON)</span><br><span class="line">| iA                 List archs</span><br><span class="line">| ia                 Show all info (imports, exports, sections..)</span><br><span class="line">| ib                 Reload the current buffer for setting of the bin (use once only)</span><br><span class="line">| ic                 List classes, methods and fields</span><br><span class="line">| iC                 Show signature info (entitlements, ...)</span><br><span class="line">| id[?]              Debug information (source lines)</span><br><span class="line">| iD lang sym        demangle symbolname for given language</span><br><span class="line">| ie                 Entrypoint</span><br><span class="line">| iE                 Exports (global symbols)</span><br><span class="line">| ih                 Headers (alias for iH)</span><br><span class="line">| iHH                Verbose Headers in raw text</span><br><span class="line">| ii                 Imports</span><br><span class="line">| iI                 Binary info</span><br><span class="line">| ik [query]         Key-value database from RBinObject</span><br><span class="line">| il                 Libraries</span><br><span class="line">| iL [plugin]        List all RBin plugins loaded or plugin details</span><br><span class="line">| im                 Show info about predefined memory allocation</span><br><span class="line">| iM                 Show main address</span><br><span class="line">| io [file]          Load info from file (or last opened) use bin.baddr</span><br><span class="line">| ir                 Relocs</span><br><span class="line">| iR                 Resources</span><br><span class="line">| is                 Symbols</span><br><span class="line">| iS [entropy,sha1]  Sections (choose which hash algorithm to use)</span><br><span class="line">| iV                 Display file version info</span><br><span class="line">| iz|izj             Strings in data sections (in JSON/Base64)</span><br><span class="line">| izz                Search for Strings in the whole binary</span><br><span class="line">| iZ                 Guess size of binary program</span><br></pre></td></tr></table></figure>

<p>r2不会自动分析文件，刚开始用r2时…疯狂输入pdf，但是并没有什么效果啊，百度了一下才发现，需要analyse。这时可以输入aa或者aaa，其中aaa适合分析比较小的文件。这里选择了aaa。</p>
<blockquote>
<p>[0x00000530]&gt; aaa<br>[x] Analyze all flags starting with sym. and entry0 (aa)<br>[x] Analyze len bytes of instructions for references (aar)<br>[x] Analyze function calls (aac)<br>[ ] [*] Use -AA or aaaa to perform additional experimental analysis.<br>[x] Constructing a function name for fcn.* and sym.func.* functions (aan))</p>
</blockquote>
<p>在分析中，还可以用到s 0x00xxxxxx 用来跳到目标地址，还可以用px wx来进行修改汇编指令，还有汇编语言$ rasm2 -a x86 -b 64 “jmp 0x00xxx”转机器码。eval cfg.write=true 或 r2 -w hello来使文件可写，px 20 wx等操作来写入修改后的字节码。有时间做一道题目试试看吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/radare2/" data-id="cjyn80f84001fxkthxtjll2mx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-qctf-mips" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/qctf-mips/" class="article-date">
  <time datetime="2019-07-28T17:11:01.752Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/二进制/">二进制</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/qctf-mips/">qctf-mips</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><ul>
<li>分析代码,首先是第一个函数(简单异或,操作以后和一个长度为5的字符串作比较</li>
<li>比较通过后,进入下一个函数,再次处理后27字符,后发现函数根据i&amp;1的返回值分开了执行顺序,即奇偶分开加密</li>
<li>两端代码极其相似(一开始我弄没做出来,看了好久才发现= =)</li>
<li>实际上这两个操作是一个可逆的高低位互换(高二低六)</li>
<li>放出<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ida.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> a[<span class="number">32</span>] = &#123;<span class="number">81</span>,<span class="number">124</span>,<span class="number">106</span>,<span class="number">123</span>,<span class="number">103</span>,<span class="number">82</span>, <span class="number">253</span>,  <span class="number">22</span>, <span class="number">164</span>, <span class="number">137</span>, <span class="number">189</span>, <span class="number">146</span>, <span class="number">128</span>,  <span class="number">19</span>,  <span class="number">65</span>, </span><br><span class="line">   <span class="number">84</span>, <span class="number">160</span>, <span class="number">141</span>,  <span class="number">69</span>,  <span class="number">24</span>, <span class="number">129</span>, <span class="number">222</span>, <span class="number">252</span>, <span class="number">149</span>, <span class="number">240</span>, </span><br><span class="line">   <span class="number">22</span>, <span class="number">121</span>,  <span class="number">26</span>,  <span class="number">21</span>,  <span class="number">91</span>, <span class="number">117</span>,  <span class="number">31</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i,j,x,y;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">5</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>((i&amp;<span class="number">1</span>)!=<span class="number">0</span>)&#123;</span><br><span class="line">            a[i] = ((a[i]&lt;&lt;<span class="number">2</span>)&amp;<span class="number">0xff</span>)|((a[i]&gt;&gt;<span class="number">6</span>)&amp;<span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            a[i] = ((a[i]&gt;&gt;<span class="number">2</span>)&amp;<span class="number">0xff</span>)|((a[i]&lt;&lt;<span class="number">6</span>)&amp;<span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">        a[i]^=(<span class="number">32</span>-i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%c"</span>,a[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="mips总结"><a href="#mips总结" class="headerlink" title="mips总结"></a>mips总结</h2><ul>
<li>一般的mips最好还是对照着汇编耐心分析(这种需要硬怼汇编的题一定要有耐心啊,无论是这种还是vm,主要是分析稍微繁琐,但是思路都不会没有的</li>
<li>指令中类似于$v0, 0($v0)的,括号中为基址,外面的数字为偏移</li>
<li>lw &lt;=相反=&gt; sw</li>
<li>其余还要记住一些算法的特征常量</li>
<li>耐心怼还是最重要的</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/qctf-mips/" data-id="cjyn80f83001dxkth05s6k811" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-python_pyc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/python_pyc/" class="article-date">
  <time datetime="2019-07-28T17:11:01.742Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/python_pyc/">Python的一些底层原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p>踩了太多次坑了,从前几个月的suctf开始,pyc文件逆向越来越多的出现在各种比赛中,正好借这个机会好好熟悉一下Python的底层</p>
<h1 id="Python的一些底层实现"><a href="#Python的一些底层实现" class="headerlink" title="Python的一些底层实现"></a>Python的一些底层实现</h1></li>
<li><p>python常常被当做是一门解释型语言,但是实际上,Python的底层和java等语言非常相近,都是一门基于虚拟机的语言,当用户在命令行输入python test.py时,实际上进行的是一个编译的过程</p>
</li>
<li><p>.pyc也就是Python编译好的文件,在一般情况下,编译出的字节码是存在于内存中的,当Python运行结束后,就会释放掉内存,或者写入.pyc文件,被我们看到,如果这个时候再次运行.py文件,python解释器会先在目录下中查找对应的.pyc文件,如果找到,则会直接运行,否则将会重新解释编译</p>
</li>
<li><p>.pyc文件生成的目的又是什么呢,我们可以将其理解成类似于linux中的.so库一样,是为了加快程序的运行速度,在一些调用模块较多的程序中,这样明显会提高程序的运行速度和占用内存空间.</p>
<h1 id="pyc文件解析"><a href="#pyc文件解析" class="headerlink" title="pyc文件解析"></a>pyc文件解析</h1></li>
<li><p>当我们在命令行输入 python -m filename.py的时候,便会得到一个对应的filename.pyc(-m 指令是作为模块运行,这时会生成pyc文件)</p>
</li>
<li><p>这时我们就可以配合着010editor解析该pyc文件了.</p>
</li>
<li><p>首先解析一个最简单的程序</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">"helloworld!"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(s)):</span><br><span class="line">    <span class="keyword">print</span> chr(ord(s[i]) + i)</span><br></pre></td></tr></table></figure>

<ul>
<li>python -m 1.py以后,我得到了一个1.pyc文件,内容如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">00000000: 03 f3 0d 0a 8d 0e e3 5b 63 00 00 00 00 00 00 00  .......[c.......</span><br><span class="line">00000010: 00 05 00 00 00 40 00 00 00 73 40 00 00 00 64 00  .....@...s@...d.</span><br><span class="line">00000020: 00 5a 00 00 78 33 00 65 01 00 65 02 00 65 00 00  .Z..x3.e..e..e..</span><br><span class="line">00000030: 83 01 00 83 01 00 44 5d 1f 00 5a 03 00 65 04 00  ......D]..Z..e..</span><br><span class="line">00000040: 65 05 00 65 00 00 65 03 00 19 83 01 00 65 03 00  e..e..e......e..</span><br><span class="line">00000050: 17 83 01 00 47 48 71 19 00 57 64 01 00 53 28 02  ....GHq..Wd..S(.</span><br><span class="line">00000060: 00 00 00 73 0b 00 00 00 68 65 6c 6c 6f 77 6f 72  ...s....hellowor</span><br><span class="line">00000070: 6c 64 21 4e 28 06 00 00 00 74 01 00 00 00 73 74  ld!N(....t....st</span><br><span class="line">00000080: 05 00 00 00 72 61 6e 67 65 74 03 00 00 00 6c 65  ....ranget....le</span><br><span class="line">00000090: 6e 74 01 00 00 00 69 74 03 00 00 00 63 68 72 74  nt....it....chrt</span><br><span class="line">000000a0: 03 00 00 00 6f 72 64 28 00 00 00 00 28 00 00 00  ....ord(....(...</span><br><span class="line">000000b0: 00 28 00 00 00 00 73 04 00 00 00 31 2e 70 79 74  .(....s....1.pyt</span><br><span class="line">000000c0: 08 00 00 00 3c 6d 6f 64 75 6c 65 3e 01 00 00 00  ....&lt;module&gt;....</span><br><span class="line">000000d0: 73 04 00 00 00 06 01 19 01                       s........</span><br></pre></td></tr></table></figure>

<ul>
<li>pyc的整体就是前八个相对固定的字节再加上一个PyCodeObject</li>
<li>前八个字节是相对固定的,前四个字节为固定的03 f3 0d 0a,后面的四字节为时间戳,这里采用小端续排序,即0x5be30e8d</li>
<li>接下来的一个字节就是0x63,也就是99,PyCodeObject的标识符’c’</li>
<li>接下来的16个字节就分别为小端序的co_argument,co_nlocals,co_stacksize和co_flags,分别为参数个数,变量个数,所需栈空间,一些特殊信息标志flags(如下所示)</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_OPTIMIZED    0x0001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_NEWLOCALS    0x0002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_VARARGS  0x0004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_VARKEYWORDS  0x0008</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_NESTED       0x0010</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_GENERATOR    0x0020</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_NOFREE       0x0040</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_FUTURE_DIVISION       0x2000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_FUTURE_ABSOLUTE_IMPORT 0x4000 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_FUTURE_WITH_STATEMENT  0x8000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_FUTURE_PRINT_FUNCTION  0x10000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CO_FUTURE_UNICODE_LITERALS 0x20000</span></span><br></pre></td></tr></table></figure>

<ul>
<li>再往后就是一个co_code,是以一个string形式保存的opcode字节流,0x73即’s’后面四个字节就是小端序的0x40</li>
<li>加上便宜后的0x40个字节码以后,来到数据区域,下面是一个0x28即为’(‘,也就是一个元组类型,长度为后四字节小端序的0x2</li>
<li>后续为一个0x73,即’S’,长度为0xb的helloworld!字符串,随后是一个’N’,即None,</li>
<li>随后又是一个元组’(‘,长度为6,后面跟着的就是元组中的6个元素,第一个为长度为1的s,第二个为长度为5的range,以此类推</li>
<li>然后就是三个空元组,3个字符串,下面是python定义了的一些数据类型标识</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_NULL               <span class="meta-string">'0'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_NONE               <span class="meta-string">'N'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_FALSE              <span class="meta-string">'F'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_TRUE               <span class="meta-string">'T'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_STOPITER           <span class="meta-string">'S'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_ELLIPSIS           <span class="meta-string">'.'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_INT                <span class="meta-string">'i'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_INT64              <span class="meta-string">'I'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_FLOAT              <span class="meta-string">'f'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_BINARY_FLOAT       <span class="meta-string">'g'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_COMPLEX            <span class="meta-string">'x'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_BINARY_COMPLEX     <span class="meta-string">'y'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_LONG               <span class="meta-string">'l'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_STRING             <span class="meta-string">'s'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_INTERNED           <span class="meta-string">'t'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_STRINGREF          <span class="meta-string">'R'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_TUPLE              <span class="meta-string">'('</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_LIST               <span class="meta-string">'['</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_DICT               <span class="meta-string">'&#123;'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_CODE               <span class="meta-string">'c'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_UNICODE            <span class="meta-string">'u'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_UNKNOWN            <span class="meta-string">'?'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_SET                <span class="meta-string">'&lt;'</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TYPE_FROZENSET          <span class="meta-string">'&gt;'</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>接下来用一个pyc解析脚本解析一下pyc文件,得到如下结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">magic: 168686339</span><br><span class="line">mtime: 1541607053</span><br><span class="line">code obj: code(</span><br><span class="line">	argcount = 0</span><br><span class="line">	nlocals = 0</span><br><span class="line">	stacksize = 5</span><br><span class="line">	flags = 64</span><br><span class="line">	code = 0x6400005a0000783300650100650200650000830100830100445d1f005a0300650400650500650000650300198301006503001783010047487119005764010053</span><br><span class="line">	consts = (&apos;helloworld!&apos;, None)</span><br><span class="line">	names = (&apos;s&apos;, &apos;range&apos;, &apos;len&apos;, &apos;i&apos;, &apos;chr&apos;, &apos;ord&apos;)</span><br><span class="line">	varnames = ()</span><br><span class="line">	freevars = ()</span><br><span class="line">	cellvars = ()</span><br><span class="line">	filename = 1.py</span><br><span class="line">	name = &lt;module&gt;</span><br><span class="line">	firstlineno = 1</span><br><span class="line">	lnotab =</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看出来哦,magic加上时间戳,之后是一个大的PyCodeObject,前四个四字节为一些标识,然后是opcode,之后是程序一个元组里面有两个常量,后面是另一个元组,内容为调用的一些函数,变量名等,在文件尾部是三个元组,同时还有文件名以及调用方式</li>
<li>下面我们来解析一下code字节码,这里利用python自带的dis模块来进行转换.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">      <span class="number">0</span> LOAD_CONST          <span class="number">0</span> (<span class="number">0</span>) <span class="comment"># 加载consts常量的第0个,也就是helloworld!</span></span><br><span class="line">      <span class="number">3</span> STORE_NAME          <span class="number">0</span> (<span class="number">0</span>) <span class="comment"># 将其存放在栈内</span></span><br><span class="line">      <span class="number">6</span> SETUP_LOOP         <span class="number">51</span> (to <span class="number">60</span>) <span class="comment"># 设置循环</span></span><br><span class="line">      <span class="number">9</span> LOAD_NAME           <span class="number">1</span> (<span class="number">1</span>) <span class="comment"># 加载name中的range到栈内</span></span><br><span class="line">     <span class="number">12</span> LOAD_NAME           <span class="number">2</span> (<span class="number">2</span>) <span class="comment"># 加载name中的len到栈内</span></span><br><span class="line">     <span class="number">15</span> LOAD_NAME           <span class="number">0</span> (<span class="number">0</span>) <span class="comment"># 加载name中的s,实际上上面三个调用就是range(len(s))到栈内</span></span><br><span class="line">     <span class="number">18</span> CALL_FUNCTION       <span class="number">1</span> <span class="comment">#调用len</span></span><br><span class="line">     <span class="number">21</span> CALL_FUNCTION       <span class="number">1</span> <span class="comment">#调用range</span></span><br><span class="line">     <span class="number">24</span> GET_ITER</span><br><span class="line">&gt;&gt;   <span class="number">25</span> FOR_ITER           <span class="number">31</span> (to <span class="number">59</span>)</span><br><span class="line">     <span class="number">28</span> STORE_NAME          <span class="number">3</span> (<span class="number">3</span>) <span class="comment"># i入栈</span></span><br><span class="line">     <span class="number">31</span> LOAD_NAME           <span class="number">4</span> (<span class="number">4</span>) <span class="comment"># 加载name中的chr</span></span><br><span class="line">     <span class="number">34</span> LOAD_NAME           <span class="number">5</span> (<span class="number">5</span>) <span class="comment"># 加载name中的ord</span></span><br><span class="line">     <span class="number">37</span> LOAD_NAME           <span class="number">0</span> (<span class="number">0</span>) <span class="comment"># 加载name中的s</span></span><br><span class="line">     <span class="number">40</span> LOAD_NAME           <span class="number">3</span> (<span class="number">3</span>) <span class="comment"># 加载name中的i</span></span><br><span class="line">     <span class="number">43</span> BINARY_SUBSCR</span><br><span class="line">     <span class="number">44</span> CALL_FUNCTION       <span class="number">1</span> <span class="comment">#调用ord</span></span><br><span class="line">     <span class="number">47</span> LOAD_NAME           <span class="number">3</span> (<span class="number">3</span>) <span class="comment"># 加载name中的i</span></span><br><span class="line">     <span class="number">50</span> BINARY_ADD                <span class="comment"># 加法</span></span><br><span class="line">     <span class="number">51</span> CALL_FUNCTION       <span class="number">1</span> <span class="comment">#调用chr</span></span><br><span class="line">     <span class="number">54</span> PRINT_ITEM                <span class="comment"># 打印字符加上回车</span></span><br><span class="line">     <span class="number">55</span> PRINT_NEWLINE</span><br><span class="line">     <span class="number">56</span> JUMP_ABSOLUTE      <span class="number">25</span></span><br><span class="line">&gt;&gt;   <span class="number">59</span> POP_BLOCK</span><br><span class="line">&gt;&gt;   <span class="number">60</span> LOAD_CONST          <span class="number">1</span> (<span class="number">1</span>) <span class="comment"># return NONE</span></span><br><span class="line">     <span class="number">63</span> RETURN_VALUE</span><br></pre></td></tr></table></figure>

<ul>
<li>当我将循环条件直接改成11以后,opcode变成了下面的样子</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>           <span class="number">0</span> LOAD_CONST               <span class="number">0</span> (<span class="string">'helloworld!'</span>)</span><br><span class="line">            <span class="number">3</span> STORE_NAME               <span class="number">0</span> (s)</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>           <span class="number">6</span> SETUP_LOOP              <span class="number">45</span> (to <span class="number">54</span>)</span><br><span class="line">            <span class="number">9</span> LOAD_NAME                <span class="number">1</span> (range)</span><br><span class="line">           <span class="number">12</span> LOAD_CONST               <span class="number">1</span> (<span class="number">11</span>)</span><br><span class="line">           <span class="number">15</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">           <span class="number">18</span> GET_ITER</span><br><span class="line">      &gt;&gt;   <span class="number">19</span> FOR_ITER                <span class="number">31</span> (to <span class="number">53</span>)</span><br><span class="line">           <span class="number">22</span> STORE_NAME               <span class="number">2</span> (i)</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>          <span class="number">25</span> LOAD_NAME                <span class="number">3</span> (chr)</span><br><span class="line">           <span class="number">28</span> LOAD_NAME                <span class="number">4</span> (ord)</span><br><span class="line">           <span class="number">31</span> LOAD_NAME                <span class="number">0</span> (s)</span><br><span class="line">           <span class="number">34</span> LOAD_NAME                <span class="number">2</span> (i)</span><br><span class="line">           <span class="number">37</span> BINARY_SUBSCR</span><br><span class="line">           <span class="comment"># 31到37即为返回s[i]</span></span><br><span class="line">           <span class="number">38</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">           <span class="comment"># 调用最近load的函数ord,然后销毁</span></span><br><span class="line">           <span class="number">41</span> LOAD_NAME                <span class="number">2</span> (i)</span><br><span class="line">           <span class="number">44</span> BINARY_ADD</span><br><span class="line">           <span class="number">45</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">           <span class="comment"># 调用最近的load的函数chr</span></span><br><span class="line">           <span class="number">48</span> PRINT_ITEM</span><br><span class="line">           <span class="number">49</span> PRINT_NEWLINE</span><br><span class="line">           <span class="number">50</span> JUMP_ABSOLUTE           <span class="number">19</span></span><br><span class="line">      &gt;&gt;   <span class="number">53</span> POP_BLOCK</span><br><span class="line">      &gt;&gt;   <span class="number">54</span> LOAD_CONST               <span class="number">2</span> (<span class="literal">None</span>)</span><br><span class="line">           <span class="number">57</span> RETURN_VALUE</span><br></pre></td></tr></table></figure>

<ul>
<li>这样结合着上面两个就能理解出了opcode运行的一些过程,不过load函数部分还不是很懂,所以还请师傅们多多指教</li>
<li>插一个丧病的小实验,我把print后面的参数改成了chr(ord(chr(ord(s[i]) + i))),然后opcode变成了下面的样子</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>           <span class="number">0</span> LOAD_CONST               <span class="number">0</span> (<span class="string">'helloworld!'</span>)</span><br><span class="line">            <span class="number">3</span> STORE_NAME               <span class="number">0</span> (s)</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>           <span class="number">6</span> SETUP_LOOP              <span class="number">57</span> (to <span class="number">66</span>)</span><br><span class="line">            <span class="number">9</span> LOAD_NAME                <span class="number">1</span> (range)</span><br><span class="line">           <span class="number">12</span> LOAD_CONST               <span class="number">1</span> (<span class="number">11</span>)</span><br><span class="line">           <span class="number">15</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">           <span class="number">18</span> GET_ITER</span><br><span class="line">      &gt;&gt;   <span class="number">19</span> FOR_ITER                <span class="number">43</span> (to <span class="number">65</span>)</span><br><span class="line">           <span class="number">22</span> STORE_NAME               <span class="number">2</span> (i)</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>          <span class="number">25</span> LOAD_NAME                <span class="number">3</span> (chr)</span><br><span class="line">           <span class="number">28</span> LOAD_NAME                <span class="number">4</span> (ord)</span><br><span class="line">           <span class="number">31</span> LOAD_NAME                <span class="number">3</span> (chr)</span><br><span class="line">           <span class="number">34</span> LOAD_NAME                <span class="number">4</span> (ord)</span><br><span class="line">           <span class="number">37</span> LOAD_NAME                <span class="number">0</span> (s)</span><br><span class="line">           <span class="number">40</span> LOAD_NAME                <span class="number">2</span> (i)</span><br><span class="line">           <span class="number">43</span> BINARY_SUBSCR</span><br><span class="line">           <span class="number">44</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">           <span class="number">47</span> LOAD_NAME                <span class="number">2</span> (i)</span><br><span class="line">           <span class="number">50</span> BINARY_ADD</span><br><span class="line">           <span class="number">51</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">           <span class="number">54</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">           <span class="number">57</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">           <span class="number">60</span> PRINT_ITEM</span><br><span class="line">           <span class="number">61</span> PRINT_NEWLINE</span><br><span class="line">           <span class="number">62</span> JUMP_ABSOLUTE           <span class="number">19</span></span><br><span class="line">      &gt;&gt;   <span class="number">65</span> POP_BLOCK</span><br><span class="line">      &gt;&gt;   <span class="number">66</span> LOAD_CONST               <span class="number">2</span> (<span class="literal">None</span>)</span><br><span class="line">           <span class="number">69</span> RETURN_VALUE</span><br></pre></td></tr></table></figure>

<ul>
<li>可以注意下,再循环的内部,的确和我理解的一样,他按照原py代码的顺序从外到内加载了chr,ord,chr,ord,并且一直都是CALL_FUNCTION            1,这种我看来是类似于调用后出栈再次调用栈顶函数的顺序操作…</li>
<li>然后这样导致了pyc文件中栈空间从5变成了7,正好是多出来的两个chr ord.</li>
</ul>
<h1 id="2018东华杯-easy-py"><a href="#2018东华杯-easy-py" class="headerlink" title="2018东华杯-easy_py"></a>2018东华杯-easy_py</h1><ul>
<li>该题是一个比较基础的pyc解析的题目,然后反编译失败了,只好手动解析</li>
<li>提取出opcode之后,opcode的头部中出现了一些奇怪的东西”LOAD_CONST      13091 (13091)”,居然load了偏移为13091的常量,但是之前有跳转指令,但是也就是这句话导致该pyc无法被转成py文件,这里直接清除掉前9个字节的花指令,修改掉’s’类型的opcode的长度0xb2为0xb2-9,这时反编译就能得到如下结果</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cmp = [</span><br><span class="line"> f]</span><br><span class="line">flag = raw_input()</span><br><span class="line">m = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flag:</span><br><span class="line">    i = ~ord(i) &amp; <span class="number">102</span> | ord(i) &amp; <span class="number">-103</span></span><br><span class="line">    <span class="keyword">if</span> i == cmp[m]:</span><br><span class="line">        m = -(-m + <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'wrong'</span></span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'right'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>化简m = -(-m + -1)为m += 1,i = <del>ord(i) &amp; ~(-103) | ord(i) &amp; -103,即为a = ~a&amp;</del>b | a&amp;b,即a ^= b ,a ~= a</li>
<li>最后化简为chr((~(s[i]^(-103)))&amp;0xff),写解密脚本得到flag{happy_xoR}</li>
<li>或者采用opcode来进行逆向,pyc文件解析后得到如下结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">magic: 168686339</span><br><span class="line">mtime: 1540275390</span><br><span class="line">code obj: code(</span><br><span class="line">	argcount = 0</span><br><span class="line">	nlocals = 0</span><br><span class="line">	stacksize = 15</span><br><span class="line">	flags = 64</span><br><span class="line">	code = 0x640000640100640200640300640400640500640200640600640600640700640800640900640a00640b00640c00670f005a00006501008300005a02006400005a0300785b00650200445d53005a04006505006504008301000f640d004065050065040083010064120040425a0400650400650000650300196b02007290006503000b640e00170b5a0300714900714900640f0047486506008300000171490057641000474864110053</span><br><span class="line">	consts = (0, 10, 7, 1, 29, 14, 22, 31, 57, 30, 9, 52, 27, 102, 4294967295, &apos;wrong&apos;, &apos;right&apos;, None, 4294967193)</span><br><span class="line">	names = (&apos;cmp&apos;, &apos;raw_input&apos;, &apos;flag&apos;, &apos;m&apos;, &apos;i&apos;, &apos;ord&apos;, &apos;exit&apos;)</span><br><span class="line">	varnames = ()</span><br><span class="line">	freevars = ()</span><br><span class="line">	cellvars = ()</span><br><span class="line">	filename = easy_py.py</span><br><span class="line">	name = &lt;module&gt;</span><br><span class="line">	firstlineno = 1</span><br><span class="line">	lnotab = 3</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>反编译code后得到下面的opcode</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">      <span class="number">0</span> LOAD_CONST          <span class="number">0</span> (<span class="number">0</span>)   <span class="comment"># 加载 0</span></span><br><span class="line">      <span class="number">3</span> LOAD_CONST          <span class="number">1</span> (<span class="number">1</span>)   <span class="comment"># 加载 10</span></span><br><span class="line">      <span class="number">6</span> LOAD_CONST          <span class="number">2</span> (<span class="number">2</span>)   <span class="comment"># 加载 7</span></span><br><span class="line">      <span class="number">9</span> LOAD_CONST          <span class="number">3</span> (<span class="number">3</span>)   <span class="comment"># 加载 1</span></span><br><span class="line">     <span class="number">12</span> LOAD_CONST          <span class="number">4</span> (<span class="number">4</span>)   <span class="comment"># 加载 29</span></span><br><span class="line">     <span class="number">15</span> LOAD_CONST          <span class="number">5</span> (<span class="number">5</span>)   <span class="comment"># 加载 14</span></span><br><span class="line">     <span class="number">18</span> LOAD_CONST          <span class="number">2</span> (<span class="number">2</span>)   <span class="comment"># 加载 7</span></span><br><span class="line">     <span class="number">21</span> LOAD_CONST          <span class="number">6</span> (<span class="number">6</span>)   <span class="comment"># 加载 22</span></span><br><span class="line">     <span class="number">24</span> LOAD_CONST          <span class="number">6</span> (<span class="number">6</span>)   <span class="comment"># 加载 22</span></span><br><span class="line">     <span class="number">27</span> LOAD_CONST          <span class="number">7</span> (<span class="number">7</span>)   <span class="comment"># 加载 31</span></span><br><span class="line">     <span class="number">30</span> LOAD_CONST          <span class="number">8</span> (<span class="number">8</span>)   <span class="comment"># 加载 57</span></span><br><span class="line">     <span class="number">33</span> LOAD_CONST          <span class="number">9</span> (<span class="number">9</span>)   <span class="comment"># 加载 30</span></span><br><span class="line">     <span class="number">36</span> LOAD_CONST         <span class="number">10</span> (<span class="number">10</span>)   <span class="comment"># 加载 9</span></span><br><span class="line">     <span class="number">39</span> LOAD_CONST         <span class="number">11</span> (<span class="number">11</span>)   <span class="comment"># 加载 52</span></span><br><span class="line">     <span class="number">42</span> LOAD_CONST         <span class="number">12</span> (<span class="number">12</span>)   <span class="comment"># 加载 27</span></span><br><span class="line">     <span class="number">45</span> BUILD_LIST         <span class="number">15</span>        <span class="comment"># 组成一个list</span></span><br><span class="line">     <span class="number">48</span> STORE_NAME          <span class="number">0</span> (<span class="number">0</span>)    <span class="comment"># 入栈</span></span><br><span class="line">     <span class="number">51</span> LOAD_NAME           <span class="number">1</span> (<span class="number">1</span>)    <span class="comment"># 加载raw_input</span></span><br><span class="line">     <span class="number">54</span> CALL_FUNCTION       <span class="number">0</span>        <span class="comment"># 调用</span></span><br><span class="line">     <span class="number">57</span> STORE_NAME          <span class="number">2</span> (<span class="number">2</span>)    <span class="comment"># 输入的字符串存储在[2]</span></span><br><span class="line">     <span class="number">60</span> LOAD_CONST          <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">     <span class="number">63</span> STORE_NAME          <span class="number">3</span> (<span class="number">3</span>)</span><br><span class="line">     <span class="number">66</span> SETUP_LOOP         <span class="number">91</span> (to <span class="number">160</span>)</span><br><span class="line">     <span class="number">69</span> LOAD_NAME           <span class="number">2</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">72</span> GET_ITER</span><br><span class="line">&gt;&gt;   <span class="number">73</span> FOR_ITER           <span class="number">83</span> (to <span class="number">159</span>)</span><br><span class="line">     <span class="number">76</span> STORE_NAME          <span class="number">4</span> (<span class="number">4</span>)</span><br><span class="line">     <span class="number">79</span> LOAD_NAME           <span class="number">5</span> (<span class="number">5</span>)   <span class="comment"># ord</span></span><br><span class="line">     <span class="number">82</span> LOAD_NAME           <span class="number">4</span> (<span class="number">4</span>)   <span class="comment"># i</span></span><br><span class="line">     <span class="number">85</span> CALL_FUNCTION       <span class="number">1</span></span><br><span class="line">     <span class="number">88</span> UNARY_INVERT                <span class="comment"># ~</span></span><br><span class="line">     <span class="number">89</span> LOAD_CONST         <span class="number">13</span> (<span class="number">13</span>)  <span class="comment"># 102</span></span><br><span class="line">     <span class="number">92</span> BINARY_AND                  <span class="comment"># 102 &amp; ~ord(i)</span></span><br><span class="line">     <span class="number">93</span> LOAD_NAME           <span class="number">5</span> (<span class="number">5</span>)   <span class="comment"># ord</span></span><br><span class="line">     <span class="number">96</span> LOAD_NAME           <span class="number">4</span> (<span class="number">4</span>)   <span class="comment"># i</span></span><br><span class="line">     <span class="number">99</span> CALL_FUNCTION       <span class="number">1</span>       <span class="comment"># ord(i)</span></span><br><span class="line">    <span class="number">102</span> LOAD_CONST         <span class="number">18</span> (<span class="number">18</span>)  <span class="comment"># 4294967193 即 -103</span></span><br><span class="line">    <span class="number">105</span> BINARY_AND                  <span class="comment"># ord(i) &amp; -103</span></span><br><span class="line">    <span class="number">106</span> BINARY_OR                   <span class="comment"># 102 &amp; ~ord(i) | ord(i) &amp; -103</span></span><br><span class="line">    <span class="number">107</span> STORE_NAME          <span class="number">4</span> (<span class="number">4</span>)   <span class="comment"># </span></span><br><span class="line">    <span class="number">110</span> LOAD_NAME           <span class="number">4</span> (<span class="number">4</span>)</span><br><span class="line">    <span class="number">113</span> LOAD_NAME           <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">    <span class="number">116</span> LOAD_NAME           <span class="number">3</span> (<span class="number">3</span>)</span><br><span class="line">    <span class="number">119</span> BINARY_SUBSCR</span><br><span class="line">    <span class="number">120</span> COMPARE_OP          <span class="number">2</span> (==) <span class="comment"># 是否相等</span></span><br><span class="line">    <span class="number">123</span> POP_JUMP_IF_FALSE   <span class="number">144</span></span><br><span class="line">    <span class="number">126</span> LOAD_NAME           <span class="number">3</span> (<span class="number">3</span>)</span><br><span class="line">    <span class="number">129</span> UNARY_NEGATIVE</span><br><span class="line">    <span class="number">130</span> LOAD_CONST         <span class="number">14</span> (<span class="number">14</span>)</span><br><span class="line">    <span class="number">133</span> BINARY_ADD</span><br><span class="line">    <span class="number">134</span> UNARY_NEGATIVE</span><br><span class="line">    <span class="number">135</span> STORE_NAME          <span class="number">3</span> (<span class="number">3</span>)</span><br><span class="line">    <span class="number">138</span> JUMP_ABSOLUTE      <span class="number">73</span></span><br><span class="line">    <span class="number">141</span> JUMP_ABSOLUTE      <span class="number">73</span></span><br><span class="line">&gt;&gt;  <span class="number">144</span> LOAD_CONST         <span class="number">15</span> (<span class="number">15</span>) <span class="comment"># wrong</span></span><br><span class="line">    <span class="number">147</span> PRINT_ITEM</span><br><span class="line">    <span class="number">148</span> PRINT_NEWLINE</span><br><span class="line">    <span class="number">149</span> LOAD_NAME           <span class="number">6</span> (<span class="number">6</span>)</span><br><span class="line">    <span class="number">152</span> CALL_FUNCTION       <span class="number">0</span>     <span class="comment"># exit</span></span><br><span class="line">    <span class="number">155</span> POP_TOP</span><br><span class="line">    <span class="number">156</span> JUMP_ABSOLUTE      <span class="number">73</span></span><br><span class="line">&gt;&gt;  <span class="number">159</span> POP_BLOCK</span><br><span class="line">&gt;&gt;  <span class="number">160</span> LOAD_CONST         <span class="number">16</span> (<span class="number">16</span>)<span class="comment"># right</span></span><br><span class="line">    <span class="number">163</span> PRINT_ITEM</span><br><span class="line">    <span class="number">164</span> PRINT_NEWLINE</span><br><span class="line">    <span class="number">165</span> LOAD_CONST         <span class="number">17</span> (<span class="number">17</span>) </span><br><span class="line">    <span class="number">168</span> RETURN_VALUE              <span class="comment"># return NONE</span></span><br></pre></td></tr></table></figure>

<ul>
<li>由此也可以整理出算法 102 &amp; ~ord(i) | ord(i) &amp; -103</li>
</ul>
<h1 id="多函数的pyc文件结构"><a href="#多函数的pyc文件结构" class="headerlink" title="多函数的pyc文件结构"></a>多函数的pyc文件结构</h1><ul>
<li>与单文件的相似,夜影师傅博客里说实际上是一个嵌套的结构,这里编译一个pyc看一下,这里我把chr()写入了一个名为ch的函数,再来看一下pyc文件的16进制变成了什么</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">00000000: 03f3 0d0a f9e7 e35b 6300 0000 0000 0000  .......[c.......</span><br><span class="line">00000010: 0007 0000 0040 0000 0073 4f00 0000 6400  .....@...sO...d.</span><br><span class="line">00000020: 005a 0000 6401 0084 0000 5a01 0078 3900  .Z..d.....Z..x9.</span><br><span class="line">00000030: 6502 0064 0200 8301 0044 5d2b 005a 0300  e..d.....D]+.Z..</span><br><span class="line">00000040: 6501 0065 0400 6501 0065 0400 6500 0065  e..e..e..e..e..e</span><br><span class="line">00000050: 0300 1983 0100 6503 0017 8301 0083 0100  ......e.........</span><br><span class="line">00000060: 8301 0047 4871 1c00 5764 0300 5328 0400  ...GHq..Wd..S(..</span><br><span class="line">00000070: 0000 730b 0000 0068 656c 6c6f 776f 726c  ..s....helloworl</span><br><span class="line">00000080: 6421 6301 0000 0001 0000 0002 0000 0043  d!c............C</span><br><span class="line">00000090: 0000 0073 0a00 0000 7400 007c 0000 8301  ...s....t..|....</span><br><span class="line">000000a0: 0053 2801 0000 004e 2801 0000 0074 0300  .S(....N(....t..</span><br><span class="line">000000b0: 0000 6368 7228 0100 0000 7401 0000 0061  ..chr(....t....a</span><br><span class="line">000000c0: 2800 0000 0028 0000 0000 7304 0000 0031  (....(....s....1</span><br><span class="line">000000d0: 2e70 7974 0200 0000 6368 0300 0000 7302  .pyt....ch....s.</span><br><span class="line">000000e0: 0000 0000 0169 0b00 0000 4e28 0500 0000  .....i....N(....</span><br><span class="line">000000f0: 7401 0000 0073 5202 0000 0074 0500 0000  t....sR....t....</span><br><span class="line">00000100: 7261 6e67 6574 0100 0000 6974 0300 0000  ranget....it....</span><br><span class="line">00000110: 6f72 6428 0000 0000 2800 0000 0028 0000  ord(....(....(..</span><br><span class="line">00000120: 0000 7304 0000 0031 2e70 7974 0800 0000  ..s....1.pyt....</span><br><span class="line">00000130: 3c6d 6f64 756c 653e 0100 0000 7306 0000  &lt;module&gt;....s...</span><br><span class="line">00000140: 0006 0209 0213 01                        .......</span><br></pre></td></tr></table></figure>

<ul>
<li>经过对比可以发现const中多了一个PyCodeObject块,可以看出来里面存在一个参数,一个变量,2个栈空间,以及flag位,随后是10字节的opcode,后续跟着的就是该块的const常量以及一些文件相关信息,</li>
<li>在这个pco块后,又是最初最大的块的常量以及name等变量,可以看出来pyc的多函数的嵌套关系</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/python_pyc/" data-id="cjyn80f9b003axkths1fwdvo4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-PE文件头的利用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/PE文件头的利用/" class="article-date">
  <time datetime="2019-07-28T17:11:01.737Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/二进制/">二进制</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/PE文件头的利用/">ichunqiu-NoExec-200pt</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="初探NoExec"><a href="#初探NoExec" class="headerlink" title="初探NoExec"></a>初探NoExec</h1><ul>
<li>看到了题目名,感觉会有一点弯子,010查了一波..随便扫了一眼感觉没啥问题,IDA启动!</li>
<li>GG了,IDA不能识别程序,跑一下模板好了</li>
<li>模板跑完后发现好像只有程序前半段被识别出来,查一波文件结构顺便复习下</li>
<li>对照后发现,DOS头的e_lfanew被改动过了,观察NT头的位置可以复现,e_lfanew应该是10010000(小端序)</li>
<li>NT头仿佛也出现了问题,e_magic居然被改成了PEHA,改回来,Machine改成0x014c的小端形式(I386)</li>
<li>此时文件已经被电脑识别出来,原来是个MFC</li>
<li>双击运行….GG,没跑起来,IDA启动,继续分析,不过这个时候,IDA可以成功的分析出程序的所有结构了.</li>
<li>修改下代码段可执行就就好了啊,现在可以跑了</li>
<li>分析文件,发现貌似是DES,先去学一波密码学,几个月后再回来补.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/PE文件头的利用/" data-id="cjyn80f7f0008xkthszxdw351" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-PE文件头" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/PE文件头/" class="article-date">
  <time datetime="2019-07-28T17:11:01.733Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/二进制/">二进制</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/PE文件头/">PE文件格式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="PE文件格式"><a href="#PE文件格式" class="headerlink" title="PE文件格式"></a>PE文件格式</h2><p>PE文件格式其实就是PE头中的结构体.用010Editor可以很好地解析文件头.<br>具体分为DOS头,DOS存根,NT头,字区头 .text .data .rsrc,然后是NULL padding</p>
<h2 id="RVA-to-RAW"><a href="#RVA-to-RAW" class="headerlink" title="RVA to RAW"></a>RVA to RAW</h2><p>PE文件从磁盘到内存映射的内容.PE文件加载到内存时,每个节区都要完成内存地址于文件偏移之间的映射</p>
<ul>
<li>查找RVA所在节区</li>
<li>使用简单的公式计算文件偏移RAW</li>
</ul>
<h2 id="IAT-import-address-table-导入地址表"><a href="#IAT-import-address-table-导入地址表" class="headerlink" title="IAT(import address table,导入地址表)"></a>IAT(import address table,导入地址表)</h2><p>DLL:(Dynamic Link Libray,动态链接库)<br><br>为了提高内存运用效率,引入了DLL的概念.</p>
<ul>
<li>多进程共享</li>
<li>更新库时只需更新各自的DLL文件</li>
</ul>
<p>加载DLL库的方法有两种,一种是”显式链接”,即程序使用DLL时加载,使用后释放内存,一种是”隐式链接”,程序开始时加载DLL,程序全部结束时释放内存.在程序运行时,调用API函数时,会先CALL一个地址,这个地址的值即为 .text节区的内存区域,这个地址的值即为.dll的地址.<br><br>那么为什么不直接call .dll对应的地址呢,因为平台的差异,所以.dll版本不同,对应函数的位置也不相同,为了确保所有环境下都能用到.dll,所以记录了实际地址位置,并且只call 实际地址,执行文件时,PE装载器会直接将函数的地址写到实际地址的位置.<br></p>
<blockquote>
<p>imagebase:进程的虚拟内存范围0-FFFFFFFF,PE文件被加载到如此大的内存时,ImageBase指出文件优先装载地址,EXE,ALL装载到0-7FFFFFFF,SYS 80000000-FFFFFFFF,DLL文件的ImageBase值为10000000.</p>
</blockquote>
<p>由于DLL重定位的存在,一个程序使用a.dll和b.dll时,由于a.dll已经占用了10000000处,所以b.dll会被PE装载到其他空白内存空间.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/PE文件头/" data-id="cjyn80f7e0007xkthlozd2k0a" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CVE/">CVE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Crypto/">Crypto</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FE/">FE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RE/">RE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/29/深入浅出密码学读书笔记/">深入浅出密码学读书笔记</a>
          </li>
        
          <li>
            <a href="/2019/07/29/逆向工程核心原理笔记/">Reversing-engineering</a>
          </li>
        
          <li>
            <a href="/2019/07/29/看雪ctf4/">2018看雪ctf第四题-密界寻踪</a>
          </li>
        
          <li>
            <a href="/2019/07/29/汇编入门/">CTF二进制总结0X03</a>
          </li>
        
          <li>
            <a href="/2019/07/29/函数调用约定/">Calling Convention</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>