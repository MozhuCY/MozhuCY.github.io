<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>上海市ctf-re200-juckcode | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="正向解析juckcode 一个二进制文件和一份加密后的flag,显然逆算法,扔进IDA,各种分析不出函数…怎么回事呢用OD打开查看下,有好多段可疑的汇编指令大概是pushad jmp 大量无用代码 popad 花指令get,写脚本全部nop掉,用IDA打开处理好的文件,发现,居然还是不能F5,又发现了一段异常代码,两个jmp一个E8,nop掉E8居然就可以了,OD启动,提取目标的一段字节码. 12">
<meta property="og:type" content="article">
<meta property="og:title" content="上海市ctf-re200-juckcode">
<meta property="og:url" content="http://yoursite.com/2019/07/29/juckcode/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="正向解析juckcode 一个二进制文件和一份加密后的flag,显然逆算法,扔进IDA,各种分析不出函数…怎么回事呢用OD打开查看下,有好多段可疑的汇编指令大概是pushad jmp 大量无用代码 popad 花指令get,写脚本全部nop掉,用IDA打开处理好的文件,发现,居然还是不能F5,又发现了一段异常代码,两个jmp一个E8,nop掉E8居然就可以了,OD启动,提取目标的一段字节码. 12">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-07-28T15:51:13.786Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="上海市ctf-re200-juckcode">
<meta name="twitter:description" content="正向解析juckcode 一个二进制文件和一份加密后的flag,显然逆算法,扔进IDA,各种分析不出函数…怎么回事呢用OD打开查看下,有好多段可疑的汇编指令大概是pushad jmp 大量无用代码 popad 花指令get,写脚本全部nop掉,用IDA打开处理好的文件,发现,居然还是不能F5,又发现了一段异常代码,两个jmp一个E8,nop掉E8居然就可以了,OD启动,提取目标的一段字节码. 12">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-juckcode" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/juckcode/" class="article-date">
  <time datetime="2019-07-28T17:11:01.696Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RE/">RE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      上海市ctf-re200-juckcode
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="正向解析juckcode"><a href="#正向解析juckcode" class="headerlink" title="正向解析juckcode"></a>正向解析juckcode</h1><p> 一个二进制文件和一份加密后的flag,显然逆算法,扔进IDA,各种分析不出函数…怎么回事呢用OD打开查看下,有好多段可疑的汇编指令大概是pushad jmp 大量无用代码 popad<br> 花指令get,写脚本全部nop掉,用IDA打开处理好的文件,发现,居然还是不能F5,又发现了一段异常代码,两个jmp一个E8,nop掉E8居然就可以了,OD启动,提取目标的一段字节码.<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> b = <span class="string">'\x60\xE9\x31\x00\x00\x00\x8B\xEC\x6A\xFF\x68\x33\x22\x11\x00\x68\x11\x22\x33\x00\x64\xA1\x00\x00\x00\x00\x50\x64\x89\x25\x00\x00\x00\x00\x58\x64\xA3\x00\x00\x00\x00\x58\x58\x58\x58\x8B\xE8\xB8\x50\x10\x40\x00\x50\xE8\xC3\x61'</span></span><br><span class="line">a = <span class="string">'\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90'</span></span><br><span class="line">c = <span class="string">'\x0F\x8E\x07\x00\x00\x00\x0F\x85\x01\x00\x00\x00\xE8'</span></span><br><span class="line">d = <span class="string">'\x0F\x8E\x07\x00\x00\x00\x0F\x85\x01\x00\x00\x00\x90'</span></span><br><span class="line">f = open(<span class="string">'juckcode.exe'</span>, <span class="string">'rb'</span>)</span><br><span class="line">da = f.read()</span><br><span class="line"><span class="keyword">print</span> da.count(b)</span><br><span class="line"><span class="keyword">print</span> da.count(c)</span><br><span class="line">da = da.replace(b,a).replace(c,d)</span><br><span class="line"><span class="keyword">print</span> da.count(b)</span><br><span class="line"><span class="keyword">print</span> da.count(c)</span><br><span class="line">w = open(<span class="string">'bacjuck.exe'</span>, <span class="string">'wb'</span>)</span><br><span class="line">w.write(da)</span><br><span class="line">w.close()</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure></p>
<p> 处理后成功看到伪代码.程序是C++写的,而且封装贼鸡儿恶心,不过大概看到了一些可以看的懂的函数.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">char</span> *v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [esp+10h] [ebp-9DCh]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [esp+28h] [ebp-9C4h]</span></span><br><span class="line">  <span class="keyword">char</span> v19; <span class="comment">// [esp+40h] [ebp-9ACh]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [esp+58h] [ebp-994h]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [esp+5Ch] [ebp-990h]</span></span><br><span class="line">  <span class="keyword">char</span> *v22; <span class="comment">// [esp+60h] [ebp-98Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v23; <span class="comment">// [esp+64h] [ebp-988h]</span></span><br><span class="line">  BOOL v24; <span class="comment">// [esp+68h] [ebp-984h]</span></span><br><span class="line">  <span class="keyword">char</span> *v25; <span class="comment">// [esp+6Ch] [ebp-980h]</span></span><br><span class="line">  <span class="keyword">char</span> *v26; <span class="comment">// [esp+70h] [ebp-97Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> m; <span class="comment">// [esp+74h] [ebp-978h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [esp+78h] [ebp-974h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+7Ch] [ebp-970h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> n; <span class="comment">// [esp+80h] [ebp-96Ch]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v31; <span class="comment">// [esp+84h] [ebp-968h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> k; <span class="comment">// [esp+88h] [ebp-964h]</span></span><br><span class="line">  <span class="keyword">bool</span> v33; <span class="comment">// [esp+8Fh] [ebp-95Dh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> l; <span class="comment">// [esp+90h] [ebp-95Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v35; <span class="comment">// [esp+94h] [ebp-958h]</span></span><br><span class="line">  <span class="keyword">char</span> v36; <span class="comment">// [esp+14Ch] [ebp-8A0h]</span></span><br><span class="line">  <span class="keyword">char</span> v37; <span class="comment">// [esp+164h] [ebp-888h]</span></span><br><span class="line">  <span class="keyword">char</span> v38; <span class="comment">// [esp+17Ch] [ebp-870h]</span></span><br><span class="line">  <span class="keyword">char</span> v39; <span class="comment">// [esp+194h] [ebp-858h]</span></span><br><span class="line">  <span class="keyword">char</span> v40; <span class="comment">// [esp+1ACh] [ebp-840h]</span></span><br><span class="line">  <span class="keyword">char</span> input; <span class="comment">// [esp+1C4h] [ebp-828h]</span></span><br><span class="line">  <span class="keyword">char</span> v42; <span class="comment">// [esp+1DCh] [ebp-810h]</span></span><br><span class="line">  <span class="keyword">char</span> v43; <span class="comment">// [esp+1DDh] [ebp-80Fh]</span></span><br><span class="line">  <span class="keyword">char</span> Src; <span class="comment">// [esp+5DCh] [ebp-410h]</span></span><br><span class="line">  <span class="keyword">char</span> Dst; <span class="comment">// [esp+5DDh] [ebp-40Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v46; <span class="comment">// [esp+5DEh] [ebp-40Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v47[<span class="number">1021</span>]; <span class="comment">// [esp+5DFh] [ebp-40Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v48; <span class="comment">// [esp+9E8h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_4038A0(<span class="number">0xB8</span>u);</span><br><span class="line">  sub_4039F0(<span class="string">"./flag"</span>, <span class="number">1</span>, <span class="number">64</span>, <span class="number">1</span>);</span><br><span class="line">  v48 = <span class="number">0</span>;</span><br><span class="line">  sub_401E00(&amp;input);</span><br><span class="line">  LOBYTE(v48) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)sub_403970(&amp;v35) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_4050D0(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"error in open flag."</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_405410(&amp;v35, &amp;input);</span><br><span class="line">  v3 = len(&amp;input);</span><br><span class="line">  v4 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v40, v4, v3);</span><br><span class="line">  LOBYTE(v48) = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; len(&amp;input); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v26 = sub_401C80(&amp;input, i);</span><br><span class="line">    *v26 += <span class="number">64</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = len(&amp;input);</span><br><span class="line">  v6 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v36, v6, v5);</span><br><span class="line">  LOBYTE(v48) = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; len(&amp;input); ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v25 = sub_401C80(&amp;input, j);</span><br><span class="line">    *v25 &lt;&lt;= <span class="number">7</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = len(&amp;input);</span><br><span class="line">  v8 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v37, v8, v7);</span><br><span class="line">  LOBYTE(v48) = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; len(&amp;input); ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = *sub_401C80(&amp;input, k) - <span class="number">158</span>;</span><br><span class="line">    *sub_401C80(&amp;input, k) = v9;</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = len(&amp;input);</span><br><span class="line">  v11 = (<span class="keyword">char</span> *)sub_4038C0(&amp;input);</span><br><span class="line">  base64encode((<span class="keyword">int</span>)&amp;v38, v11, v10);</span><br><span class="line">  LOBYTE(v48) = <span class="number">5</span>;</span><br><span class="line">  Src = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt; len(&amp;v40); ++l )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *sub_401C80(&amp;v40, l) != <span class="number">61</span> )</span><br><span class="line">      *(&amp;Src + <span class="number">4</span> * l) = *sub_401C80(&amp;v40, l);</span><br><span class="line">    *(&amp;Dst + <span class="number">4</span> * l) = *sub_401C80(&amp;v36, l);</span><br><span class="line">    v47[<span class="number">4</span> * l] = *sub_401C80(&amp;v37, l);</span><br><span class="line">    *(&amp;v46 + <span class="number">4</span> * l) = *sub_401C80(&amp;v38, l);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401D90(&amp;Src);</span><br><span class="line">  LOBYTE(v48) = <span class="number">6</span>;</span><br><span class="line">  sub_4017D0(&amp;v39, &amp;v19);</span><br><span class="line">  LOBYTE(v48) = <span class="number">8</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v19);</span><br><span class="line">  v42 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v43, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( m = <span class="number">0</span>; ; ++m )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_401D90(&amp;Src);</span><br><span class="line">    LOBYTE(v48) = <span class="number">9</span>;</span><br><span class="line">    v12 = sub_4017D0(&amp;v17, &amp;v18);</span><br><span class="line">    v23 = v12;</span><br><span class="line">    v13 = len(v12);</span><br><span class="line">    v24 = m &lt; v13;</span><br><span class="line">    v33 = m &lt; v13;</span><br><span class="line">    <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v17);</span><br><span class="line">    LOBYTE(v48) = <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v18);</span><br><span class="line">    <span class="keyword">if</span> ( !v33 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v14 = (<span class="keyword">unsigned</span> __int8)*sub_401C80(&amp;v39, m);</span><br><span class="line">    sub_405BA0(&amp;v42, <span class="number">1024</span>, <span class="string">"%s%.2hhx"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v42);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( n = <span class="number">0</span>; ; ++n )</span><br><span class="line">  &#123;</span><br><span class="line">    v31 = &amp;v42;</span><br><span class="line">    v22 = &amp;v43;</span><br><span class="line">    v31 += <span class="built_in">strlen</span>(v31);</span><br><span class="line">    v21 = ++v31 - &amp;v43;</span><br><span class="line">    <span class="keyword">if</span> ( n &gt;= v31 - &amp;v43 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(&amp;v42 + n) += <span class="number">16</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = sub_4050D0(<span class="built_in">std</span>::<span class="built_in">cout</span>, &amp;v42);</span><br><span class="line">  <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v15, sub_405430);</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  LOBYTE(v48) = <span class="number">5</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v39);</span><br><span class="line">  LOBYTE(v48) = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v38);</span><br><span class="line">  LOBYTE(v48) = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v37);</span><br><span class="line">  LOBYTE(v48) = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v36);</span><br><span class="line">  LOBYTE(v48) = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v40);</span><br><span class="line">  LOBYTE(v48) = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;input);</span><br><span class="line">  v48 = <span class="number">-1</span>;</span><br><span class="line">  sub_403870();</span><br><span class="line">  <span class="keyword">return</span> v20;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先判断了下文件是否读取成功,随后base64.base64encode大概的传参顺序是加密后的字符串,待加密的flag的首地址,flag的长度.大概的顺序就是:</p>
<ul>
<li>input加密一次</li>
<li>input每一位加64</li>
<li>input加密一次</li>
<li>input每一位再次右移7位</li>
<li>input加密一次</li>
<li>input每一位减去158</li>
<li>input加密一次</li>
</ul>
<p>这样会得到四个字符base64后的字符长度相同的字符串.随后到达</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line"><span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt; len(&amp;v40); ++l )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *sub_401C80(&amp;v40, l) != <span class="number">61</span> )</span><br><span class="line">    *(&amp;Src + <span class="number">4</span> * l) = *sub_401C80(&amp;v40, l);</span><br><span class="line">  </span><br><span class="line">  *(&amp;Dst + <span class="number">4</span> * l) = *sub_401C80(&amp;v36, l);</span><br><span class="line">  v47[<span class="number">4</span> * l] = *sub_401C80(&amp;v37, l);</span><br><span class="line">  *(&amp;v46 + <span class="number">4</span> * l) = *sub_401C80(&amp;v38, l);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>v36 v37 v38 v40是刚才base64的字符串</li>
<li>sub_401C80函数,是取下标操作,*sub_401C80(&amp;v37, l)的意思就是v37[l]</li>
<li>查看v47,v46,Dst,Src,发现其在栈内的分布是连续的四位</li>
<li>所以可以看出来,依次从四个base后的字符串中提取出一个,组成一个新的base后的字符串</li>
</ul>
<p>随后程序进行一次base64decode,将解码后的16进制转换成字符串,然后每一位减去16,打印出来.</p>
<h1 id="开始逆向"><a href="#开始逆向" class="headerlink" title="开始逆向"></a>开始逆向</h1><p>首先还原16进制,然后将其base64encode,提取出i%4==0的对应位,然后base64encode即可.<br>下面是解密代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">s = <span class="string">"FFIF@@IqqIH@sGBBsBHFAHH@FFIuB@tvrrHHrFuBD@qqqHH@GFtuB@EIqrHHCDuBsBqurHH@EuGuB@trqrHHCDuBsBruvHH@FFIF@@AHqrHHEEFBsBGtvHH@FBHuB@trqrHHADFBD@rquHH@FurF@@IqqrHHvGuBD@tCDHH@EuGuB@tvrrHHCDuBD@tCDHH@FuruB@tvrIH@@DBBsBGtvHH@GquuB@EIqrHHvGuBsBtGEHH@EuGuB@tvrIH@BDqBsBIFEHH@GFtF@@IqqrHHEEFBD@srBHH@GBsuB@trqrHHIFFBD@rquHH@FFIuB@tvrrHHtCDB@@"</span></span><br><span class="line">s1 = <span class="string">""</span></span><br><span class="line">base = <span class="string">'ABCDEFGHIJKLMN0PQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    s1 += (chr(ord(i) - <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(s1) / <span class="number">2</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">        flag += base[int(s1[i * <span class="number">2</span>:i * <span class="number">2</span> + <span class="number">2</span>], base=<span class="number">16</span>) &gt;&gt; <span class="number">2</span>]</span><br><span class="line">flag += <span class="string">'='</span> * (<span class="number">4</span> - len(flag) % <span class="number">4</span>)</span><br><span class="line"><span class="keyword">print</span> base64.b64decode(flag)</span><br></pre></td></tr></table></figure>

<h2 id="flag-flag-juck-code-cannot-stop-you-reversing"><a href="#flag-flag-juck-code-cannot-stop-you-reversing" class="headerlink" title="flag: flag{juck_code_cannot_stop_you_reversing}"></a>flag: flag{juck_code_cannot_stop_you_reversing}</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/29/juckcode/" data-id="cjyn83qfl0034icthmpmk7q33" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/07/29/kctf2019-q1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          kctf2019-晋级赛Q1
        
      </div>
    </a>
  
  
    <a href="/2019/07/29/javascript0x1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">javascript 0x00</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CVE/">CVE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Crypto/">Crypto</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FE/">FE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RE/">RE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/29/深入浅出密码学读书笔记/">深入浅出密码学读书笔记</a>
          </li>
        
          <li>
            <a href="/2019/07/29/逆向工程核心原理笔记/">Reversing-engineering</a>
          </li>
        
          <li>
            <a href="/2019/07/29/看雪ctf4/">2018看雪ctf第四题-密界寻踪</a>
          </li>
        
          <li>
            <a href="/2019/07/29/汇编入门/">CTF二进制总结0X03</a>
          </li>
        
          <li>
            <a href="/2019/07/29/函数调用约定/">Calling Convention</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>